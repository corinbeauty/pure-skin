<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç€…ç™½ä¹‹å¢ƒ Pure Skin V6.0 - ç¶“ç‡Ÿå¤§å¸«æ——è‰¦ç‰ˆ</title>
    <!-- å¼•å…¥ç³»çµ±è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pure: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8',
                            500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'marketing-radar': 'marketingRadar 2s infinite cubic-bezier(0, 0, 0.2, 1)',
                        'breath-border': 'breathBorder 1.5s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        breathBorder: {
                            '0%, 100%': { borderColor: 'rgba(14, 165, 233, 0.2)', transform: 'scale(1)', boxShadow: '0 0 0px rgba(14, 165, 233, 0)' },
                            '50%': { borderColor: 'rgba(14, 165, 233, 0.8)', transform: 'scale(1.02)', boxShadow: '0 0 15px rgba(14, 165, 233, 0.4)' }
                        },
                        marketingRadar: { '0%': { transform: 'scale(1)', opacity: '0.8' }, '100%': { transform: 'scale(2.2)', opacity: '0' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* æ ¸å¿ƒæ‰‹æ©Ÿèˆ‡è¦–è¦ºç¾åŒ–æ¨£å¼ */
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #bae6fd; border-radius: 10px; }
        body { overscroll-behavior: none; -webkit-user-select: none; user-select: none; background: #fdfdfe; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(31, 38, 135, 0.08);
        }
        
        .chart-container { position: relative; width: 100%; height: 200px; margin: 0 auto; }

        /* NPC Elsa V6.0 */
        .elsa-container { position: relative; width: 140px; height: 300px; transform: scale(0.85); margin-bottom: -40px; }
        .elsa-hair {
            position: absolute; top: 5px; left: 15px; width: 110px; height: 130px;
            background: linear-gradient(135deg, #eecda3 0%, #c19b6e 100%);
            border-radius: 55px 55px 25px 25px; z-index: 1;
        }
        .elsa-head {
            position: absolute; top: 15px; left: 30px; width: 80px; height: 95px;
            background: #ffe4e6; border-radius: 40px 40px 45px 45px; z-index: 10;
        }
        .elsa-glasses {
            position: absolute; top: 40px; left: 0px; width: 80px; height: 30px; z-index: 15;
            display: flex; gap: 3px; justify-content: center;
        }
        .glass-frame { width: 32px; height: 32px; border: 2px solid #1e293b; border-radius: 50%; background: rgba(255,255,255,0.1); }
        .elsa-eye-dot { position: absolute; top: 52px; width: 8px; height: 8px; background: #0f172a; border-radius: 50%; z-index: 16; }
        .elsa-mouth { position: absolute; bottom: 12px; left: 32px; width: 16px; height: 4px; background: #fb7185; border-radius: 2px; z-index: 11; }
        .elsa-labcoat {
            position: absolute; top: 105px; left: 15px; width: 110px; height: 180px;
            background: #ffffff; border-radius: 15px; z-index: 5; border: 1px solid #e2e8f0;
        }
        .elsa-stethoscope {
            position: absolute; top: 110px; left: 25px; width: 90px; height: 70px;
            border: 3px solid #3b82f6; border-top: none; border-radius: 0 0 45px 45px; z-index: 12;
        }

        /* é ç´„è¡¨æ ¼ï¼šæ‰‹æ©Ÿå–®é æ©«æ»‘ä½ˆå±€ */
        .calendar-wrapper { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .calendar-table { min-width: 620px; border-collapse: separate; border-spacing: 3px; table-layout: fixed; }
        .calendar-table th { padding: 6px 2px; background: #f8fafc; border-radius: 8px; font-size: 0.5rem; font-weight: 900; color: #64748b; text-align: center; }
        .calendar-cell { 
            height: 44px; background: rgba(241, 245, 249, 0.6); border-radius: 10px;
            transition: 0.3s; cursor: pointer; border: 1.5px solid transparent; position: relative;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .calendar-cell.occupied-male { background: #eff6ff; border-color: #3b82f6; }
        .calendar-cell.occupied-female { background: #fff1f2; border-color: #f43f5e; }
        .calendar-cell.empty { border: 1px dashed #cbd5e1; }
        .calendar-cell.marketing-active { background: #f0f9ff; border: 1.5px solid #0ea5e9; }
        .calendar-cell.overdue { background: #fee2e2; border-color: #ef4444; opacity: 0.8; }
        .calendar-cell.expired { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; border: none; opacity: 0.5; }

        .pending-breath { animation: breathBorder 2s ease-in-out infinite; z-index: 5; }

        .marketing-pulse-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .radar-circle { position: absolute; width: 28px; height: 28px; background: rgba(14, 165, 233, 0.4); border-radius: 50%; pointer-events: none; }

        #laser-cursor { 
            position: fixed; width: 64px; height: 64px; border: 4px solid #cbd5e1; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; display: none; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); transition: 0.3s;
        }
        #laser-cursor.active-power { 
            border-color: #0ea5e9; box-shadow: 0 0 40px rgba(14, 165, 233, 0.7); background: rgba(14, 165, 233, 0.1);
        }

        .power-switch { width: 72px; height: 38px; background: #cbd5e1; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .power-switch.on { background: #0ea5e9; }
        .power-switch .knob { width: 30px; height: 30px; background: white; border-radius: 50%; position: absolute; top: 4px; left: 4px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .css-avatar { position: relative; width: 80px; height: 80px; border-radius: 50%; background: white; overflow: hidden; border: 4px solid #e0f2fe; }
        
        /* è¨Šæ¯æ°£æ³¡ RPG æ¨£å¼ */
        .msg-bubble-left { background: #f1f5f9; border-radius: 1.5rem 1.5rem 1.5rem 0.2rem; padding: 1rem; position: relative; max-width: 80%; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .msg-bubble-right { background: #0ea5e9; color: white; border-radius: 1.5rem 1.5rem 0.2rem 1.5rem; padding: 1rem; position: relative; max-width: 80%; margin-left: auto; box-shadow: 0 5px 15px rgba(14,165,233,0.1); }
    </style>
</head>
<body class="bg-pure-50 text-slate-700 min-h-screen font-sans selection:bg-pure-200 overflow-x-hidden">

    <div id="laser-cursor"></div>

    <!-- ç³»çµ±ç´šä¾†é›»é€šçŸ¥ (Phone Call) -->
    <div id="phone-call-overlay" class="hidden fixed inset-0 z-[15000] bg-slate-900/80 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="glass-panel w-full max-w-sm p-10 rounded-[4rem] text-center animate-shake">
            <div class="w-24 h-24 bg-pure-500 rounded-full mx-auto mb-8 flex items-center justify-center text-white text-4xl shadow-xl animate-pulse">
                <i class="fa-solid fa-phone-volume"></i>
            </div>
            <h4 id="caller-name" class="text-3xl font-black text-slate-800 mb-2 italic">ä¸æ˜ä¾†é›»</h4>
            <p id="caller-status" class="text-slate-400 font-bold text-xs uppercase tracking-widest mb-10 italic">Incoming Call...</p>
            <div class="flex gap-4">
                <button onclick="app.comm.declineCall()" class="flex-1 py-5 bg-red-50 text-red-500 rounded-3xl font-black shadow-inner">æ‹’æ¥</button>
                <button onclick="app.comm.acceptCall()" class="flex-1 py-5 bg-green-500 text-white rounded-3xl font-black shadow-xl">æ¥è½å›ç­”</button>
            </div>
        </div>
    </div>

    <!-- å°å¸« Elsa å¼•å°èˆ‡å°è©±æ°£æ³¡ -->
    <div id="tutor-anchor" class="fixed z-[10000] bottom-10 right-10 flex flex-col items-center gap-2 transition-all duration-500" style="display: none;">
        <div class="elsa-container animate-float">
            <div class="elsa-hair"></div>
            <div class="elsa-head">
                <div class="elsa-glasses"><div class="glass-frame"></div><div class="glass-frame"></div></div>
                <div class="elsa-eye-dot" style="left:16px;"></div><div class="elsa-eye-dot" style="right:16px;"></div>
                <div class="elsa-mouth"></div>
            </div>
            <div class="elsa-labcoat"></div>
            <div class="elsa-stethoscope"></div>
        </div>
        <div class="bubble-content shadow-2xl glass-panel p-6 rounded-[3rem] border-pure-200">
            <p id="tutor-text" class="text-slate-700 font-black leading-relaxed text-sm"></p>
            <button onclick="app.tutorial.next()" class="mt-4 w-full py-4 bg-pure-600 text-white rounded-[2rem] text-sm font-black shadow-lg active:scale-95 transition-transform">äº†è§£ï¼ä¸‹ä¸€æ­¥ â¯</button>
        </div>
    </div>

    <!-- é€šçŸ¥å…ƒä»¶ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[20000] transition-all duration-500 transform -translate-y-24 opacity-0 flex items-center gap-3 px-8 py-4 rounded-[2.5rem] shadow-2xl bg-white/95 backdrop-blur-md border border-pure-100">
        <i id="toast-icon" class="fa-solid fa-circle-check text-green-500"></i>
        <span id="toast-text" class="font-black text-slate-700 text-sm">ç³»çµ±å·²å°±ç·’</span>
    </div>

    <!-- æ‰‹æ©Ÿæ‡¸æµ®æ™‚é˜åˆ— -->
    <div id="fixed-clock" class="fixed bottom-6 left-6 z-[150] glass-panel px-5 py-3 rounded-[2rem] flex items-center gap-5 shadow-2xl border-pure-100 animate-fade-in pointer-events-none">
        <div class="flex flex-col items-start leading-none">
            <span id="game-date" class="font-black text-slate-400 text-[10px] uppercase tracking-tighter mb-1 italic">Day X</span>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-clock text-pure-500 text-xs"></i>
                <span id="game-clock" class="font-black text-slate-800 text-xl font-mono italic">10:00 AM</span>
            </div>
        </div>
    </div>

    <main id="app-root" class="w-full min-h-screen flex flex-col items-center relative overflow-hidden px-4 py-8">
        
        <!-- èƒŒæ™¯å‹•æ…‹é£¾å“ -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div class="absolute top-[-5%] left-[-10%] w-[100vw] h-[100vw] bg-pure-200/25 rounded-full filter blur-[140px] animate-pulse-slow"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[90vw] h-[90vw] bg-pink-100/25 rounded-full filter blur-[140px] animate-pulse-slow"></div>
        </div>

        <!-- è¼‰å…¥è¦–åœ– -->
        <section id="view-loading" class="flex flex-col items-center justify-center gap-8 text-center h-screen transition-all duration-500">
            <div class="relative">
                <div class="w-28 h-28 border-4 border-pure-100 border-t-pure-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">ğŸ§Š</div>
            </div>
            <div>
                <h1 class="text-5xl font-black tracking-tighter text-slate-800 mb-3 italic">ç€…ç™½ä¹‹å¢ƒ</h1>
                <p id="loading-status" class="text-sm font-bold text-pure-500 tracking-[0.6em] animate-pulse uppercase">ç™»å…¥ä¸­...</p>
            </div>
        </section>

        <!-- èªè­‰ä¸­å¿ƒ -->
        <section id="view-login" class="hidden w-full max-w-md my-auto animate-float">
            <div class="glass-panel p-10 rounded-[4rem] text-center shadow-2xl border-white border-4">
                <div class="w-24 h-24 bg-white rounded-[2.5rem] mx-auto flex items-center justify-center mb-8 text-5xl text-pure-600 shadow-inner">ğŸ§Š</div>
                <h2 class="text-4xl font-black mb-2 text-slate-800 tracking-tight italic">ç¾å­¸æ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-400 text-xs font-bold tracking-[0.2em] uppercase mb-12 italic">Identity Verification</p>
                <div class="space-y-5">
                    <button onclick="app.auth.loginGoogle()" class="w-full py-6 bg-white border border-slate-100 rounded-[2.5rem] flex items-center justify-center gap-4 shadow-sm hover:bg-blue-50 transition-all font-black text-slate-600 text-lg">
                        <i class="fa-brands fa-google text-2xl text-pure-600"></i> Google å¿«é€Ÿèªè­‰
                    </button>
                    <button onclick="app.auth.loginGameCenter()" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] flex items-center justify-center gap-4 shadow-xl active:scale-95 transition-transform font-black text-lg text-center">
                        <i class="fa-brands fa-apple text-3xl"></i> Game Center ç™»å…¥
                    </button>
                </div>
                <p class="mt-14 text-xs text-slate-400 font-bold tracking-widest italic animate-pulse">è«‹ç™»å…¥ä¸¦é–‹å§‹éŠæˆ²</p>
            </div>
        </section>

        <!-- å‘½åè¦–åœ– -->
        <section id="view-naming" class="hidden w-full max-w-md my-auto px-4">
            <div class="glass-panel p-12 rounded-[4.5rem] text-center shadow-2xl animate-slide-up border-white border-2">
                <h2 class="text-3xl font-black text-slate-800 mb-10 italic tracking-tighter">è¨­å®šå°ˆå®¶åç¨±</h2>
                <input id="input-player-name" type="text" maxlength="8" class="w-full p-6 rounded-[2.5rem] bg-pure-50 border-4 border-pure-100 focus:border-pure-400 outline-none text-center font-black text-3xl mb-12 shadow-inner">
                <button onclick="app.auth.confirmName()" class="w-full py-7 bg-pure-600 text-white font-black rounded-[3rem] shadow-xl hover:scale-105 active:scale-95 transition-all text-2xl italic uppercase tracking-tighter">é–‹å•Ÿå°ˆæ¥­è·æ¶¯ â¯</button>
            </div>
        </section>

        <!-- å¤§å»³è¦–åœ– (RPG ç¶“ç‡Ÿæ¨¡å¼) -->
        <section id="view-lobby" class="hidden w-full max-w-6xl flex flex-col gap-6 w-full">
            <header id="frame-profile" class="glass-panel p-6 rounded-[3.5rem] flex flex-col gap-6 shadow-2xl border-blue-50">
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 bg-gradient-to-tr from-pure-500 to-cyan-400 rounded-3xl flex items-center justify-center text-white shadow-xl text-3xl font-black italic">M</div>
                    <div class="flex-1">
                        <h3 class="text-3xl font-black text-slate-800 italic" id="user-display-name">é¡§å•</h3>
                        <p class="text-[10px] font-black text-pure-500 uppercase tracking-widest" id="user-title">-</p>
                    </div>
                    <!-- è¨Šæ¯ä¸­å¿ƒå…¥å£ -->
                    <button onclick="app.router.go('comm')" class="relative w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-2xl text-slate-400 shadow-sm border border-pure-100 hover:text-pure-600 transition-colors">
                        <i class="fa-solid fa-message"></i>
                        <div id="msg-badge" class="hidden absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-[10px] font-black flex items-center justify-center rounded-full border-2 border-white">1</div>
                    </button>
                </div>
                <div class="flex gap-4 items-center pt-6 border-t border-slate-100">
                    <div class="flex-1 bg-pure-50/50 p-4 rounded-3xl text-center">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-1 tracking-widest text-center">è³‡ç”¢</p>
                        <p class="text-3xl font-black text-slate-800 font-mono italic text-center">ğŸ’° <span id="lobby-gold">0</span></p>
                    </div>
                    <div class="flex-1 bg-pure-50/50 p-4 rounded-3xl text-center">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-1 tracking-widest text-center">ç­‰ç´š</p>
                        <p class="text-3xl font-black text-pure-600 font-mono italic text-center" id="lobby-level">1</p>
                    </div>
                </div>
            </header>

            <div id="frame-chart" class="glass-panel p-8 rounded-[4rem] flex flex-col gap-6 shadow-inner border border-pure-50">
                <div class="flex justify-between items-center px-2">
                    <h4 class="text-xl font-black text-slate-800 tracking-tighter italic font-mono text-center"><i class="fa-solid fa-chart-line mr-3 text-pure-500"></i>ç‡Ÿæ”¶åˆ†æ</h4>
                    <button onclick="app.router.go('reports')" class="px-5 py-2 bg-pure-100 text-pure-600 rounded-full font-black text-[10px] hover:bg-pure-200 transition-all uppercase tracking-widest font-mono">Reports</button>
                </div>
                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
            </div>

            <button id="frame-appt" onclick="app.router.go('appointments')" class="group relative bg-gradient-to-br from-pure-600 to-blue-800 text-white p-10 rounded-[4.5rem] shadow-2xl active:scale-95 transition-all text-left overflow-hidden h-44">
                <div class="absolute right-[-10px] bottom-[-20px] text-[11rem] text-white opacity-10"><i class="fa-solid fa-calendar-check"></i></div>
                <h2 class="text-4xl font-black italic mb-2 tracking-tighter uppercase text-center">é ç´„æ™‚åˆ»è¡¨</h2>
                <p class="text-sm font-medium opacity-85 leading-relaxed italic pr-12 text-center text-wrap">ä¸€é€±è·¨æ—¥æ’ç¨‹çŸ©é™£èˆ‡å¼•æµæŠ•æ”¾é–‹ç™¼ã€‚</p>
            </button>
        </section>

        <!-- é ç´„æ™‚åˆ»è¡¨ (è¦–è¦ºå£“ç¸®ç‰ˆ) -->
        <section id="view-appointments" class="hidden w-full max-w-6xl flex flex-col h-[82vh] animate-slide-up">
            <div class="glass-panel p-8 rounded-t-[4.5rem] flex justify-between items-center z-10 border-b-0 shadow-none">
                <div><h2 class="text-3xl font-black text-slate-800 italic tracking-tighter font-mono uppercase">é ç´„æ™‚åˆ»è¡¨</h2><p class="text-[10px] text-pure-400 font-bold mt-1 uppercase italic tracking-widest font-mono">10:00 - 21:00 Scheduler</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-[1.5rem] bg-pure-50 flex items-center justify-center text-pure-600 hover:bg-pure-100 shadow-inner active:scale-90 transition-all"><i class="fa-solid fa-home text-xl"></i></button>
            </div>
            <div class="glass-panel p-4 rounded-b-[4.5rem] flex-1 shadow-2xl border-t-0 bg-white/95">
                <div class="calendar-wrapper custom-scrollbar h-full">
                    <div id="calendar-container"></div>
                </div>
            </div>
        </section>

        <!-- é€šè¨Šé ç´„ä¸­å¿ƒ (Comm Center RPG) -->
        <section id="view-comm" class="hidden w-full max-w-4xl flex flex-col h-[80vh] animate-slide-up">
            <div class="glass-panel p-8 rounded-t-[4rem] flex justify-between items-center z-10 border-b-0">
                <div><h2 class="text-3xl font-black text-slate-800 italic tracking-tighter">é€šè¨Šé ç´„ä¸­å¿ƒ</h2><p class="text-[9px] text-pure-400 font-black uppercase tracking-widest mt-1 italic">Customer Communication HUB</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-2xl bg-pure-50 flex items-center justify-center text-pure-600 hover:bg-pure-100 transition-all shadow-inner"><i class="fa-solid fa-home text-xl"></i></button>
            </div>
            <div class="glass-panel p-6 rounded-b-[4rem] flex-1 bg-white/80 overflow-y-auto custom-scrollbar flex flex-col gap-6" id="comm-list">
                <!-- è¨Šæ¯æµåˆ—è¡¨ -->
            </div>
        </section>

        <!-- RPG å°è©±ä»‹é¢ (V6.0 å…¨æ–°è¨­è¨ˆï¼šå¸¶é ­åƒ) -->
        <section id="view-dialogue" class="hidden fixed inset-0 z-[16000] bg-slate-900/10 backdrop-blur-md flex flex-col items-center justify-end p-8">
            <div class="glass-panel w-full max-w-2xl p-10 rounded-[4rem] shadow-2xl flex flex-col gap-8 border-white border-2">
                <div class="flex items-start gap-6">
                    <div id="diag-avatar-container" class="flex-shrink-0 animate-float">
                        <!-- CSS Avatar here -->
                    </div>
                    <div class="flex-1">
                        <h4 id="diag-name" class="font-black text-pure-600 text-lg mb-2 italic tracking-widest underline decoration-blue-200">åå­—è¼‰å…¥ä¸­</h4>
                        <div class="msg-bubble-left">
                            <p id="diag-text" class="text-slate-700 font-bold leading-relaxed text-xl italic min-h-[3em]">...</p>
                        </div>
                    </div>
                </div>
                <div id="diag-options" class="flex flex-col gap-3">
                    <!-- é¸é … -->
                </div>
            </div>
        </section>

        <!-- çµç®—è©•åƒ¹ã€äº’å‹•é™¤æ¯›ç­‰è¦–åœ– (ç¶­æŒ V5.18 æ——è‰¦è¦æ ¼) -->
        <section id="view-game" class="hidden w-full max-w-4xl flex-col items-center gap-10 my-auto">
            <div class="w-full max-w-md glass-panel p-8 rounded-[3.5rem] flex items-center justify-between shadow-2xl border-white border-4">
                <div class="flex items-center gap-6"><div id="laser-power-switch" onclick="window.toggleLaser()" class="power-switch"><div class="knob"></div></div><div class="leading-none text-left"><p class="font-black text-slate-800 text-lg italic uppercase tracking-widest">é›·å°„é›»æº</p><p id="power-status-text" class="text-[10px] font-bold text-slate-400 uppercase mt-1">å¾…æ©Ÿæ¨¡å¼ STANDBY</p></div></div>
                <div class="text-right leading-none"><span id="prog-text" class="text-3xl font-black text-pure-600 font-mono italic">0.0%</span><p class="text-[10px] font-bold text-slate-400 uppercase mt-1">æ·¨ç™½é€²åº¦</p></div>
            </div>
            <div class="relative rounded-[5.5rem] overflow-hidden shadow-2xl border-[16px] border-white ring-4 ring-blue-50/50"><canvas id="game-canvas" class="bg-pure-50"></canvas></div>
            <div class="w-full max-w-md flex flex-col gap-6">
                <div class="w-full h-4 bg-slate-100 rounded-full overflow-hidden shadow-inner border-2 border-white"><div id="prog-bar" class="h-full bg-gradient-to-r from-pure-400 to-cyan-500 w-0 transition-all duration-300"></div></div>
                <button onclick="window.requestManualFinish()" class="w-full py-8 bg-gradient-to-br from-pure-600 to-blue-800 text-white font-black text-2xl rounded-[3rem] shadow-2xl active:scale-95 transition-all italic uppercase tracking-widest">å®Œæˆç™‚ç¨‹çµç®— FINISH â¯</button>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, OAuthProvider, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ç’°å¢ƒ ---
        const firebaseConfig = { apiKey: "AIzaSyCIKSbaZ5R6RTSRcH_-YYfqz_OnQQFr1gc", authDomain: "pure-skin-8640d.firebaseapp.com", projectId: "pure-skin-8640d", storageBucket: "pure-skin-8640d.firebasestorage.app", messagingSenderId: "890613609117", appId: "1:890613609117:web:ed044e453e6cc789b01a74", measurementId: "G-27E3XSTTBH" };
        const appId = 'pure-skin-studio-master';
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- å¸¸é‡èˆ‡åå–® ---
        const CAREERS = ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«", "é¦–å¸­æŠ€è¡“å®˜", "é†«ç¾é¡§å•", "é›·å°„ç‰©ç†å°ˆå®¶", "çš®è†šè‡¨åºŠé†«ç”Ÿ", "æŠ—è€ç ”ç©¶å“¡", "ç”Ÿç‰©çº–ç¶­å°ˆå®¶", "é†«å­¸ç¾å®¹é™¢é•·", "å©šç¦®é€ å‹å¸«", "æ™‚å°šé›œèªŒé¡§å•", "å¥½èŠå¡¢ç‰¹æ•ˆè­·ç†", "æ˜æ˜Ÿå¾¡ç”¨å¤§å¸«", "äººé«”ç¾å­¸å®¶", "æ²™é¾åº—é•·", "å“ç‰Œç¶“ç†", "é€£é–åº—å‰µå§‹äºº", "ç¾å®¹é›†åœ˜ CEO", "å…¨çƒç¾å­¸æ•™çˆ¶"];
        const TW_SURNAMES = ["é™³", "æ", "ç‹", "å¼µ", "åŠ‰", "é»ƒ", "æ—", "å³", "éƒ­", "å¾"];
        const TW_NAMES = ["ç¾ç²", "å­è±ª", "é›…é›¯", "æ‰¿ç¿°", "é›¨æŸ”", "ä¿Šå»·", "è©©å©·", "å¨å»‰", "æ¬£å„€", "å»ºå®", "å˜‰æ¬£", "å®—ä½‘", "å¿—æ˜", "é›…å©·", "æ˜¥å¬Œ", "å‡±ç‰¹", "å­è»’", "ä½©çŠ", "å®œåº­"];
        const FULL_NAMES = Array.from({length: 300}, (_, i) => TW_SURNAMES[i % 10] + TW_NAMES[Math.floor(Math.random()*18)]);
        const BODY_PARTS = { face: 'è‡‰éƒ¨ç²¾é›•', underarm: 'è…‹ä¸‹æ·¨ç™½', bikini: 'VIOç§å¯†', limbs: 'å››è‚¢çµ²æ»‘', back: 'èƒŒéƒ¨ç¾å­¸' };

        // --- V6.0 éš¨æ©Ÿå°è©±æ±  ---
        const COMM_CONTEXTS = [
            { type: 'IM', trigger: "æ‚¨å¥½ï¼Œæˆ‘çœ‹åˆ°ç¶²è·¯è©•åƒ¹ï¼Œæƒ³è«‹å•æ˜å¤© 14:00 æœ‰ä½ç½®å—ï¼Ÿ", opts: [{t: "æœ‰çš„ï¼Œå¹«æ‚¨æ’å…¥ï¼", r: "å¤ªå¥½äº†ï¼Œæ˜å¤©è¦‹ã€‚"}, {t: "ä¸å¥½æ„æ€é‚£å¤©æ»¿äº†å–”ã€‚", r: "å¥½å§ï¼Œé‚£æˆ‘å†çœ‹çœ‹ã€‚"}] },
            { type: 'IM', trigger: "ç€…ç™½ä¹‹å¢ƒä½ å¥½ï¼Œæˆ‘ä¸‹é€±è¦æ‹å©šç´—ï¼Œè…‹ä¸‹éœ€è¦æ€¥æ•‘ï¼", opts: [{t: "æ²’å•é¡Œï¼Œä¿è­‰è®“æ‚¨ç„¡ç‘•ã€‚åŸºç¤ç™‚ç¨‹ 200ã€‚", r: "éŒ¢ä¸æ˜¯å•é¡Œï¼Œè«‹æ’åœ¨æœ€å¿«æ™‚æ®µï¼"}, {t: "ç›®å‰æ’å–®è¼ƒæ»¿ï¼Œè¦ç­‰å–”ã€‚", r: "é‚£æˆ‘æœ‰ç©ºå†å•ã€‚"}] },
            { type: 'CALL', trigger: "å–‚ï¼Ÿæ•™çˆ¶å—ï¼Ÿæˆ‘æ˜¯é‹å‹•å“¡å°æ˜ï¼Œæˆ‘æƒ³è™•ç†å°è…¿æ¯›é«®æ¸›å°‘é˜»åŠ›ï¼", opts: [{t: "å°ˆæ¥­é‹å‹•å“¡æœ€æ¨é€™é …ã€‚11:00 æ–¹ä¾¿å—ï¼Ÿ", r: "OKï¼é‚£æˆ‘å°±éå»å›‰ã€‚"}, {t: "å–”å¥½ï¼Œä½ è‡ªå·±çœ‹æ™‚åˆ»è¡¨ç©ºä½ã€‚", r: "é¡...é‚£æˆ‘è€ƒæ…®ä¸€ä¸‹ã€‚"}] }
        ];

        const App = {
            state: {
                user: null, data: { gold: 3000, level: 1, exp: 0, history: [], dailyLog: {}, isNewPlayer: true, appointments: {}, marketingSlots: {}, playerName: "", gameHour: 10, gameMinute: 0, gameDay: 1, nameStats: {}, commEvents: [] },
                view: 'loading', session: null, isAuthResolved: false, tutorialStep: 0, audio: { el: null, muted: true },
                isLaserOn: false, startTime: 0, currentCompletion: 0, currentComm: null
            },

            // --- V6.0 é€šè¨Šä¸­å¿ƒæ¨¡çµ„ ---
            comm: {
                triggerRandom: async () => {
                    const d = App.state.data;
                    if (Math.random() < 0.1) { // 10% æ©Ÿç‡è§¸ç™¼è¨Šæ¯
                        const ctx = COMM_CONTEXTS[Math.floor(Math.random()*COMM_CONTEXTS.length)];
                        const guest = App.crm.generateUniqueCustomer();
                        const event = { ...ctx, guest, id: Date.now(), status: 'unread' };
                        
                        if (ctx.type === 'CALL') {
                            App.comm.incomingCall(event);
                        } else {
                            d.commEvents.push(event);
                            document.getElementById('msg-badge').classList.remove('hidden');
                            document.getElementById('msg-badge').innerText = d.commEvents.filter(e => e.status === 'unread').length;
                            App.ui.notify("æ”¶åˆ°ä¸€å‰‡æ–°é ç´„è¨Šæ¯ï¼");
                        }
                        await App.data.save();
                    }
                },
                incomingCall: (event) => {
                    App.state.currentComm = event;
                    document.getElementById('caller-name').innerText = `${event.guest.name} (${event.guest.visitCount}æ¬¡)`;
                    document.getElementById('phone-call-overlay').classList.remove('hidden');
                },
                acceptCall: () => {
                    document.getElementById('phone-call-overlay').classList.add('hidden');
                    App.comm.openChat(App.state.currentComm);
                },
                declineCall: () => {
                    document.getElementById('phone-call-overlay').classList.add('hidden');
                    App.ui.notify("å·²æ›æ–·ä¾†é›»ã€‚");
                },
                openChat: (event) => {
                    App.state.currentComm = event;
                    App.router.go('dialogue');
                    window.renderRPGChat(event);
                }
            },

            crm: {
                generateUniqueCustomer: () => {
                    const d = App.state.data;
                    const gameDay = d.gameDay;
                    const availableNames = FULL_NAMES.filter(name => {
                        const stats = d.nameStats[name];
                        if (!stats) return true;
                        return (gameDay - stats.lastDay) > 18;
                    });
                    const selectedName = availableNames.length > 0 ? availableNames[Math.floor(Math.random() * availableNames.length)] : FULL_NAMES[0];
                    if (!d.nameStats[selectedName]) d.nameStats[selectedName] = { count: 0, lastDay: 0 };
                    d.nameStats[selectedName].count++;
                    d.nameStats[selectedName].lastDay = gameDay;
                    return { name: selectedName, visitCount: d.nameStats[selectedName].count };
                }
            },

            timer: {
                lastTick: performance.now(),
                start: () => requestAnimationFrame(App.timer.loop),
                loop: (now) => {
                    const elapsed = now - App.timer.lastTick;
                    if (elapsed > 1000) { App.timer.lastTick = now; App.timer.tick(); }
                    requestAnimationFrame(App.timer.loop);
                },
                tick: async () => {
                    let d = App.state.data;
                    const isVisible = !document.hidden;
                    const gameSecondsToAdd = isVisible ? 5 : (5 * 60) / 3600;
                    d.gameMinute += gameSecondsToAdd / 60;
                    if (d.gameMinute >= 60) {
                        d.gameMinute = 0; d.gameHour++;
                        if (d.gameHour >= 22) { App.timer.performDailySettlement(); return; }
                        App.comm.triggerRandom(); // æ¯å°æ™‚åˆ¤å®šé€šè¨Š
                    }
                    App.ui.updateClock();
                    if (App.state.view === 'appointments') App.ui.renderTimetable();
                },
                performDailySettlement: async () => {
                    const day = App.state.data.gameDay;
                    let dailyIncome = 0; let dailyGuests = 0;
                    Object.keys(App.state.data.appointments).forEach(sid => {
                        if (sid.startsWith(`${day}-`)) {
                            const appt = App.state.data.appointments[sid];
                            if (appt.status === 'finished') { dailyIncome += (appt.actualReward || 800); dailyGuests++; }
                        }
                    });
                    const dateStr = new Date().toISOString().split('T')[0]; 
                    App.state.data.dailyLog[dateStr] = { income: dailyIncome, guests: dailyGuests };
                    document.getElementById('closing-day-label').innerText = `Day ${day} ç¶“ç‡Ÿçµç®—`;
                    document.getElementById('closing-income').innerText = dailyIncome.toLocaleString();
                    document.getElementById('closing-guests').innerText = dailyGuests;
                    document.getElementById('modal-closing').classList.remove('hidden');
                    await App.data.save();
                },
                startNextDay: async () => {
                    App.state.data.gameHour = 10; App.state.data.gameMinute = 0; App.state.data.gameDay++;
                    document.getElementById('modal-closing').classList.add('hidden');
                    await App.data.save(); App.router.go('lobby');
                }
            },

            auth: {
                init: async () => {
                    onAuthStateChanged(auth, async (user) => {
                        App.state.isAuthResolved = true;
                        if (user && !user.isAnonymous) {
                            App.state.user = user; await App.data.sync(); 
                            if (!App.state.data.playerName) App.router.go('naming');
                            else if (App.state.data.isNewPlayer && !localStorage.getItem(`tut_done_${user.uid}`)) App.router.go('welcome');
                            else App.router.go('lobby');
                            App.timer.start();
                        } else {
                            if(user && user.isAnonymous) await signOut(auth);
                            App.router.go('login');
                        }
                    });
                },
                loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()).catch(()=>App.ui.notify("é©—è­‰ç•°å¸¸", true)),
                confirmName: () => { const n = document.getElementById('input-player-name').value.trim(); if(!n) return; document.getElementById('display-confirm-name').innerText = n; document.getElementById('modal-name-confirm').classList.remove('hidden'); },
                submitName: async () => { const n = document.getElementById('input-player-name').value.trim(); App.state.data.playerName = n; App.state.data.isNewPlayer = true; document.getElementById('modal-name-confirm').classList.add('hidden'); await App.data.save(); App.router.go('welcome'); },
                logout: async () => { localStorage.clear(); await signOut(auth); window.location.reload(); }
            },

            data: {
                sync: async () => {
                    if (!App.state.user) return;
                    const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile');
                    const snap = await getDoc(userRef);
                    if (snap.exists()) App.state.data = { ...App.state.data, ...snap.data() };
                    else { App.state.data.gold = 3000; App.state.data.level = 1; await setDoc(userRef, App.state.data); }
                    onSnapshot(userRef, (s) => { if(s.exists()) { App.state.data = { ...App.state.data, ...s.data() }; App.ui.updateLobby(); } });
                },
                save: async () => { if (App.state.user) { const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile'); await setDoc(userRef, App.state.data, { merge: true }); } }
            },

            ui: {
                notify: (m, e) => { const el = document.getElementById('toast'); document.getElementById('toast-text').innerText = m; document.getElementById('toast-icon').className = e ? "fa-solid fa-circle-exclamation text-red-500" : "fa-solid fa-circle-check text-green-500"; el.classList.remove('-translate-y-24', 'opacity-0'); setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000); },
                updateClock: () => { const d = App.state.data; const h = Math.floor(d.gameHour); const m = Math.floor(d.gameMinute); document.getElementById('game-clock').innerText = `${h}:${m < 10 ? '0'+m : m} ${h >= 12 ? 'PM' : 'AM'}`; document.getElementById('game-date').innerText = `ç¬¬ ${d.gameDay} å¤©ç‡Ÿé‹`; },
                updateLobby: () => {
                    document.getElementById('lobby-gold').innerText = App.state.data.gold.toLocaleString();
                    document.getElementById('lobby-level').innerText = App.state.data.level;
                    document.getElementById('user-display-name').innerText = App.state.data.playerName || "èªè­‰æ•™çˆ¶";
                    document.getElementById('user-title').innerText = CAREERS[Math.min(Math.floor(App.state.data.level / 2), 19)];
                    if (window.revenueChartInstance) App.ui.renderChart();
                },
                renderChart: () => {
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    const history = App.state.data.history.length > 0 ? App.state.data.history : [{a: 0, d:'Syncing'}];
                    if (window.revenueChartInstance) window.revenueChartInstance.destroy();
                    window.revenueChartInstance = new Chart(ctx, { type: 'line', data: { labels: history.map(h => h.d), datasets: [{ data: history.map(h => h.a), borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.05)', borderWidth: 5, tension: 0.4, fill: true, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
                },
                renderTimetable: () => {
                    const container = document.getElementById('calendar-container'); if (!container) return;
                    const hours = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]; const curDay = App.state.data.gameDay;
                    const totalGameTime = App.state.data.gameHour + (App.state.data.gameMinute / 60);
                    let html = `<table class="calendar-table"><thead><tr><th class="w-16 italic">æ™‚æ®µ</th>`;
                    for(let i=0; i<7; i++) html += `<th>${curDay+i}æ—¥</th>`;
                    html += `</tr></thead><tbody>`;
                    hours.forEach(h => {
                        html += `<tr><td class="text-center font-mono font-black text-slate-400 text-[9px]">${h}:00</td>`;
                        for(let i=0; i<7; i++) {
                            const sid = `${curDay+i}-${h}`; const appt = App.state.data.appointments[sid];
                            const isPast = (curDay+i < curDay) || (curDay+i === curDay && h < Math.floor(totalGameTime));
                            const isToday = (curDay+i === curDay);
                            let cellStyle = "", breathClass = "", content = "", finalClass = "calendar-cell ";
                            if (appt) {
                                const isFin = appt.status === 'finished';
                                finalClass += appt.gender === 'male' ? 'occupied-male ' : 'occupied-female ';
                                if (isPast && !isFin) finalClass += "overdue ";
                                if (isToday && !isFin && !isPast && (h - totalGameTime) < 1) {
                                    const intensity = (1 - (h - totalGameTime)).toFixed(2);
                                    cellStyle = `background-color: rgba(239, 68, 68, ${intensity}); border-color: rgba(239, 68, 68, ${0.4 + intensity*0.6}); color: ${intensity > 0.6 ? 'white' : 'inherit'}`;
                                }
                                if (appt.status === 'pending') breathClass = "pending-breath";
                                content = `<div class="flex flex-col h-full text-[8px] font-black justify-center items-center"><span class="truncate w-full px-0.5">${appt.name}</span><span class="text-[7px] opacity-70">${isFin ? 'å®Œæˆ' : (isPast ? 'é€¾æ™‚' : `ç¬¬${appt.visitCount}æ¬¡`)}</span></div>`;
                            } else if (isPast) {
                                finalClass += "expired "; content = `<span class="text-[10px] font-black opacity-30">X</span>`;
                            } else {
                                finalClass += "empty "; content = `<span class="text-[11px] text-slate-300 font-black"><i class="fa-solid fa-plus opacity-30"></i></span>`;
                            }
                            html += `<td class="${finalClass} ${breathClass}" style="${cellStyle}" onclick="window.apptAction('${sid}')">${content}</td>`;
                        }
                        html += `</tr>`;
                    });
                    html += `</tbody></table>`; container.innerHTML = html;
                }
            },

            router: {
                go: (viewId) => {
                    document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                    App.state.view = viewId;
                    if (viewId === 'appointments') App.ui.renderTimetable();
                    if (viewId === 'lobby') App.ui.updateLobby();
                    if (viewId === 'comm') renderCommCenter();
                    if (viewId === 'game') window.initCanvas();
                    document.getElementById('fixed-clock').style.display = (viewId === 'game') ? 'none' : 'flex';
                }
            }
        };

        // --- å…¨åŸŸ RPG åŠŸèƒ½ ---
        function renderCommCenter() {
            const list = document.getElementById('comm-list');
            const events = App.state.data.commEvents;
            if (events.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-300 italic"><i class="fa-solid fa-ghost text-4xl mb-4"></i>ç›®å‰æ²’æœ‰æœªè™•ç†é ç´„è¨Šæ¯</div>`;
                return;
            }
            list.innerHTML = events.map(e => `
                <div class="flex items-center gap-6 p-6 bg-white rounded-3xl border border-pure-100 shadow-sm hover:scale-[1.02] transition-all cursor-pointer" onclick="app.comm.openChat(${JSON.stringify(e).replace(/"/g, '&quot;')})">
                    <div class="css-avatar w-14 h-14 bg-blue-50 border-none relative overflow-hidden flex items-center justify-center text-xl">ğŸ‘¤</div>
                    <div class="flex-1">
                        <h5 class="font-black text-slate-800">${e.guest.name} <span class="text-[9px] text-pure-500 font-mono italic">CRM #${e.guest.visitCount}</span></h5>
                        <p class="text-xs text-slate-400 line-clamp-1">${e.trigger}</p>
                    </div>
                    <div class="w-3 h-3 bg-red-500 rounded-full ${e.status==='unread'?'':'hidden'}"></div>
                </div>
            `).join('');
        }

        window.renderRPGChat = (event) => {
            const box = document.getElementById('diag-avatar-container');
            const color = event.guest.visitCount > 1 ? '#bae6fd' : '#fecdd3';
            box.innerHTML = `<div class="css-avatar" style="border-color:${color};"><div style="position:absolute; top:20%; left:25%; width:50%; height:50%; background:#ffe4e6; border-radius:50%; z-index:10;"></div><div style="position:absolute; bottom:0; left:15%; width:70%; height:45%; background:${color}; border-radius:45% 45% 0 0; z-index:5;"></div></div>`;
            document.getElementById('diag-name').innerText = `${event.guest.name} (ä¾†è¨ª ${event.guest.visitCount} æ¬¡)`;
            document.getElementById('diag-text').innerText = event.trigger;
            
            const optDiv = document.getElementById('diag-options');
            optDiv.innerHTML = event.opts.map((o, idx) => `
                <button onclick="window.confirmCommOption(${idx})" class="w-full p-5 bg-white border-2 border-pure-50 rounded-3xl text-left font-black text-blue-600 hover:bg-pure-600 hover:text-white transition-all shadow-sm">â— ${o.t}</button>
            `).join('');
        };

        window.confirmCommOption = async (idx) => {
            const event = App.state.currentComm;
            const opt = event.opts[idx];
            document.getElementById('diag-text').innerText = opt.r;
            
            if (opt.t.includes("æ’å…¥")) {
                const hours = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21];
                const curDay = App.state.data.gameDay;
                let slotFound = false;
                for(let h of hours) {
                    const sid = `${curDay}-${h}`;
                    if (!App.state.data.appointments[sid] && h > App.state.data.gameHour) {
                        App.state.data.appointments[sid] = { ...event.guest, status: 'pending', gender: 'female', part: 'face' };
                        slotFound = true; break;
                    }
                }
                App.ui.notify(slotFound ? "å·²æˆåŠŸæ’å…¥é ç´„è¡¨" : "ä»Šæ—¥æ™‚æ®µå·²æ»¿ï¼Œé ç´„å¤±æ•—", !slotFound);
            }
            
            // æ¸…ç†äº‹ä»¶
            App.state.data.commEvents = App.state.data.commEvents.filter(e => e.id !== event.id);
            document.getElementById('msg-badge').innerText = App.state.data.commEvents.length;
            if(App.state.data.commEvents.length === 0) document.getElementById('msg-badge').classList.add('hidden');

            document.getElementById('diag-options').innerHTML = `<button onclick="app.router.go('lobby')" class="w-full py-5 bg-pure-800 text-white rounded-3xl font-black italic">çµæŸå°è©±ä¸¦è¿”å›å¤§å»³ â¯</button>`;
            await App.data.save();
        };

        // --- äº’å‹• Canvas å¼•æ“ (ç¶­æŒæ——è‰¦ç‰ˆè¦æ ¼) ---
        let canvas, ctx;
        window.initCanvas = () => {
            canvas = document.getElementById('game-canvas'); ctx = canvas.getContext('2d');
            const container = canvas.parentElement; canvas.width = container.clientWidth; canvas.height = 360;
            const total = canvas.width * canvas.height; const laser = document.getElementById('laser-cursor');
            App.state.isLaserOn = false; App.state.startTime = Date.now();
            document.getElementById('prog-bar').style.width = '0%'; document.getElementById('prog-text').innerText = '0.0%';
            ctx.fillStyle = '#fff0f0'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = "#4a3528"; ctx.lineWidth = 1;
            for (let i = 0; i < 2400; i++) { const x = Math.random()*canvas.width; const y = Math.random()*canvas.height; ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + (Math.random()-0.5)*4, y + 8); ctx.stroke(); }
            let isD = false;
            const handleMove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const cx = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
                const cy = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
                laser.style.left = cx + 'px'; laser.style.top = cy + 'px'; laser.style.display = 'block';
                if (isD && App.state.isLaserOn) {
                    ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(cx - rect.left, cy - rect.top, 28, 0, Math.PI*2); ctx.fill();
                    const data = ctx.getImageData(0,0, canvas.width, canvas.height).data;
                    let em = 0; for(let i=3; i<data.length; i+=4) if(data[i]===0) em++;
                    const prog = (em/total); App.state.currentCompletion = prog * 100;
                    document.getElementById('prog-bar').style.width = `${prog*100}%`; document.getElementById('prog-text').innerText = `${(prog*100).toFixed(1)}%`;
                }
            };
            canvas.onmousedown = (e) => { isD = true; handleMove(e); };
            canvas.ontouchstart = (e) => { e.preventDefault(); isD = true; handleMove(e); };
            window.onmouseup = () => isD = false; window.ontouchend = () => isD = false;
            window.onmousemove = handleMove; window.ontouchmove = (e) => { e.preventDefault(); handleMove(e); };
        };

        window.toggleLaser = () => {
            App.state.isLaserOn = !App.state.isLaserOn;
            const sw = document.getElementById('laser-power-switch'); const cur = document.getElementById('laser-cursor'); const st = document.getElementById('power-status-text');
            if (App.state.isLaserOn) { sw.classList.add('on'); cur.classList.add('active-power'); st.innerText = "é›·å°„å·²å•Ÿå‹• ACTIVE"; } 
            else { sw.classList.remove('on'); cur.classList.remove('active-power'); st.innerText = "å¾…æ©Ÿæ¨¡å¼ STANDBY"; }
        };

        window.requestManualFinish = async () => {
            const reward = 800; App.state.data.gold += reward; App.state.data.level++;
            App.state.data.history.push({ d: App.state.data.gameHour+":00", a: reward });
            await App.data.save(); App.router.go('lobby');
        };

        window.apptAction = (sid) => {
            const appt = App.state.data.appointments[sid];
            if(!appt) return App.ui.notify("æ­¤æ™‚æ®µå°šæœªé ç´„", true);
            App.state.session = { ...appt, sid };
            App.router.go('game');
        };

        App.auth.init();
        window.app = App;
    </script>
</body>
</html>
