<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€…ç™½ä¹‹å¢ƒ Pure Skin V4.9 - ç¶“ç‡Ÿå¤§å¸«</title>
    <!-- å¼•å…¥ç³»çµ±è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pure: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8',
                            500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        bounceSubtle: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* æ ¸å¿ƒæ¨£å¼ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f0f9ff; }
        ::-webkit-scrollbar-thumb { background: #bae6fd; border-radius: 10px; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 12px 45px -10px rgba(31, 38, 135, 0.08);
        }
        
        .chart-container { position: relative; width: 100%; height: 240px; margin: 0 auto; }

        /* NPC Elsa V4.9 */
        .elsa-full { position: relative; width: 140px; height: 320px; transform: scale(0.85); margin-bottom: -40px; }
        .elsa-hair-back { position: absolute; top: 10px; left: 10px; width: 120px; height: 220px; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-radius: 60px 60px 20px 20px; z-index: 1; }
        .elsa-head { position: absolute; top: 15px; left: 35px; width: 70px; height: 85px; background: #ffe4e6; border-radius: 35px 35px 40px 40px; z-index: 10; }
        .elsa-eyes::before, .elsa-eyes::after { content: ''; position: absolute; top: 42px; width: 10px; height: 12px; background: #0f172a; border-radius: 50%; z-index: 11; }
        .elsa-eyes::before { left: 15px; } .elsa-eyes::after { right: 15px; }
        .elsa-mouth { position: absolute; bottom: 15px; left: 28px; width: 14px; height: 5px; background: #e11d48; border-radius: 3px; z-index: 11; }
        .elsa-body { position: absolute; top: 90px; left: 30px; width: 80px; height: 90px; background: #ffffff; border-radius: 20px; z-index: 5; border: 1px solid #cbd5e1; }
        .elsa-skirt { position: absolute; top: 175px; left: 20px; width: 100px; height: 140px; background: linear-gradient(180deg, #0ea5e9 0%, #0c4a6e 100%); border-radius: 10px 10px 50px 50px; z-index: 4; }

        /* æ•™å­¸æ°£æ³¡ */
        .tutor-bubble { position: absolute; z-index: 10000; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none; pointer-events: none; }
        .bubble-content { background: white; border: 3px solid #bae6fd; border-radius: 2.5rem; padding: 1.8rem; width: 280px; pointer-events: auto; position: relative; }
        .bubble-content::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-left: 3px solid #bae6fd; border-bottom: 3px solid #bae6fd; }
        .bubble-top .bubble-content::after { bottom: -14px; left: 50%; transform: translateX(-50%) rotate(-45deg); }
        .bubble-left .bubble-content::after { right: -14px; top: 50%; transform: translateY(-50%) rotate(-135deg); }

        #laser-cursor { position: fixed; width: 50px; height: 50px; border: 3px solid #0ea5e9; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; display: none; box-shadow: 0 0 20px rgba(14, 165, 233, 0.6); background: rgba(14, 165, 233, 0.1); }

        /* é ç´„æ™‚åˆ»è¡¨æ¨£å¼ */
        .timetable-row { border-bottom: 1px solid rgba(186, 230, 253, 0.3); padding: 16px 0; transition: 0.3s; }
        .timetable-row:last-child { border-bottom: none; }
        .timetable-row:hover { background: rgba(240, 249, 255, 0.5); }
        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 900; }
        .status-empty { background: #f1f5f9; color: #94a3b8; }
        .status-pending { background: #fef3c7; color: #d97706; }
        .status-accepted { background: #dcfce7; color: #16a34a; }
        .status-overdue { background: #fee2e2; color: #dc2626; }
    </style>
</head>
<body class="bg-pure-50 text-slate-700 min-h-screen font-sans selection:bg-pure-200 overflow-x-hidden">

    <div id="laser-cursor"></div>

    <!-- æ•™å­¸æ°£æ³¡ -->
    <div id="tutor-anchor" class="tutor-bubble bubble-top">
        <div class="flex flex-col items-center gap-2">
            <div class="elsa-full animate-bounce-subtle">
                <div class="elsa-hair-back"></div>
                <div class="elsa-head"><div class="elsa-eyes"></div><div class="elsa-mouth"></div></div>
                <div class="elsa-body"></div><div class="elsa-skirt"></div>
            </div>
            <div class="bubble-content shadow-2xl">
                <p id="tutor-text" class="text-slate-700 font-black leading-relaxed text-sm"></p>
                <button onclick="app.tutorial.next()" class="mt-4 w-full py-3 bg-pure-600 text-white rounded-2xl text-xs font-black shadow-lg hover:bg-pure-700 transition-all">ç¹¼çºŒ â¯</button>
            </div>
        </div>
    </div>

    <!-- å…¨åŸŸé€šçŸ¥ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[20000] transition-all duration-500 transform -translate-y-24 opacity-0 flex items-center gap-3 px-8 py-4 rounded-3xl shadow-2xl bg-white/95 backdrop-blur-md border border-pure-100">
        <i id="toast-icon" class="fa-solid fa-circle-check text-green-500"></i>
        <span id="toast-text" class="font-black text-slate-700 text-sm"></span>
    </div>

    <!-- éŠæˆ²æ™‚é–“æ™‚é˜ -->
    <div class="fixed top-6 right-6 z-[150] glass-panel px-6 py-3 rounded-full flex items-center gap-3 shadow-lg border-pure-200 animate-fade-in">
        <i class="fa-solid fa-clock text-pure-500"></i>
        <span id="game-clock" class="font-black text-slate-800 text-xl font-mono italic">10:00 AM</span>
    </div>

    <main id="app-root" class="w-full min-h-screen flex flex-col items-center justify-center relative overflow-hidden">
        
        <!-- èƒŒæ™¯é£¾å“ -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div class="absolute top-[-10%] left-[-15%] w-[60vw] h-[60vw] bg-pure-200/30 rounded-full filter blur-[120px] animate-pulse-slow"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[55vw] h-[55vw] bg-pink-100/30 rounded-full filter blur-[120px] animate-pulse-slow"></div>
        </div>

        <!-- 0. è¼‰å…¥è¦–åœ– -->
        <section id="view-loading" class="flex flex-col items-center gap-6 text-center transition-all duration-500">
            <div class="w-20 h-20 border-4 border-pure-100 border-t-pure-500 rounded-full animate-spin"></div>
            <h1 class="text-4xl font-black tracking-tighter text-slate-800 italic">ç€…ç™½ä¹‹å¢ƒ</h1>
            <p id="loading-status" class="text-xs font-bold text-pure-500 tracking-[0.6em] animate-pulse uppercase">é©—è­‰èº«ä»½ä¸­...</p>
        </section>

        <!-- 1. èªè­‰è¦–åœ– -->
        <section id="view-login" class="hidden w-full max-w-md px-6 animate-float">
            <div class="glass-panel p-10 rounded-[3.5rem] text-center shadow-2xl">
                <div class="w-24 h-24 bg-pure-50 rounded-3xl mx-auto flex items-center justify-center mb-8 text-4xl text-pure-600 shadow-inner">
                    <i class="fa-solid fa-crown"></i>
                </div>
                <h2 class="text-4xl font-black mb-2 text-slate-800 tracking-tight">ç¾å­¸æ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-400 text-[10px] font-bold tracking-[0.3em] uppercase mb-10">Career Identity Hub</p>
                <div class="space-y-4">
                    <button onclick="app.auth.loginGoogle()" class="w-full py-5 bg-white border border-slate-200 rounded-2xl font-black text-slate-600 shadow-sm hover:bg-pure-50 transition-all flex items-center justify-center gap-4">
                        <i class="fa-brands fa-google text-lg text-pure-600"></i> Google å¿«é€Ÿèªè­‰
                    </button>
                    <button onclick="app.auth.loginGameCenter()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black shadow-xl hover:bg-black transition-transform flex items-center justify-center gap-4">
                        <i class="fa-brands fa-apple text-xl"></i> Game Center ç™»å…¥
                    </button>
                </div>
            </div>
        </section>

        <!-- 1.2 åç¨±è¼¸å…¥è¦–åœ– (æ–°ç©å®¶) -->
        <section id="view-naming" class="hidden w-full max-w-md px-6">
            <div class="glass-panel p-10 rounded-[3.5rem] text-center shadow-2xl">
                <h2 class="text-3xl font-black text-slate-800 mb-6 italic underline decoration-pure-300">å»ºç«‹ç¾å­¸åç‰‡</h2>
                <p class="text-slate-400 text-sm mb-8 font-bold">è«‹è¼¸å…¥æ‚¨åœ¨ç¾å­¸ç•Œçš„å°ˆæ¥­åç¨±ï¼š</p>
                <input id="input-player-name" type="text" maxlength="8" placeholder="ä¾‹å¦‚ï¼šç¾å­¸é”äºº" class="w-full p-5 rounded-2xl bg-pure-50 border-2 border-pure-100 focus:border-pure-500 outline-none text-center font-black text-xl mb-8">
                <button onclick="app.auth.submitName()" class="w-full py-5 bg-pure-600 text-white font-black rounded-2xl shadow-xl hover:scale-105 transition-all">ç¢ºèªèº«ä»½ â¯</button>
            </div>
        </section>

        <!-- 1.5 æ­¡è¿è¦–åœ– -->
        <section id="view-welcome" class="hidden w-full max-w-2xl px-6 text-center">
            <div class="glass-panel p-12 rounded-[4rem] shadow-2xl border-white border-4 animate-fade-in">
                <div class="text-8xl mb-8 animate-float">ğŸ§Š</div>
                <h2 class="text-5xl font-black text-slate-800 mb-6 italic tracking-tighter">æ­¡è¿é–‹å•Ÿæ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-500 font-bold leading-relaxed text-lg mb-10">æº–å‚™å¥½ç®¡ç†æ‚¨çš„ç¾å­¸æ’ç¨‹èˆ‡æ™‚åˆ»è¡¨äº†å—ï¼Ÿ</p>
                <button onclick="app.tutorial.start()" class="px-16 py-5 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-xl rounded-2xl shadow-xl shadow-pure-200 hover:scale-105 transition-all">é–‹å§‹å°å¼• â¯</button>
            </div>
        </section>

        <!-- 2. å¤§å»³ (Dashboard) -->
        <section id="view-lobby" class="hidden w-full max-w-6xl flex flex-col gap-8 px-6">
            <header id="frame-profile" class="flex flex-col md:flex-row justify-between items-center glass-panel p-8 rounded-[3rem] gap-6 animate-slide-up">
                <div class="flex items-center gap-8">
                    <div class="w-16 h-16 bg-gradient-to-tr from-pure-500 to-cyan-400 rounded-2xl flex items-center justify-center text-white shadow-xl">
                        <i class="fa-solid fa-user-doctor text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-3xl font-black text-slate-800 italic" id="user-display-name">é¡§å•</h3>
                        <p class="text-xs font-bold text-pure-500 uppercase tracking-[0.2em]" id="user-title">-</p>
                    </div>
                </div>
                <div class="flex gap-12 items-center border-l border-slate-100 pl-12">
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest">è³‡ç”¢</p>
                        <p class="text-4xl font-black text-slate-800 font-mono italic">ğŸ’° <span id="lobby-gold">0</span></p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest">Lv</p>
                        <p class="text-4xl font-black text-pure-600 font-mono italic" id="lobby-level">1</p>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full animate-slide-up">
                <div id="frame-chart" class="lg:col-span-2 glass-panel p-10 rounded-[3.5rem] flex flex-col gap-8">
                    <div class="flex justify-between items-center">
                        <h4 class="text-2xl font-black text-slate-800 tracking-tighter italic"><i class="fa-solid fa-chart-line mr-4 text-pure-500"></i>ç¾å­¸ç¶“ç‡Ÿæ•¸æ“šåˆ†æ</h4>
                        <span class="text-[10px] bg-green-100 text-green-600 px-4 py-1 rounded-full font-black uppercase">Live</span>
                    </div>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>

                <div class="flex flex-col gap-6">
                    <button id="frame-appt" onclick="app.router.go('appointments')" class="group relative flex-1 bg-gradient-to-br from-pure-600 to-blue-800 text-white p-10 rounded-[3.5rem] shadow-2xl hover:scale-[1.02] transition-all text-left overflow-hidden">
                        <div class="absolute right-[-30px] bottom-[-30px] text-[12rem] text-white opacity-10 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calendar-days"></i></div>
                        <h2 class="text-4xl font-black italic mb-4">é ç´„æ™‚åˆ»è¡¨</h2>
                        <p class="text-sm font-medium opacity-80 leading-relaxed italic">ç®¡ç† 10:00 - 21:00 çš„å°ˆæ¥­æ™‚æ®µã€‚</p>
                    </button>
                    
                    <div class="glass-panel p-8 rounded-[3rem] flex flex-col gap-4">
                        <button onclick="app.audio.toggle()" class="flex items-center justify-between w-full p-4 rounded-2xl bg-pure-50 hover:bg-pure-100 transition-colors">
                            <span class="font-bold text-slate-600"><i id="lobby-music-icon" class="fa-solid fa-volume-xmark mr-3"></i>éŸ³æ¨‚</span>
                            <span id="lobby-music-text" class="text-[10px] font-black text-pure-400">OFF</span>
                        </button>
                        <button onclick="app.auth.logout()" class="flex items-center gap-3 text-slate-400 font-bold hover:text-red-500 transition-colors px-4 py-1 text-sm italic">
                            <i class="fa-solid fa-sign-out-alt"></i> ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. é ç´„æ™‚åˆ»è¡¨ (Table Mode 10:00-21:00) -->
        <section id="view-appointments" class="hidden w-full max-w-4xl flex flex-col h-[85vh] animate-slide-up px-4">
            <div class="glass-panel p-8 rounded-t-[4rem] flex justify-between items-center z-10 border-b-0 shadow-none">
                <div>
                    <h2 class="text-4xl font-black text-slate-800 italic tracking-tighter">å°ˆæ¥­æ’ç¨‹æ™‚åˆ»è¡¨</h2>
                    <p class="text-xs text-pure-400 font-bold mt-1 uppercase italic">Daily Aesthetic Timeline</p>
                </div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-2xl bg-pure-50 flex items-center justify-center text-pure-600 hover:bg-pure-100 shadow-inner transition-all"><i class="fa-solid fa-home text-xl"></i></button>
            </div>
            <div class="glass-panel p-8 rounded-b-[4rem] flex-1 overflow-y-auto custom-scrollbar shadow-2xl" id="timetable-container">
                <!-- Timetable rows generated by JS -->
            </div>
        </section>

        <!-- è¡ŒéŠ·æ–¹å¼é¸æ“‡ (Modal) -->
        <div id="modal-marketing" class="hidden fixed inset-0 z-[11000] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
            <div class="glass-panel max-w-xl w-full p-10 rounded-[4rem] shadow-2xl">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-2xl font-black text-slate-800 italic">å¸‚å ´é–‹ç™¼æŠ•æ”¾</h3>
                    <button onclick="document.getElementById('modal-marketing').classList.add('hidden')" class="text-slate-400 p-2 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-4" id="marketing-list"></div>
            </div>
        </div>

        <!-- RPG è«®è©¢è¦–åœ– -->
        <section id="view-dialogue" class="hidden w-full max-w-2xl px-6">
            <div class="glass-panel p-12 rounded-[5rem] text-center relative overflow-hidden shadow-2xl border-white border-4">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-300 to-pure-400"></div>
                <div id="customer-avatar-box" class="mb-10 animate-float"></div>
                <div class="bg-blue-50/50 p-8 rounded-[3rem] border border-pure-100 mb-8 text-left shadow-inner">
                    <h3 class="font-black text-pure-600 text-xl mb-3" id="diag-name">è²´è³“è«®è©¢</h3>
                    <p id="diag-text" class="text-slate-700 font-bold leading-relaxed text-2xl italic min-h-[4em]">...</p>
                </div>
                <div id="diag-options" class="flex flex-col gap-4"></div>
            </div>
        </section>

        <!-- é›·å°„äº’å‹• -->
        <section id="view-game" class="hidden w-full max-w-md flex flex-col items-center gap-10">
            <div class="w-full glass-panel p-6 rounded-full flex items-center gap-8 shadow-2xl border-white border-[6px]">
                <div class="flex-1 bg-slate-100 h-6 rounded-full overflow-hidden relative shadow-inner">
                    <div id="prog-bar" class="h-full bg-gradient-to-r from-pure-400 to-cyan-500 w-0 transition-all duration-300 shadow-[0_0_20px_#0ea5e9]"></div>
                </div>
                <span id="prog-text" class="text-sm font-black text-pure-700 font-mono italic">0.0%</span>
            </div>
            <div class="relative rounded-[5.5rem] overflow-hidden shadow-2xl border-[16px] border-white ring-2 ring-blue-50/50">
                <canvas id="game-canvas" class="bg-pure-50 cursor-none touch-none"></canvas>
            </div>
            <p class="text-pure-500 text-xs font-bold mt-3 animate-pulse italic">æ“ä½œé›·å°„æ¢é ­æŠ¹é™¤æ‰€æœ‰æ¯›é«®</p>
        </section>

        <!-- çµç®—è¦–åœ– -->
        <div id="modal-result" class="hidden fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-3xl flex items-center justify-center p-6">
            <div class="glass-panel p-16 rounded-[6rem] text-center max-md w-full border-white border-[8px] shadow-2xl animate-fade-in relative overflow-hidden">
                <div class="w-28 h-28 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-10 text-6xl text-green-500 shadow-inner animate-pulse"><i class="fa-solid fa-award"></i></div>
                <h2 class="text-5xl font-black text-slate-800 mb-4 tracking-tighter italic underline decoration-pure-100">ç™‚ç¨‹åœ“æ»¿ï¼</h2>
                <div class="bg-pure-50 p-8 rounded-[3.5rem] border border-pure-100 mb-12 shadow-inner">
                    <p class="text-6xl font-black text-pure-600 font-mono italic tracking-tighter">+ğŸ’° <span id="reward-val">0</span></p>
                </div>
                <button onclick="window.location.reload()" class="w-full py-7 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-2xl rounded-3xl shadow-2xl hover:scale-105 active:scale-95 transition-all">è¿”å›æ™‚åˆ»è¡¨</button>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, OAuthProvider, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒé…ç½® ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyCIKSbaZ5R6RTSRcH_-YYfqz_OnQQFr1gc", authDomain: "pure-skin-8640d.firebaseapp.com", projectId: "pure-skin-8640d", storageBucket: "pure-skin-8640d.firebasestorage.app", messagingSenderId: "890613609117", appId: "1:890613609117:web:ed044e453e6cc789b01a74", measurementId: "G-27E3XSTTBH" };
        const globalAppId = 'pure-skin-studio-master';
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- åå–®èˆ‡å¸¸é‡ ---
        const CAREERS = ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«", "é¦–å¸­æŠ€è¡“å®˜", "é†«ç¾é¡§å•", "é›·å°„ç‰©ç†å°ˆå®¶", "çš®è†šè‡¨åºŠé†«ç”Ÿ", "æŠ—è€ç ”ç©¶å“¡", "ç”Ÿç‰©çº–ç¶­å°ˆå®¶", "é†«å­¸ç¾å®¹é™¢é•·", "å©šç¦®é€ å‹å¸«", "æ™‚å°šé›œèªŒé¡§å•", "å¥½èŠå¡¢ç‰¹æ•ˆè­·ç†", "æ˜æ˜Ÿå¾¡ç”¨å¤§å¸«", "äººé«”ç¾å­¸å®¶", "æ²™é¾åº—é•·", "å“ç‰Œç¶“ç†", "é€£é–åº—å‰µå§‹äºº", "ç¾å®¹é›†åœ˜ CEO", "å…¨çƒç¾å­¸æ•™çˆ¶"];
        const SURNAMES = ["é™³", "æ", "ç‹", "å¼µ", "åŠ‰", "é»ƒ", "æ—", "è¶™", "å³", "å¾", "å­«", "èƒ¡", "æœ±", "é«˜", "é¦¬"];
        const NAMES = ["å°æ˜", "ç¾ç²", "å­è±ª", "é›…é›¯", "æ‰¿ç¿°", "é›¨æŸ”", "ä¿Šå»·", "è©©å©·", "å¨å»‰", "å‡±ç‘Ÿç³", "æŸå®‡", "æ¬£å„€", "å»ºå®", "å˜‰æ¬£", "å®—ä½‘"];
        const TW_NAMES = Array.from({length: 300}, () => SURNAMES[Math.floor(Math.random()*SURNAMES.length)] + NAMES[Math.floor(Math.random()*NAMES.length)]);
        
        const MARKETING_METHODS = [
            { name: "ç¤¾ç¾¤é™å‹•æ¨æ’­", cost: 300, power: 0.15 },
            { name: "å€åŸŸç°¡è¨Šå»£å‘Š", cost: 200, power: 0.1 },
            { name: "å•†åœˆå®šé»æ´¾å ±", cost: 150, power: 0.08 },
            { name: "ç¾å¦ç¶²ç´…é–‹ç®±", cost: 1200, power: 0.4 },
            { name: "æ·é‹ç‡ˆç®±å»£å‘Š", cost: 2000, power: 0.6 },
            { name: "æ™‚å°šé›œèªŒå°ˆè¨ª", cost: 3500, power: 0.8 },
            { name: "é›»è¦–è¢å¹•æŠ•æ”¾", cost: 5000, power: 0.95 },
            { name: "æœƒå“¡è£‚è®Šçå‹µ", cost: 500, power: 0.25 }
        ];

        const BODY_PARTS = {
            face: { name: 'è‡‰éƒ¨', cost: 100 }, underarm: { name: 'è…‹ä¸‹', cost: 150 }, bikini: { name: 'VIOç§å¯†', cost: 480 }, limbs: { name: 'å››è‚¢', cost: 220 }, back: { name: 'èƒŒéƒ¨', cost: 320 }
        };

        const App = {
            state: {
                user: null, data: { gold: 3000, level: 1, history: [], isNewPlayer: true, appointments: {}, playerName: "", gameHour: 10, gameMinute: 0, marketingStrength: 0 },
                view: 'loading', session: null, isAuthResolved: false, tutorialStep: 0, audio: { el: null, muted: true }
            },

            // --- æ™‚é–“ç³»çµ± ---
            timer: {
                start: () => {
                    setInterval(() => {
                        if (App.state.view === 'lobby' || App.state.view === 'appointments') {
                            App.timer.tick();
                        }
                    }, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ (å¿«é€Ÿæ¨¡æ“¬)
                },
                tick: async () => {
                    App.state.data.gameMinute += 15;
                    if (App.state.data.gameMinute >= 60) {
                        App.state.data.gameMinute = 0;
                        App.state.data.gameHour++;
                        if (App.state.data.gameHour > 21) App.state.data.gameHour = 10; // å¾ªç’°ç‡Ÿæ¥­
                    }
                    App.ui.updateClock();
                    App.timer.processMarketing();
                    App.ui.renderTimetable();
                },
                processMarketing: async () => {
                    if (App.state.data.marketingStrength > 0 && Math.random() < (0.1 + App.state.data.marketingStrength)) {
                        const slots = [10, 12, 14, 16, 18, 20];
                        const freeSlots = slots.filter(s => !App.state.data.appointments[s]);
                        if (freeSlots.length > 0) {
                            const target = freeSlots[Math.floor(Math.random()*freeSlots.length)];
                            App.state.data.appointments[target] = {
                                name: TW_NAMES[Math.floor(Math.random()*TW_NAMES.length)],
                                part: Object.keys(BODY_PARTS)[Math.floor(Math.random()*5)],
                                gender: Math.random() > 0.5 ? 'male' : 'female',
                                status: 'pending' // å¾…æ¥å—
                            };
                            App.state.data.marketingStrength *= 0.8; // åŠ›é‡éš¨æ™‚é–“è¡°æ¸›
                            App.ui.notify("è¡ŒéŠ·ç”Ÿæ•ˆï¼æœ‰æ–°è²´è³“é ç´„ã€‚");
                            await App.data.save();
                        }
                    }
                }
            },

            auth: {
                init: async () => {
                    onAuthStateChanged(auth, async (user) => {
                        App.state.isAuthResolved = true;
                        if (user && !user.isAnonymous) {
                            App.state.user = user;
                            await App.data.sync(); 
                            if (!App.state.data.playerName) App.router.go('naming');
                            else if (App.state.data.isNewPlayer) App.router.go('welcome');
                            else App.router.go('lobby');
                            App.timer.start();
                        } else {
                            if(user && user.isAnonymous) await signOut(auth);
                            App.router.go('login');
                        }
                    });
                },
                loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()),
                submitName: async () => {
                    const name = document.getElementById('input-player-name').value.trim();
                    if (!name) return App.ui.notify("è«‹è¼¸å…¥åç¨±", true);
                    App.state.data.playerName = name;
                    await App.data.save();
                    App.router.go('welcome');
                },
                logout: async () => { localStorage.clear(); await signOut(auth); window.location.reload(); }
            },

            tutorial: {
                steps: [
                    { text: "å°å¸« Elsa å ±åˆ°ï¼å³ä¸Šè§’æ˜¯ç›®å‰çš„ç‡Ÿæ¥­æ™‚é–“ï¼Œè«‹æ³¨æ„ç¶“ç‡Ÿæ•ˆç‡ã€‚", target: "game-clock", pos: "bubble-top" },
                    { text: "é ç´„æ™‚åˆ»è¡¨æ˜¯æ‚¨çš„æˆ°ç•¥æ ¸å¿ƒï¼Œé»æ“Šç©ºä½å³å¯æŠ•æ”¾è¡ŒéŠ·å»£å‘Šã€‚", target: "frame-appt", pos: "bubble-left" },
                    { text: "è‹¥æ˜¯é ç´„è²´è³“å¾…ç¢ºèªï¼Œè«‹å„˜é€Ÿç¢ºèªï¼Œå¦å‰‡é€¾æ™‚æœƒé€ æˆè³‡ç”¢æå¤±å–”ï¼", target: "timetable-container", pos: "bubble-top" }
                ],
                start: () => { App.router.go('lobby'); App.state.tutorialStep = 0; document.getElementById('tutor-anchor').style.display = 'flex'; App.tutorial.render(); },
                render: () => {
                    const step = App.tutorial.steps[App.state.tutorialStep];
                    const anchor = document.getElementById('tutor-anchor');
                    document.getElementById('tutor-text').innerText = step.text;
                    anchor.className = `tutor-bubble ${step.pos}`;
                    const targetEl = document.getElementById(step.target);
                    if (targetEl) {
                        const rect = targetEl.getBoundingClientRect();
                        anchor.style.top = (rect.top - 420) + 'px'; anchor.style.left = (rect.left + rect.width/2 - 140) + 'px';
                    }
                },
                next: async () => {
                    App.state.tutorialStep++;
                    if (App.state.tutorialStep < App.tutorial.steps.length) App.tutorial.render();
                    else {
                        document.getElementById('tutor-anchor').style.display = 'none';
                        App.state.data.isNewPlayer = false;
                        await App.data.save();
                        App.ui.notify("ç¾å­¸ä¹‹è·¯æ­£å¼å•Ÿå‹•ï¼");
                    }
                }
            },

            data: {
                sync: async () => {
                    const userRef = doc(db, 'artifacts', globalAppId, 'users', App.state.user.uid, 'saveData', 'profile');
                    const snap = await getDoc(userRef);
                    if (snap.exists()) App.state.data = { ...App.state.data, ...snap.data() };
                    else await setDoc(userRef, App.state.data);
                    onSnapshot(userRef, (s) => { if(s.exists()) { App.state.data = { ...App.state.data, ...s.data() }; App.ui.updateLobby(); } });
                },
                save: async () => {
                    const userRef = doc(db, 'artifacts', globalAppId, 'users', App.state.user.uid, 'saveData', 'profile');
                    await setDoc(userRef, App.state.data, { merge: true });
                }
            },

            ui: {
                notify: (msg, isErr) => {
                    const el = document.getElementById('toast');
                    document.getElementById('toast-text').innerText = msg;
                    document.getElementById('toast-icon').className = isErr ? "fa-solid fa-circle-exclamation text-red-500" : "fa-solid fa-circle-check text-green-500";
                    el.classList.remove('-translate-y-24', 'opacity-0');
                    setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000);
                },
                updateClock: () => {
                    const h = App.state.data.gameHour; const m = App.state.data.gameMinute;
                    document.getElementById('game-clock').innerText = `${h}:${m === 0 ? '00' : m} ${h >= 12 ? 'PM' : 'AM'}`;
                },
                updateLobby: () => {
                    document.getElementById('lobby-gold').innerText = App.state.data.gold.toLocaleString();
                    document.getElementById('lobby-level').innerText = App.state.data.level;
                    document.getElementById('user-display-name').innerText = App.state.data.playerName;
                    document.getElementById('user-title').innerText = CAREERS[Math.min(Math.floor(App.state.data.level / 2), CAREERS.length-1)];
                    if (window.revenueChartInstance) App.ui.renderChart();
                },
                renderChart: () => {
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    const history = App.state.data.history.length > 0 ? App.state.data.history : [{a: 0, d:'ç³»çµ±è¼‰å…¥'}];
                    if (window.revenueChartInstance) window.revenueChartInstance.destroy();
                    window.revenueChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels: history.map(h => h.d), datasets: [{ data: history.map(h => h.a), borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.05)', borderWidth: 5, tension: 0.4, fill: true }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
                    });
                },
                renderTimetable: () => {
                    const container = document.getElementById('timetable-container');
                    if (!container) return;
                    const slots = [10, 12, 14, 16, 18, 20];
                    let html = `<div class="space-y-2">`;
                    slots.forEach(hour => {
                        const appt = App.state.data.appointments[hour];
                        const isPast = hour < App.state.data.gameHour;
                        let statusHtml = `<span class="status-pill status-empty">å¯æ’ç¨‹ç©ºä½</span>`;
                        let actionBtn = `<button onclick="window.openMarketing(${hour})" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-black">è¡ŒéŠ·æŠ•æ”¾</button>`;
                        
                        if (appt) {
                            const isOverdue = isPast && appt.status !== 'finished';
                            const genderIcon = appt.gender === 'male' ? '<i class="fa-solid fa-mars text-blue-500 mr-2"></i>' : '<i class="fa-solid fa-venus text-red-500 mr-2"></i>';
                            
                            if (appt.status === 'pending') {
                                statusHtml = `<span class="status-pill status-pending">å¾…ç¢ºèªé ç´„</span>`;
                                actionBtn = `<div class="flex gap-2"><button onclick="window.confirmAppt(${hour}, true)" class="px-4 py-2 bg-green-500 text-white rounded-xl text-xs font-black">æ¥å—</button><button onclick="window.confirmAppt(${hour}, false)" class="px-4 py-2 bg-slate-200 text-slate-500 rounded-xl text-xs font-black">å©‰æ‹’</button></div>`;
                            } else if (appt.status === 'accepted') {
                                statusHtml = `<span class="status-pill status-accepted">å·²ç¢ºèªé ç´„</span>`;
                                actionBtn = isOverdue ? `<button onclick="window.rescheduleDialogue(${hour})" class="px-4 py-2 bg-red-500 text-white rounded-xl text-xs font-black">é€¾æ™‚å”å•†</button>` : `<button onclick="window.startAesthetic(${hour})" class="px-4 py-2 bg-pure-600 text-white rounded-xl text-xs font-black">é–‹å§‹ç™‚ç¨‹</button>`;
                            } else if (appt.status === 'finished') {
                                statusHtml = `<span class="status-pill status-empty opacity-50">ç™‚ç¨‹å·²å®Œæˆ</span>`;
                                actionBtn = `<span class="text-[10px] text-slate-300 italic font-bold">è©•åƒ¹ï¼šå¥½è©•</span>`;
                            }

                            html += `<div class="timetable-row flex items-center justify-between">
                                <div class="flex items-center gap-6">
                                    <span class="w-16 font-mono font-black text-slate-400 text-lg">${hour}:00</span>
                                    <div>
                                        <p class="font-black text-slate-700">${genderIcon}${appt.name}</p>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${BODY_PARTS[appt.part]?.name || 'å…¨èº«'}ç™‚ç¨‹</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">${statusHtml} ${actionBtn}</div>
                            </div>`;
                        } else {
                            html += `<div class="timetable-row flex items-center justify-between opacity-60">
                                <div class="flex items-center gap-6">
                                    <span class="w-16 font-mono font-black text-slate-300 text-lg">${hour}:00</span>
                                    <span class="text-slate-300 italic text-sm">æ­¤æ™‚æ®µå°šç„¡è²´è³“é ç´„</span>
                                </div>
                                ${actionBtn}
                            </div>`;
                        }
                    });
                    html += `</div>`;
                    container.innerHTML = html;
                }
            },

            router: {
                go: (viewId) => {
                    document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                    App.state.view = viewId;
                    if (viewId === 'appointments') App.ui.renderTimetable();
                    if (viewId === 'lobby') App.ui.updateLobby();
                }
            }
        };

        // --- å…¨åŸŸæ©‹æ¥èˆ‡è¡ŒéŠ·ç³»çµ± ---
        window.openMarketing = (hour) => {
            App.state.targetSlot = hour;
            const modal = document.getElementById('modal-marketing');
            document.getElementById('marketing-list').innerHTML = MARKETING_METHODS.map((m, i) => `
                <button onclick="window.doMarketing(${i})" class="p-4 bg-white border-2 border-pure-100 rounded-2xl text-left hover:border-pure-500 transition-all shadow-sm group">
                    <div class="font-black text-slate-700 text-sm group-hover:text-pure-600">${m.name}</div>
                    <div class="text-pure-500 font-bold text-xs mt-1">ğŸ’° ${m.cost}</div>
                </button>
            `).join('');
            modal.classList.remove('hidden');
        };

        window.doMarketing = async (idx) => {
            const m = MARKETING_METHODS[idx];
            if (App.state.data.gold < m.cost) return App.ui.notify("è³‡ç”¢ä¸è¶³", true);
            App.state.data.gold -= m.cost;
            App.state.data.marketingStrength += m.power;
            document.getElementById('modal-marketing').classList.add('hidden');
            App.ui.notify("å»£å‘ŠæŠ•æ”¾ä¸­ï¼Œè«‹éš¨æ™‚ç•™æ„æ™‚åˆ»è¡¨ã€‚");
            await App.data.save();
        };

        window.confirmAppt = async (hour, isAccept) => {
            if (isAccept) App.state.data.appointments[hour].status = 'accepted';
            else {
                delete App.state.data.appointments[hour];
                App.state.data.gold -= 100; // æ‹’çµ•é ç´„æå¤±å®¢ç¾¤
                App.ui.notify("å©‰æ‹’é ç´„å·²æ‰£é™¤è³‡ç”¢ 100", true);
            }
            await App.data.save();
            App.ui.renderTimetable();
        };

        window.rescheduleDialogue = (hour) => {
            const appt = App.state.data.appointments[hour];
            App.state.session = { ...appt, hour };
            App.router.go('dialogue');
            document.getElementById('customer-avatar-box').innerHTML = `<div class="css-avatar"><div class="css-head"></div><div class="css-body"></div></div>`;
            document.getElementById('diag-name').innerText = appt.name;
            document.getElementById('diag-text').innerText = "ä¸å¥½æ„æ€ï¼Œå› ç‚ºæ‚¨é€¾æ™‚æœªé–‹å±•ç™‚ç¨‹ï¼Œæ˜¯å¦èƒ½å¹«æˆ‘é‡æ–°æ’ç¨‹åˆ°ä¸‹ä¸€å€‹ç©ºæª”ï¼Ÿ";
            document.getElementById('diag-options').innerHTML = `<button onclick="window.processReschedule(${hour})" class="w-full p-5 bg-pure-600 text-white rounded-3xl font-black">åŒæ„æ”¹æœŸ â¯</button>`;
        };

        window.processReschedule = async (oldHour) => {
            const appt = App.state.data.appointments[oldHour];
            const freeSlots = [10, 12, 14, 16, 18, 20].filter(s => !App.state.data.appointments[s] && s > App.state.data.gameHour);
            if (freeSlots.length === 0) return App.ui.notify("ä»Šæ—¥å·²ç„¡ç©ºæª”ï¼Œè«‹ç›´æ¥é€€è²»", true);
            const nextSlot = freeSlots[0];
            App.state.data.appointments[nextSlot] = { ...appt, status: 'accepted' };
            delete App.state.data.appointments[oldHour];
            await App.data.save();
            App.router.go('appointments');
            App.ui.notify("å·²æˆåŠŸæ”¹æœŸè‡³ " + nextSlot + ":00");
        };

        window.startAesthetic = (hour) => {
            App.state.session = { ...App.state.data.appointments[hour], hour };
            App.router.go('game');
            window.initCanvas();
        };

        // --- Canvas é‚è¼¯ ---
        let canvas, ctx;
        window.initCanvas = () => {
            canvas = document.getElementById('game-canvas'); ctx = canvas.getContext('2d');
            const container = canvas.parentElement; canvas.width = container.clientWidth; canvas.height = 450;
            const total = canvas.width * canvas.height; const laser = document.getElementById('laser-cursor');
            ctx.fillStyle = App.state.session.gender === 'male' ? '#f4d1c1' : '#fff0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = '#4a3528'; ctx.lineWidth = 1;
            for (let i = 0; i < 3000; i++) {
                const x = Math.random() * canvas.width; const y = Math.random() * canvas.height;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + (Math.random()-0.5)*4, y + 8); ctx.stroke();
            }
            let isDragging = false;
            canvas.onmousedown = () => isDragging = true;
            window.onmouseup = () => isDragging = false;
            window.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect(); const cx = e.clientX; const cy = e.clientY;
                laser.style.left = cx + 'px'; laser.style.top = cy + 'px'; laser.style.display = 'block';
                if (isDragging) {
                    ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath();
                    ctx.arc(cx - rect.left, cy - rect.top, 30, 0, Math.PI*2); ctx.fill();
                    const data = ctx.getImageData(0,0, canvas.width, canvas.height).data;
                    let empty = 0; for(let i=3; i<data.length; i+=4) if(data[i]===0) empty++;
                    const prog = (empty/total); 
                    document.getElementById('prog-bar').style.width = `${prog*100}%`;
                    document.getElementById('prog-text').innerText = `${(prog*100).toFixed(1)}%`;
                    if (prog > 0.985) window.finishAesthetic();
                }
            };
        };

        window.finishAesthetic = async () => {
            document.getElementById('laser-cursor').style.display = 'none';
            const reward = BODY_PARTS[App.state.session.part]?.cost || 100;
            App.state.data.gold += reward; App.state.data.level++;
            App.state.data.history.push({ d: App.state.data.gameHour+":00", a: reward });
            App.state.data.appointments[App.state.session.hour].status = 'finished';
            await App.data.save();
            document.getElementById('reward-val').innerText = reward;
            document.getElementById('modal-result').classList.remove('hidden');
        };

        App.audio = {
            toggle: () => {
                if(!App.state.audio.el) {
                    App.state.audio.el = new Audio("https://assets.mixkit.co/music/preview/kit-serene-view-443.mp3");
                    App.state.audio.el.loop = true;
                }
                if(App.state.audio.muted) {
                    App.state.audio.el.play().then(() => {
                        App.state.audio.muted = false;
                        document.getElementById('lobby-music-icon').className = "fa-solid fa-volume-high text-pure-500";
                    });
                } else {
                    App.state.audio.el.pause();
                    App.state.audio.muted = true;
                    document.getElementById('lobby-music-icon').className = "fa-solid fa-volume-xmark";
                }
            }
        };

        App.auth.init();
        window.app = App;
    </script>
</body>
</html>
