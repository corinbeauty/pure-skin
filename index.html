<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€…ç™½ä¹‹å¢ƒ Pure Skin - V3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, OAuthProvider, signInWithCustomToken,
            onAuthStateChanged, setPersistence, browserLocalPersistence, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase é…ç½® ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pure-skin-studio-master';

        // --- é è¨­åŠ‡æƒ…èˆ‡é ç´„åå–®ç”Ÿæˆ ---
        const CUSTOMER_NAMES = ["è‰¾ç±³è‰", "å‚‘å…‹", "éœ²è¥¿", "ç´¢è²äº", "é¦¬å…‹æ–¯", "å¥§è‰è–‡äº", "æ¹¯å§†", "å‡±ç‰¹", "ä¸¹å°¼çˆ¾", "å…‹æ´›ä¼Š"];
        
        const DEFAULT_STORIES = Array.from({length: 20}, (_, i) => ({
            id: i,
            title: `æ¡ˆä¾‹ #${i + 1}`,
            text: [
                `ä½ å¥½ï¼æˆ‘æ˜¯ç¬¬ ${i+1} è™Ÿé ç´„è€…ã€‚æˆ‘çš„çš®è†šæ¯”è¼ƒæ•æ„Ÿï¼Œä¸çŸ¥é“é€™è£¡çš„é›·å°„æœƒä¸æœƒç—›ï¼Ÿ`,
                `å…¶å¯¦æˆ‘ä¸‹é€±æœ‰å€‹é‡è¦çš„ç´„æœƒï¼Œæ‰€ä»¥æ‰æ±ºå®šä¾†é€™è£¡æ”¹å–„è†šæ³ã€‚`,
                `é€™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡å˜—è©¦å…¨èº«é™¤æ¯›ï¼Œè½èªªç€…ç™½ä¹‹å¢ƒçš„æŠ€è¡“æ˜¯æ¥­ç•Œæœ€å¼·çš„ã€‚`,
                `é†«ç”Ÿä½ å¥½ï¼Œæˆ‘æœ€è¿‘è¦ºå¾—æ¯›é«®ç”Ÿé•·å¤ªå¿«äº†ï¼Œå¸Œæœ›èƒ½å¾¹åº•è§£æ±ºã€‚`,
                `æˆ‘æƒ³è¦è™•ç†è…‹ä¸‹çš„éƒ¨åˆ†ï¼Œå› ç‚ºå¤å¤©å¿«åˆ°äº†ï¼Œæƒ³ç©¿ç„¡è¢–èƒŒå¿ƒã€‚`
            ][i % 5],
            options: [
                { text: "æˆ‘å€‘æœƒä½¿ç”¨æœ€æº«å’Œçš„è„ˆè¡æŠ€è¡“ï¼Œè«‹æ”¾å¿ƒã€‚", response: "è½ä½ é€™éº¼èªªæˆ‘å°±å®‰å¿ƒå¤šäº†ï¼è«‹é–‹å§‹å§ã€‚" },
                { text: "è¿½æ±‚ç€…ç™½æ˜¯æœ‰ä»£åƒ¹çš„ï¼Œä½†æˆ‘æœƒå„˜é‡å¿«é€Ÿç²¾æº–ã€‚", response: "å–”...å¥½å§ï¼Œæˆ‘ç›¸ä¿¡å°ˆæ¥­çš„åˆ¤æ–·ã€‚" }
            ]
        }));

        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            user: null, totalGold: 0, level: 1, exp: 0, careerIndex: 0,
            view: 'loading',
            bodyParts: {}, careerTitles: [], stories: DEFAULT_STORIES,
            appointments: [],
            currentCustomer: null,
            dialogueStep: 0,
            isCleaning: false, isMuted: true,
            isDefinitionsLoaded: false
        };

        const bgm = new Audio("https://assets.mixkit.co/music/preview/mixkit-serene-view-443.mp3");
        bgm.loop = true;

        window.toggleMusic = () => {
            state.isMuted = !state.isMuted;
            if (!state.isMuted) bgm.play().catch(e => console.log("ç­‰å¾…äº’å‹•å¾Œæ’­æ”¾"));
            else bgm.pause();
            document.getElementById('music-icon').innerText = state.isMuted ? "ğŸ”‡" : "ğŸ”Š";
        };

        // --- UI å·¥å…· ---
        function showMessage(text, isError = false) {
            const box = document.getElementById('message-box');
            if (!box) return;
            document.getElementById('message-content').innerText = text;
            box.classList.remove('hidden');
            box.classList.add('flex');
            box.className = isError 
                ? "fixed top-10 left-1/2 -translate-x-1/2 z-[20000] px-8 py-4 rounded-3xl text-white font-bold shadow-2xl bg-red-500/90" 
                : "fixed top-10 left-1/2 -translate-x-1/2 z-[20000] px-8 py-4 rounded-3xl text-white font-bold shadow-2xl bg-blue-600/90";
            setTimeout(() => { box.classList.add('hidden'); box.classList.remove('flex'); }, 5000);
        }

        // --- è¦–è¦ºå¼•æ“ï¼šå¯æ„›è§’è‰² SVG ç”Ÿæˆ ---
        function renderAvatar(gender, targetId) {
            const color = gender === 'male' ? '#bae6fd' : '#fecdd3';
            const hair = gender === 'male' 
                ? 'M20,45 Q50,15 80,45 L80,35 Q50,5 20,35 Z' 
                : 'M10,50 Q50,-10 90,50 L95,100 L5,100 Z';
            const svg = `
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg">
                    <circle cx="50" cy="55" r="40" fill="white" stroke="${color}" stroke-width="2"/>
                    <path d="${hair}" fill="${color}" opacity="0.9"/>
                    <circle cx="38" cy="55" r="3" fill="#334155"/>
                    <circle cx="62" cy="55" r="3" fill="#334155"/>
                    <path d="M42,75 Q50,82 58,75" fill="none" stroke="#334155" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="32" cy="65" r="4" fill="#fecaca" opacity="0.6"/>
                    <circle cx="68" cy="65" r="4" fill="#fecaca" opacity="0.6"/>
                </svg>
            `;
            const container = document.getElementById(targetId);
            if (container) container.innerHTML = svg;
        }

        // --- åˆå§‹åŒ–å…¥å£ ---
        async function init() {
            try { 
                await setPersistence(auth, browserLocalPersistence); 
            } catch(e){ console.warn("æŒä¹…åŒ–ä¸å¯ç”¨"); }

            // RULE 3: Auth Before Queries - å…ˆåŸ·è¡Œç™»å…¥
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth().catch(err => console.error("é©—è­‰å¤±æ•—", err));

            onAuthStateChanged(auth, async (currUser) => {
                if (currUser) {
                    state.user = currUser;
                    await syncDefinitions();
                    await syncUserData();
                    generateAppointments();
                    if (state.view === 'loading' || state.view === 'login') {
                        switchView('lobby');
                    }
                } else {
                    state.user = null;
                    switchView('login');
                }
            });

            const probe = document.getElementById('laser-probe');
            window.addEventListener('mousemove', (e) => { 
                if (probe) {
                    probe.style.left = `${e.clientX}px`; 
                    probe.style.top = `${e.clientY}px`; 
                }
            });
        }

        function generateAppointments() {
            const partsKeys = Object.keys(state.bodyParts).length > 0 ? Object.keys(state.bodyParts) : ['face', 'underarm', 'bikini', 'limbs'];
            state.appointments = Array.from({length: 8}, (_, i) => ({
                id: i,
                name: CUSTOMER_NAMES[Math.floor(Math.random() * CUSTOMER_NAMES.length)],
                time: `${10 + i}:30`,
                gender: Math.random() > 0.5 ? 'female' : 'male',
                part: partsKeys[Math.floor(Math.random() * partsKeys.length)],
                status: i < 2 ? 'READY' : 'WAITING'
            }));
            if (state.view === 'appointments') renderAppointmentList();
        }

        async function syncDefinitions() {
            if (!auth.currentUser) return; // æ²’ç™»å…¥ä¸åŸ·è¡Œï¼Œé˜²æ­¢ Permission Denied

            try {
                // ç¢ºä¿è·¯å¾‘æœ‰å¶æ•¸å€‹æ®µè½ (6 segments)
                const defRef = doc(db, 'artifacts', appId, 'public', 'data', 'definitions', 'config');
                const snap = await getDoc(defRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    state.bodyParts = data.bodyParts || {};
                    state.careerTitles = data.careerTitles || [];
                    state.stories = data.stories || DEFAULT_STORIES;
                } else {
                    const defaults = {
                        bodyParts: {
                            face: { name: 'è‡‰éƒ¨', icon: 'ğŸ‘¤', cost: 100, desc: 'ä¸Šå”‡ã€ä¸‹å·´ç²¾ç´°è­·ç†ã€‚' },
                            underarm: { name: 'è…‹ä¸‹', icon: 'âœ¨', cost: 150, desc: 'æƒé™¤é»‘é ­æ²‰ç©ã€‚' },
                            bikini: { name: 'VIO', icon: 'ğŸ‘™', cost: 480, desc: 'æ¥µè‡´è¦ªè†šæº«æŸ”å‘µè­·ã€‚' },
                            limbs: { name: 'å››è‚¢', icon: 'ğŸ¦µ', cost: 220, desc: 'æ‰“é€ å¤§é¢ç©çµ²æ»‘è‚Œã€‚' }
                        },
                        careerTitles: ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«", "é¦–å¸­æŠ€è¡“å®˜", "é†«ç¾é¡§å•", "é›·å°„ç‰©ç†å°ˆå®¶", "çš®è†šè‡¨åºŠé†«ç”Ÿ", "æŠ—è€ç ”ç©¶å“¡", "ç”Ÿç‰©çº–ç¶­å°ˆå®¶", "é†«å­¸ç¾å®¹é™¢é•·", "å©šç¦®é€ å‹å¸«", "æ™‚å°šé›œèªŒé¡§å•", "å¥½èŠå¡¢ç‰¹æ•ˆè­·ç†", "æ˜æ˜Ÿå¾¡ç”¨å¤§å¸«", "äººé«”ç¾å­¸å®¶", "æ²™é¾åº—é•·", "å“ç‰Œç¶“ç†", "é€£é–åº—å‰µå§‹äºº", "ç¾å®¹é›†åœ˜ CEO", "å…¨çƒç¾å­¸æ•™çˆ¶"],
                        stories: DEFAULT_STORIES
                    };
                    // å˜—è©¦å¯«å…¥åˆå§‹é…ç½® (å¦‚æœæ¬Šé™å…è¨±)
                    await setDoc(defRef, defaults).catch(e => console.warn("ç„¡æ³•å¯«å…¥é›²ç«¯é…ç½®ï¼Œæ”¹ç”¨æœ¬åœ°å‚™æ´ã€‚"));
                    state.bodyParts = defaults.bodyParts;
                    state.careerTitles = defaults.careerTitles;
                    state.stories = defaults.stories;
                }
            } catch (err) {
                console.error("Sync Definitions Error:", err);
                // ç™¼ç”Ÿæ¬Šé™éŒ¯èª¤æ™‚ä½¿ç”¨æœ¬åœ°é è¨­å€¼ï¼Œé˜²æ­¢éŠæˆ²å´©æ½°
                state.bodyParts = {
                    face: { name: 'è‡‰éƒ¨', icon: 'ğŸ‘¤', cost: 100, desc: 'ä¸Šå”‡ã€ä¸‹å·´ç²¾ç´°è­·ç†ã€‚' },
                    underarm: { name: 'è…‹ä¸‹', icon: 'âœ¨', cost: 150, desc: 'æƒé™¤é»‘é ­æ²‰ç©ã€‚' },
                    bikini: { name: 'VIO', icon: 'ğŸ‘™', cost: 480, desc: 'æ¥µè‡´è¦ªè†šæº«æŸ”å‘µè­·ã€‚' },
                    limbs: { name: 'å››è‚¢', icon: 'ğŸ¦µ', cost: 220, desc: 'æ‰“é€ å¤§é¢ç©çµ²æ»‘è‚Œã€‚' }
                };
                state.careerTitles = ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«"];
            } finally {
                state.isDefinitionsLoaded = true;
                updateUI();
            }
        }

        async function syncUserData() {
            if (!state.user) return;
            const profileRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'saveData', 'profile');
            onSnapshot(profileRef, (snap) => {
                if (snap.exists()) { 
                    const d = snap.data();
                    state.totalGold = d.totalGold || 0;
                    state.level = d.level || 1;
                    state.careerIndex = d.careerIndex || 0;
                    updateUI(); 
                }
            }, (err) => {
                console.warn("å­˜æª”ç›£è½ç•°å¸¸:", err);
            });
        }

        window.loginGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showMessage("é©—è­‰å¤±æ•—ï¼š"+e.message, true));
        window.loginGuest = () => signInAnonymously(auth);
        window.logout = () => signOut(auth).then(() => window.location.reload());

        function switchView(v) {
            state.view = v;
            ['loading', 'login', 'lobby', 'appointments', 'dialogue', 'selection', 'game'].forEach(id => {
                const el = document.getElementById(`view-${id}`);
                if (el) el.classList.toggle('hidden', state.view !== id);
                if (el) el.classList.toggle('flex', state.view === id);
            });
            if (v === 'game') setTimeout(initCanvas, 100);
            if (v === 'appointments') renderAppointmentList();
            updateUI();
        }

        function renderAppointmentList() {
            const list = document.getElementById('appointment-list');
            if (!list) return;
            list.innerHTML = state.appointments.map(app => `
                <div class="flex items-center justify-between p-5 bg-white/60 rounded-[2.5rem] border border-blue-50 hover:bg-blue-100 hover:scale-[1.02] transition-all cursor-pointer shadow-sm" onclick="window.pickCustomer(${app.id})">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-white rounded-3xl flex items-center justify-center text-2xl shadow-inner border border-blue-50">${app.gender === 'male' ? 'ğŸ‘¦' : 'ğŸ‘§'}</div>
                        <div>
                            <p class="font-black text-slate-700 text-lg">${app.name}</p>
                            <p class="text-[11px] font-bold text-blue-400 uppercase tracking-widest">${app.time} Â· ${state.bodyParts[app.part]?.name || 'å…¨èº«ç™‚ç¨‹'}</p>
                        </div>
                    </div>
                    <span class="text-[10px] font-black px-4 py-2 rounded-full ${app.status === 'READY' ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}">${app.status}</span>
                </div>
            `).join('');
        }

        window.pickCustomer = (id) => {
            state.currentCustomer = state.appointments[id];
            state.selectedGender = state.currentCustomer.gender;
            state.selectedPartId = state.currentCustomer.part;
            state.dialogueStep = 0;
            switchView('dialogue');
            startDialogue();
        };

        function startDialogue() {
            const story = state.stories[Math.floor(Math.random() * state.stories.length)];
            state.currentStory = story;
            const nameEl = document.getElementById('diag-name');
            const textEl = document.getElementById('diag-text');
            if (nameEl) nameEl.innerText = state.currentCustomer.name;
            if (textEl) textEl.innerText = story.text;
            renderAvatar(state.currentCustomer.gender, 'diag-avatar-box');
            
            const optionsBox = document.getElementById('diag-options');
            if (optionsBox) {
                optionsBox.innerHTML = story.options.map((opt, i) => `
                    <button onclick="window.chooseOption(${i})" class="w-full p-4 bg-white/90 rounded-3xl border border-blue-50 font-bold text-blue-600 hover:bg-blue-600 hover:text-white transition-all text-sm mb-3 shadow-sm text-left px-6">
                        <span class="mr-2 text-blue-300">â—</span> ${opt.text}
                    </button>
                `).join('');
            }
        }

        window.chooseOption = (idx) => {
            const opt = state.currentStory.options[idx];
            document.getElementById('diag-text').innerText = opt.response;
            document.getElementById('diag-options').innerHTML = `
                <button onclick="switchView('selection')" class="w-full p-5 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-3xl font-black shadow-xl hover:scale-[1.05] transition-transform">
                    ç¢ºå®šï¼Œé€²å…¥å°ˆæ¥­è©•ä¼°æµç¨‹
                </button>
            `;
        };

        function updateUI() {
            if (!state.isDefinitionsLoaded) return;
            document.querySelectorAll('.gold-val').forEach(el => el.innerText = state.totalGold);
            document.querySelectorAll('.level-val').forEach(el => el.innerText = `Lv.${state.level}`);
            const careerName = state.careerTitles[state.careerIndex] || "ç€…ç™½æ–°äºº";
            document.querySelectorAll('.career-val').forEach(el => el.innerText = careerName);
            document.querySelectorAll('.user-name').forEach(el => el.innerText = state.user?.displayName || "å°ˆå®¶é¡§å•");
            if (state.view === 'selection') renderSelectionUI();
        }

        let canvas, ctx;
        function initCanvas() {
            canvas = document.getElementById('game-canvas');
            if (!canvas) return;
            ctx = canvas.getContext('2d');
            canvas.width = 340; canvas.height = 440;
            canvas.onmousedown = (e) => { 
                state.isCleaning = true; 
                document.getElementById('laser-probe').classList.add('active'); 
                clean(e); 
            };
            canvas.onmousemove = (e) => { if (state.isCleaning) clean(e); };
            window.onmouseup = () => { 
                state.isCleaning = false; 
                document.getElementById('laser-probe').classList.remove('active'); 
                checkProgress(); 
            };
            drawSkin();
        }

        function clean(e) {
            const r = canvas.getBoundingClientRect();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath(); ctx.arc(e.clientX - r.left, e.clientY - r.top, 25, 0, Math.PI * 2); ctx.fill();
        }

        function drawSkin() {
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = state.selectedGender === 'male' ? '#f4d1c1' : '#fff0f0';
            ctx.fillRect(0, 0, 340, 440);
            ctx.strokeStyle = "#4a3a2a"; ctx.lineWidth = 0.8;
            for (let i = 0; i < 2800; i++) {
                const x = Math.random()*340; const y = Math.random()*440;
                ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + (Math.random()-0.5)*2, y + 6); ctx.stroke();
            }
        }

        function checkProgress() {
            const data = ctx.getImageData(0,0,340,440).data;
            let opaque = 0;
            for (let i=3; i<data.length; i+=4) if(data[i]>0) opaque++;
            const progress = 1 - (opaque / (340*440));
            document.getElementById('prog-bar').style.width = `${progress * 100}%`;
            if (progress > 0.98) finishSession();
        }

        async function finishSession() {
            const part = state.bodyParts[state.selectedPartId] || { cost: 50 };
            let reward = part.cost;
            if (state.selectedGender === 'male') reward *= 1.2;
            state.totalGold += Math.floor(reward);
            state.exp += 50;
            if (state.exp >= 100) { 
                state.level++; 
                state.exp = 0; 
                state.careerIndex = Math.min(Math.floor(state.level / 2), 19); 
            }
            if (state.user) {
                const profileRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'saveData', 'profile');
                await setDoc(profileRef, { 
                    totalGold: state.totalGold, 
                    level: state.level, 
                    careerIndex: state.careerIndex,
                    exp: state.exp
                }, { merge: true });
            }
            document.getElementById('reward-val').innerText = Math.floor(reward);
            document.getElementById('result-modal').style.display = 'flex';
        }

        function renderSelectionUI() {
            const p = state.bodyParts[state.selectedPartId] || { name: 'æœªçŸ¥éƒ¨ä½', icon: 'â“', desc: 'ç›®å‰æ­£åœ¨è¼‰å…¥æ•¸æ“š...', cost: 0 };
            const detail = document.getElementById('selection-detail');
            if (detail) {
                detail.innerHTML = `
                    <div class="p-8 bg-blue-50/70 rounded-[3rem] border border-blue-100 shadow-inner">
                        <div class="flex items-center gap-4 mb-3">
                            <span class="text-4xl">${p.icon}</span>
                            <h3 class="text-2xl font-black text-blue-600">${p.name}</h3>
                        </div>
                        <p class="text-sm text-slate-500 font-medium leading-relaxed mb-6">${p.desc}</p>
                        <div class="mt-4 flex justify-between items-center border-t border-blue-100 pt-5">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Session Reward</span>
                            <span class="text-2xl font-black text-blue-800 font-mono">ğŸ’° ${p.cost}</span>
                        </div>
                    </div>
                `;
            }
            document.querySelectorAll('.hotspot').forEach(el => el.classList.toggle('active', el.dataset.id === state.selectedPartId));
        }

        window.onload = init;
        window.switchView = switchView;
        window.selectPart = (id) => { state.selectedPartId = id; renderSelectionUI(); };
        window.confirmStart = () => switchView('game');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: #fdfdfe; cursor: none; overflow: hidden; margin: 0; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.6); }
        
        #laser-probe { 
            position: fixed; width: 54px; height: 54px; border: 3px solid #3b82f6; border-radius: 50%; 
            pointer-events: none; z-index: 10000; transform: translate(-50%, -50%); 
            background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); 
            transition: transform 0.1s ease-out; 
        }
        #laser-probe.active { 
            transform: translate(-50%, -50%) scale(0.8); 
            background: rgba(59, 130, 246, 0.6); 
            box-shadow: 0 0 40px #3b82f6; 
        }
        #laser-probe::after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: white; border-radius: 50%; transform: translate(-50%, -50%); }
        
        .brand-btn { background: linear-gradient(135deg, #a5f3fc 0%, #e0f2fe 100%); color: #0369a1; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .brand-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(186, 230, 253, 0.5); }
        
        .hotspot { fill: #f8fafc; stroke: #e2e8f0; cursor: pointer; transition: 0.3s; }
        .hotspot:hover { fill: #dcfce7; }
        .hotspot.active { fill: #3b82f6; stroke: #1d4ed8; stroke-width: 2.5; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5)); }
        
        canvas { border-radius: 4.5rem; border: 12px solid white; box-shadow: 0 30px 70px rgba(186, 230, 253, 0.2); background: white; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <div id="laser-probe"></div>

    <div id="message-box" class="hidden fixed top-10 left-1/2 -translate-x-1/2 z-[20000] px-8 py-4 rounded-3xl text-white font-bold shadow-2xl items-center justify-center transition-all animate-bounce">
        <span id="message-content"></span>
    </div>

    <div onclick="window.toggleMusic()" class="fixed bottom-6 right-6 z-[1000] w-14 h-14 glass rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:scale-110 transition-transform border border-blue-50">
        <span id="music-icon" class="text-2xl">ğŸ”‡</span>
    </div>

    <div class="fixed top-6 w-full max-w-md px-6 flex justify-between items-center z-[100]">
        <div class="glass px-6 py-3 rounded-full flex items-center gap-3 shadow-lg border-blue-50">
            <span class="text-2xl">ğŸ’°</span>
            <span class="gold-val font-black text-slate-700 text-lg">0</span>
        </div>
        <div class="glass px-7 py-3 rounded-full flex flex-col items-center shadow-lg border-blue-50">
            <span class="career-val text-[11px] font-black text-blue-600 uppercase tracking-tighter text-center">æ­£åœ¨èªè­‰...</span>
            <span class="level-val text-[10px] font-bold text-slate-400">Loading</span>
        </div>
    </div>

    <!-- 0. Loading View -->
    <div id="view-loading" class="flex flex-col items-center">
        <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mb-8"></div>
        <p class="text-slate-400 font-black text-sm tracking-[0.4em] uppercase text-center leading-relaxed">Pure Skin Evolution<br><span class="text-blue-300 mt-2 block text-xs">æ­£åœ¨å»ºç«‹é›²ç«¯å®‰å…¨é€£ç·š</span></p>
    </div>

    <!-- 1. Login View -->
    <div id="view-login" class="hidden flex flex-col items-center">
        <div class="w-28 h-28 bg-white rounded-[3rem] flex items-center justify-center mb-12 shadow-xl border border-blue-50"><span class="text-7xl text-blue-300">ğŸ§Š</span></div>
        <h1 class="text-5xl font-black text-slate-800 mb-2 tracking-tighter">ç€…ç™½ä¹‹å¢ƒ</h1>
        <p class="text-slate-400 text-xs mb-12 font-black tracking-[0.3em] uppercase">Identity Center</p>
        <div class="space-y-4 w-72 flex flex-col items-center">
            <button onclick="window.loginGoogle()" class="w-full py-5 bg-white border border-slate-100 rounded-3xl flex items-center justify-center gap-4 shadow-sm hover:bg-blue-50 hover:scale-[1.03] transition-all"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="22"><span class="font-black text-slate-600">Google å¿«é€Ÿç™»å…¥</span></button>
            <button onclick="window.loginGuest()" class="w-full py-5 bg-blue-50 text-blue-600 font-black rounded-3xl hover:bg-blue-100 transition-all">è¨ªå®¢è©¦ç©æ¨¡å¼</button>
            <p class="text-[10px] text-slate-400 mt-4 text-center px-4 leading-relaxed">â€» è¨ªå®¢æ¨¡å¼åƒ…ä¾›å–®æ¬¡é«”é©—ï¼Œç„¡æ³•è·¨è£ç½®åŒæ­¥æ‚¨çš„ç¾å­¸é€²åº¦</p>
        </div>
    </div>

    <!-- 2. Lobby View -->
    <div id="view-lobby" class="hidden flex flex-col items-center">
        <div class="w-36 h-36 bg-white rounded-[4rem] flex items-center justify-center mb-12 shadow-2xl border-4 border-blue-50 rotate-3 transition-transform hover:rotate-0 duration-500"><span class="text-7xl">ğŸ’</span></div>
        <h1 class="text-6xl font-black text-slate-800 tracking-tighter mb-1">ç€…ç™½ä¹‹å¢ƒ</h1>
        <p class="text-blue-400 font-black tracking-[0.5em] text-xs uppercase mb-12 italic">Pure Skin Evolution</p>
        <div class="glass p-8 rounded-[3rem] mb-12 text-center min-w-[280px] border-blue-100/50 shadow-inner">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">ç•¶å‰èªè­‰å°ˆå®¶</p>
            <p class="user-name font-black text-slate-700 text-2xl italic truncate max-w-[220px]">---</p>
        </div>
        <button onclick="switchView('appointments')" class="w-80 py-7 brand-btn text-3xl rounded-[2.5rem] shadow-2xl hover:scale-105 active:scale-95">é–‹å•Ÿé ç´„ç®¡ç†</button>
        <button onclick="window.logout()" class="mt-8 text-slate-300 font-bold text-sm hover:text-red-400 transition-colors uppercase tracking-widest">Logout System</button>
    </div>

    <!-- 2.5 Appointments List View -->
    <div id="view-appointments" class="hidden flex-col items-center w-full max-w-lg p-6">
        <div class="glass w-full p-10 rounded-[4.5rem] shadow-2xl border border-blue-50">
            <div class="flex items-end justify-between mb-8">
                <h2 class="text-3xl font-black text-slate-800 tracking-tighter underline decoration-blue-200 decoration-4">ä»Šæ—¥é ç´„è¡¨</h2>
                <span class="text-[10px] font-black text-blue-300 uppercase tracking-[0.2em] mb-1">Today's Schedule</span>
            </div>
            <div id="appointment-list" class="space-y-4 max-h-[450px] overflow-y-auto pr-4 custom-scrollbar">
                <!-- ç”± JS ç”Ÿæˆåˆ—è¡¨ -->
            </div>
            <button onclick="switchView('lobby')" class="w-full mt-10 py-5 text-slate-400 font-black text-sm uppercase tracking-widest border-t border-blue-50 pt-8 hover:text-blue-400 transition-colors">è¿”å›æ²™é¾å¤§å»³</button>
        </div>
    </div>

    <!-- 3. Dialogue View -->
    <div id="view-dialogue" class="hidden fixed inset-0 flex flex-col items-center justify-end p-10 bg-slate-900/10 backdrop-blur-sm">
        <div class="glass w-full max-w-2xl p-12 rounded-[5rem] shadow-2xl flex items-start gap-12 border-blue-50 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-8 opacity-5 text-8xl pointer-events-none">"</div>
            <div id="diag-avatar-box" class="w-36 h-36 bg-gradient-to-br from-white to-blue-50 rounded-[3rem] flex-shrink-0 border border-blue-50 p-3 shadow-inner"></div>
            <div class="flex-1">
                <h4 id="diag-name" class="font-black text-blue-500 text-xl mb-2 italic tracking-[0.2em] underline decoration-blue-100 decoration-4">é¡§å®¢</h4>
                <p id="diag-text" class="text-slate-700 font-bold leading-relaxed text-2xl min-h-[4em] mb-10">...</p>
                <div id="diag-options" class="flex flex-col">
                    <!-- ç”± JS ç”Ÿæˆé¸é … -->
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Selection View -->
    <div id="view-selection" class="hidden flex-col items-center w-full max-w-5xl px-4">
        <div class="glass p-16 rounded-[6rem] flex flex-col md:flex-row gap-20 items-center shadow-2xl border-blue-50">
            <div class="w-72 h-[550px]">
                <svg viewBox="0 0 200 500" class="w-full h-full drop-shadow-2xl">
                    <circle cx="100" cy="55" r="45" class="hotspot" data-id="face" onclick="selectPart('face')" />
                    <circle cx="55" cy="125" r="28" class="hotspot" data-id="underarm" onclick="selectPart('underarm')" />
                    <circle cx="145" cy="125" r="28" class="hotspot" data-id="underarm" onclick="selectPart('underarm')" />
                    <rect x="75" y="160" width="50" height="120" rx="25" class="hotspot" data-id="others" onclick="selectPart('others')" />
                    <path d="M75 285 L125 285 L100 340 Z" class="hotspot" data-id="bikini" onclick="selectPart('bikini')" />
                    <rect x="25" y="130" width="24" height="185" rx="12" class="hotspot" data-id="limbs" onclick="selectPart('limbs')" />
                    <rect x="150" y="130" width="24" height="185" rx="12" class="hotspot" data-id="limbs" onclick="selectPart('limbs')" />
                    <rect x="70" y="345" width="28" height="200" rx="14" class="hotspot" data-id="limbs" onclick="selectPart('limbs')" />
                    <rect x="102" y="345" width="28" height="200" rx="14" class="hotspot" data-id="limbs" onclick="selectPart('limbs')" />
                </svg>
            </div>
            <div class="w-full max-w-md space-y-10">
                <h3 class="text-5xl font-black text-slate-800 tracking-tighter italic">å®šåˆ¶ç™‚ç¨‹è©•ä¼°</h3>
                <div id="selection-detail"></div>
                <div class="space-y-4">
                    <button onclick="confirmStart()" class="w-full py-7 brand-btn text-3xl rounded-[3rem] shadow-xl hover:scale-105">å•Ÿå‹•é›·å°„å„€å™¨</button>
                    <button onclick="switchView('appointments')" class="w-full text-slate-400 font-black text-sm tracking-[0.3em] uppercase hover:text-blue-400 transition-colors">é‡æ–°æª¢è¦–é ç´„è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Game View -->
    <div id="view-game" class="hidden flex flex-col items-center">
        <div class="mb-12 w-96 text-center">
            <div class="w-full h-5 bg-white rounded-full overflow-hidden shadow-inner border-4 border-blue-50">
                <div id="prog-bar" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p class="text-[11px] font-black text-blue-500 mt-4 uppercase tracking-[0.5em] animate-pulse">Laser Protocol: Cleaning In Progress</p>
        </div>
        <canvas id="game-canvas" class="cursor-none"></canvas>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="hidden fixed inset-0 z-[200] items-center justify-center bg-blue-900/60 backdrop-blur-xl px-4">
        <div class="bg-white rounded-[6rem] p-20 text-center shadow-2xl max-w-md w-full border-4 border-blue-50 relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-40 h-40 bg-blue-50 rounded-full opacity-50 blur-3xl"></div>
            <div class="text-9xl mb-12">ğŸ§Š</div>
            <h3 class="text-5xl font-black text-slate-800 mb-4 tracking-tighter">æ¥µè‡´ç€…ç™½ï¼</h3>
            <p class="text-slate-400 font-bold mb-12 leading-relaxed text-lg px-6">æœ¬æ¬¡ç™‚ç¨‹åœ“æ»¿å®Œæˆï¼Œæ‚¨çš„å°ˆæ¥­æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯ç¾å­¸ä¸­å¿ƒã€‚</p>
            <div class="bg-blue-50 p-8 rounded-[3.5rem] border border-blue-100 flex justify-between items-center mb-14 shadow-inner">
                <span class="font-black text-slate-500 uppercase tracking-widest text-xs">Settled Bonus</span>
                <span class="font-black text-blue-600 text-5xl tracking-tighter font-mono">ğŸ’° <span id="reward-val">0</span></span>
            </div>
            <button onclick="location.reload()" class="w-full py-7 brand-btn text-2xl rounded-[3rem] shadow-xl hover:scale-105 transition-transform font-black">æ¥å¾…ä¸‹ä¸€ä½é ç´„</button>
        </div>
    </div>

</body>
</html>
