<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç€…ç™½ä¹‹å¢ƒ Pure Skin V5.12 - ç¶“ç‡Ÿå¤§å¸«</title>
    <!-- å¼•å…¥ç³»çµ±è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pure: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8',
                            500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'marketing-radar': 'marketingRadar 2s infinite cubic-bezier(0, 0, 0.2, 1)',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        marketingRadar: { '0%': { transform: 'scale(1)', opacity: '0.8' }, '100%': { transform: 'scale(2.5)', opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #f0f9ff; }
        ::-webkit-scrollbar-thumb { background: #bae6fd; border-radius: 10px; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 12px 45px -10px rgba(31, 38, 135, 0.08);
        }
        
        .chart-container { position: relative; width: 100%; height: 240px; margin: 0 auto; }

        /* NPC Elsa V5.12 (ä¾åŸåœ–ç²¾ç·»é‡ç¹ª) */
        .elsa-container { position: relative; width: 140px; height: 300px; transform: scale(0.85); margin-bottom: -40px; }
        .elsa-hair {
            position: absolute; top: 5px; left: 15px; width: 110px; height: 130px;
            background: linear-gradient(135deg, #eecda3 0%, #c19b6e 100%);
            border-radius: 55px 55px 25px 25px; z-index: 1;
        }
        .elsa-head {
            position: absolute; top: 15px; left: 30px; width: 80px; height: 95px;
            background: #ffe4e6; border-radius: 40px 40px 45px 45px; z-index: 10;
        }
        .elsa-glasses {
            position: absolute; top: 40px; left: 0px; width: 80px; height: 30px; z-index: 15;
            display: flex; gap: 3px; justify-content: center;
        }
        .glass-frame { width: 32px; height: 32px; border: 2px solid #1e293b; border-radius: 50%; background: rgba(255,255,255,0.1); }
        .elsa-eye-dot { position: absolute; top: 52px; width: 8px; height: 8px; background: #0f172a; border-radius: 50%; z-index: 16; }
        .elsa-mouth { position: absolute; bottom: 12px; left: 32px; width: 16px; height: 4px; background: #fb7185; border-radius: 2px; z-index: 11; }
        .elsa-labcoat {
            position: absolute; top: 105px; left: 15px; width: 110px; height: 180px;
            background: #ffffff; border-radius: 15px; z-index: 5; border: 1px solid #e2e8f0;
        }
        .elsa-stethoscope {
            position: absolute; top: 110px; left: 25px; width: 90px; height: 70px;
            border: 3px solid #3b82f6; border-top: none; border-radius: 0 0 45px 45px; z-index: 12;
        }

        /* è„ˆè¡é›·é”å‹•ç•« */
        .marketing-pulse-wrapper {
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
        }
        .radar-circle {
            position: absolute; width: 40px; height: 40px; background: rgba(14, 165, 233, 0.4); border-radius: 50%; pointer-events: none;
        }

        /* æ™‚åˆ»è¡¨æ¨£å¼ */
        .calendar-table { width: 100%; border-collapse: separate; border-spacing: 4px; table-layout: fixed; }
        .calendar-table th { padding: 8px; background: #f8fafc; border-radius: 8px; font-size: 0.6rem; color: #64748b; text-align: center; }
        .calendar-cell { 
            height: 65px; background: rgba(241, 245, 249, 0.5); border-radius: 12px;
            transition: 0.3s; cursor: pointer; border: 1px solid transparent; position: relative;
        }
        .calendar-cell.occupied-male { background: #eff6ff; border-color: #3b82f6; }
        .calendar-cell.occupied-female { background: #fff1f2; border-color: #f43f5e; }
        .calendar-cell.empty { border: 1px dashed #e2e8f0; }
        .calendar-cell.marketing-active { background: #f0f9ff; border: 2px solid #0ea5e9; }
        .calendar-cell.overdue { background: #fef2f2; border-color: #ef4444; opacity: 0.8; }

        .tutor-bubble { position: absolute; z-index: 10000; transition: all 0.5s; display: none; pointer-events: none; }
        .bubble-content { background: white; border: 3px solid #bae6fd; border-radius: 2rem; padding: 1.5rem; width: 280px; pointer-events: auto; position: relative; }
        .bubble-content::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-left: 3px solid #bae6fd; border-bottom: 3px solid #bae6fd; }
        .bubble-top .bubble-content::after { bottom: -12px; left: 50%; transform: translateX(-50%) rotate(-45deg); }

        #laser-cursor { position: fixed; width: 40px; height: 40px; border: 3px solid #0ea5e9; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; display: none; box-shadow: 0 0 15px rgba(14, 165, 233, 0.6); }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-pure-50 text-slate-700 min-h-screen font-sans selection:bg-pure-200 overflow-x-hidden">

    <div id="laser-cursor"></div>

    <!-- å°å¸« Elsa æ•™å­¸çµ„ä»¶ -->
    <div id="tutor-anchor" class="fixed z-[10000] bottom-10 right-10 flex flex-col items-center gap-2 transition-all duration-500" style="display: none;">
        <div class="elsa-container animate-float">
            <div class="elsa-hair"></div>
            <div class="elsa-head">
                <div class="elsa-glasses"><div class="glass-frame"></div><div class="glass-frame"></div></div>
                <div class="elsa-eye-dot" style="left:16px;"></div><div class="elsa-eye-dot" style="right:16px;"></div>
                <div class="elsa-mouth"></div>
            </div>
            <div class="elsa-labcoat"></div>
            <div class="elsa-stethoscope"></div>
        </div>
        <div class="bubble-content shadow-2xl glass-panel p-6 rounded-[2rem] border-pure-200">
            <p id="tutor-text" class="text-slate-700 font-black leading-relaxed text-sm"></p>
            <button id="tutor-next-btn" onclick="app.tutorial.next()" class="mt-4 w-full py-2 bg-pure-600 text-white rounded-xl text-xs font-black hover:bg-pure-700 transition-all shadow-lg">ç¹¼çºŒ Next â¯</button>
        </div>
    </div>

    <!-- å…¨åŸŸé€šçŸ¥ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[20000] transition-all duration-500 transform -translate-y-24 opacity-0 flex items-center gap-3 px-8 py-4 rounded-3xl shadow-2xl bg-white/95 backdrop-blur-md border border-pure-100">
        <i id="toast-icon" class="fa-solid fa-circle-check text-green-500"></i>
        <span id="toast-text" class="font-black text-slate-700 text-sm"></span>
    </div>

    <!-- ç²¾ç°¡æ™‚é˜é¢æ¿ -->
    <div class="fixed bottom-6 left-6 z-[150] glass-panel px-4 py-2 rounded-2xl flex items-center gap-4 shadow-xl border-pure-100 animate-fade-in pointer-events-none">
        <div class="flex flex-col items-start leading-none">
            <span id="game-date" class="font-black text-slate-400 text-[9px] uppercase tracking-tighter mb-0.5">DAY 1</span>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-clock text-pure-500 text-xs"></i>
                <span id="game-clock" class="font-black text-slate-800 text-lg font-mono italic">10:00 AM</span>
            </div>
        </div>
    </div>

    <main id="app-root" class="w-full min-h-screen flex flex-col items-center justify-center relative overflow-hidden">
        
        <!-- èƒŒæ™¯è£é£¾ -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div class="absolute top-[-10%] left-[-15%] w-[60vw] h-[60vw] bg-pure-200/30 rounded-full filter blur-[120px] animate-pulse-slow"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[55vw] h-[55vw] bg-pink-100/30 rounded-full filter blur-[120px] animate-pulse-slow"></div>
        </div>

        <!-- 0. è¼‰å…¥è¦–åœ– -->
        <section id="view-loading" class="flex flex-col items-center gap-6 text-center transition-all duration-500">
            <div class="w-20 h-20 border-4 border-pure-100 border-t-pure-500 rounded-full animate-spin"></div>
            <h1 class="text-4xl font-black tracking-tighter text-slate-800 mb-2 italic">ç€…ç™½ä¹‹å¢ƒ</h1>
            <p id="loading-status" class="text-xs font-bold text-pure-500 tracking-[0.6em] animate-pulse uppercase">ç™»å…¥ä¸­...</p>
        </section>

        <!-- 1. èªè­‰ä¸­å¿ƒ -->
        <section id="view-login" class="hidden w-full max-w-md px-6 animate-float">
            <div class="glass-panel p-10 rounded-[3.5rem] text-center shadow-2xl">
                <div class="w-24 h-24 bg-pure-50 rounded-3xl mx-auto flex items-center justify-center mb-8 text-4xl text-pure-600 shadow-inner"><i class="fa-solid fa-crown"></i></div>
                <h2 class="text-4xl font-black mb-2 text-slate-800 tracking-tight italic">ç¾å­¸æ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-400 text-[10px] font-black tracking-[0.3em] uppercase mb-10">Real-Name Verification</p>
                <div class="space-y-4">
                    <button onclick="app.auth.loginGoogle()" class="w-full py-5 bg-white border border-slate-100 rounded-3xl flex items-center justify-center gap-4 shadow-sm hover:bg-blue-50 transition-all font-black text-slate-600 text-lg">
                        <i class="fa-brands fa-google text-lg text-pure-600"></i> Google å¿«é€Ÿèªè­‰
                    </button>
                    <button onclick="app.auth.loginGameCenter()" class="w-full py-5 bg-slate-900 text-white rounded-3xl flex items-center justify-center gap-4 shadow-xl hover:bg-black transition-transform">
                        <i class="fa-brands fa-apple text-xl"></i> Game Center ç™»å…¥
                    </button>
                </div>
                <p class="mt-10 text-[11px] text-slate-400 font-bold tracking-widest italic animate-pulse">è«‹ç™»å…¥ä¸¦é–‹å§‹éŠæˆ²</p>
            </div>
        </section>

        <!-- 1.2 å‘½åè¦–åœ– -->
        <section id="view-naming" class="hidden w-full max-w-md px-6">
            <div class="glass-panel p-12 rounded-[3.5rem] text-center shadow-2xl animate-slide-up">
                <h2 class="text-3xl font-black text-slate-800 mb-10 italic tracking-tighter">è«‹è¨­å®šéŠæˆ²ä¸­åç¨±</h2>
                <input id="input-player-name" type="text" maxlength="8" class="w-full p-6 rounded-3xl bg-pure-50 border-4 border-pure-100 focus:border-pure-400 outline-none text-center font-black text-2xl mb-12 shadow-inner">
                <button onclick="app.auth.confirmName()" class="w-full py-5 bg-pure-600 text-white font-black rounded-2xl shadow-xl hover:scale-105 transition-all text-xl italic">ç¢ºèªèº«ä»½ â¯</button>
            </div>
        </section>

        <!-- 1.3 å‘½åç¢ºèª -->
        <div id="modal-name-confirm" class="hidden fixed inset-0 z-[12000] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
            <div class="glass-panel max-w-sm w-full p-8 rounded-[3rem] text-center shadow-2xl animate-slide-up">
                <h3 class="text-xl font-black text-slate-800 mb-4 italic">æœ€çµ‚ç¢ºèª</h3>
                <p class="text-slate-500 mb-8 font-bold text-sm">ç¢ºå®šè¦ä»¥ã€<span id="display-confirm-name" class="text-pure-600"></span>ã€ä¹‹åå±•é–‹è·æ¶¯å—ï¼Ÿ</p>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('modal-name-confirm').classList.add('hidden')" class="flex-1 py-4 bg-slate-100 text-slate-400 font-black rounded-2xl">ä¿®æ”¹</button>
                    <button onclick="app.auth.submitName()" class="flex-1 py-4 bg-pure-600 text-white font-black rounded-2xl shadow-lg">é€™å°±æ˜¯æˆ‘ â¯</button>
                </div>
            </div>
        </div>

        <!-- 1.5 æ­¡è¿èˆ‡å°è¦½å•Ÿå‹•è¦–åœ– (V5.12 ä¿®å¾©é—œéµé») -->
        <section id="view-welcome" class="hidden w-full max-w-2xl px-6 text-center">
            <div class="glass-panel p-12 rounded-[4.5rem] shadow-2xl border-white border-4 animate-fade-in relative overflow-hidden">
                <div class="absolute -top-10 -left-10 w-40 h-40 bg-pure-50 rounded-full opacity-40"></div>
                <div class="text-9xl mb-10">ğŸ§Š</div>
                <h2 class="text-5xl font-black text-slate-800 mb-6 italic tracking-tighter">æ­¡è¿é–‹å•Ÿæ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-500 font-bold leading-relaxed text-lg mb-12 italic">æ‚¨çš„å°ˆæ¥­æ’ç¨‹èˆ‡æ™ºæ…§æ™‚åˆ»è¡¨å·²æº–å‚™å°±ç·’ã€‚<br>æº–å‚™å¥½æ¥å— Elsa å°å¸«çš„å¼•å°äº†å—ï¼Ÿ</p>
                <button onclick="app.tutorial.start()" class="px-16 py-6 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-2xl rounded-[2rem] shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase tracking-widest">é–‹å§‹å°è¦½ â¯</button>
            </div>
        </section>

        <!-- 2. å¤§å»³ (Dashboard) -->
        <section id="view-lobby" class="hidden w-full max-w-6xl flex flex-col gap-8 px-6">
            <header id="frame-profile" class="flex flex-col md:flex-row justify-between items-center glass-panel p-8 rounded-[3rem] gap-6 animate-slide-up shadow-xl border-blue-50">
                <div class="flex items-center gap-8">
                    <div class="w-16 h-16 bg-gradient-to-tr from-pure-500 to-cyan-400 rounded-2xl flex items-center justify-center text-white shadow-xl"><i class="fa-solid fa-gem text-2xl"></i></div>
                    <div>
                        <h3 class="text-3xl font-black text-slate-800 italic" id="user-display-name">é¡§å•</h3>
                        <p class="text-xs font-bold text-pure-500 uppercase tracking-[0.2em]" id="user-title">-</p>
                    </div>
                </div>
                <div class="flex gap-12 items-center border-l border-slate-100 pl-12">
                    <div class="text-center"><p class="text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest">è³‡ç”¢</p><p class="text-4xl font-black text-slate-800 font-mono italic">ğŸ’° <span id="lobby-gold">0</span></p></div>
                    <div class="text-center"><p class="text-[10px] text-slate-400 font-black uppercase mb-1 tracking-widest">Lv</p><p class="text-4xl font-black text-pure-600 font-mono italic" id="lobby-level">1</p></div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full animate-slide-up">
                <div id="frame-chart" class="lg:col-span-2 glass-panel p-10 rounded-[3.5rem] flex flex-col gap-8 shadow-inner">
                    <div class="flex justify-between items-center">
                        <h4 class="text-2xl font-black text-slate-800 tracking-tighter italic font-mono"><i class="fa-solid fa-chart-line mr-4 text-pure-500"></i>ç¶“ç‡Ÿè¶¨å‹¢åˆ†æ</h4>
                        <button onclick="app.router.go('reports')" class="px-6 py-2 bg-pure-100 text-pure-600 rounded-full font-black text-[10px] hover:bg-pure-200 shadow-sm transition-all">æ­·å²å ±è¡¨æŸ¥è©¢</button>
                    </div>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>

                <div class="flex flex-col gap-6">
                    <button id="frame-appt" onclick="app.router.go('appointments')" class="group relative flex-1 bg-gradient-to-br from-pure-600 to-blue-800 text-white p-10 rounded-[3.5rem] shadow-2xl hover:scale-[1.02] transition-all text-left overflow-hidden">
                        <div class="absolute right-[-30px] bottom-[-30px] text-[12rem] text-white opacity-10 group-hover:scale-110 transition-transform"><i class="fa-solid fa-calendar-days"></i></div>
                        <h2 class="text-4xl font-black italic mb-4">é ç´„æ™‚åˆ»è¡¨</h2>
                        <p class="text-sm font-medium opacity-80 leading-relaxed italic">ä¸€é€±è·¨æ—¥æ’ç¨‹çŸ©é™£èˆ‡å¸‚å ´è¡ŒéŠ·ã€‚</p>
                    </button>
                    <div id="frame-settings" class="glass-panel p-8 rounded-[3rem] flex flex-col gap-4 shadow-sm border border-pure-50">
                        <button onclick="app.audio.toggle()" class="flex items-center justify-between w-full p-4 rounded-2xl bg-pure-50 hover:bg-pure-100 transition-colors">
                            <span class="font-bold text-slate-600 italic">éŸ³æ¨‚æ°›åœæ„Ÿ</span>
                            <span id="lobby-music-text" class="text-[10px] font-black text-pure-400 font-mono">OFF</span>
                        </button>
                        <button onclick="app.auth.logout()" class="flex items-center gap-3 text-slate-400 font-bold hover:text-red-500 transition-colors px-4 py-1 text-xs">
                            <i class="fa-solid fa-power-off"></i> ç³»çµ±ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. é ç´„æ™‚åˆ»è¡¨ -->
        <section id="view-appointments" class="hidden w-full max-w-6xl flex flex-col h-[85vh] animate-slide-up px-4">
            <div class="glass-panel p-10 rounded-t-[4rem] flex justify-between items-center z-10 border-b-0 shadow-none">
                <div><h2 class="text-4xl font-black text-slate-800 italic tracking-tighter font-mono">RESERVATIONS</h2><p class="text-xs text-pure-400 font-bold mt-1 uppercase italic tracking-widest font-mono">7-Day Dynamic Matrix</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-2xl bg-pure-50 flex items-center justify-center text-pure-600 hover:bg-pure-100 shadow-inner transition-all"><i class="fa-solid fa-home text-xl"></i></button>
            </div>
            <div class="glass-panel p-6 rounded-b-[4rem] flex-1 overflow-auto custom-scrollbar shadow-2xl" id="calendar-container"></div>
        </section>

        <!-- 4. ç¶“ç‡Ÿå ±è¡¨ä¸­å¿ƒ -->
        <section id="view-reports" class="hidden w-full max-w-5xl flex flex-col h-[85vh] animate-slide-up px-4">
            <div class="glass-panel p-10 rounded-t-[4rem] flex justify-between items-center border-b-0">
                <div><h2 class="text-4xl font-black text-slate-800 italic tracking-tighter font-mono">FINANCE CENTER</h2><p class="text-xs text-pure-400 font-bold mt-1 uppercase italic">Monthly Business Analysis</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-2xl bg-pure-50 flex items-center justify-center shadow-inner transition-all hover:bg-pure-100"><i class="fa-solid fa-arrow-left text-xl text-pure-600"></i></button>
            </div>
            <div class="glass-panel p-10 rounded-b-[4rem] flex-1 overflow-y-auto space-y-8 shadow-2xl custom-scrollbar">
                <div class="flex items-center gap-6 p-6 bg-pure-50 rounded-3xl border border-pure-100 shadow-inner">
                    <div class="flex flex-col"><span class="text-[10px] font-black text-slate-400 uppercase mb-1 italic">Lookup Date</span><input type="date" id="report-date-picker" onchange="app.reports.lookup()" class="bg-white border-2 border-pure-100 p-3 rounded-xl font-bold outline-none focus:border-pure-400"></div>
                    <div class="h-10 w-px bg-slate-200 mx-4"></div>
                    <div class="flex-1 grid grid-cols-2 gap-8">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç•¶æ—¥æ”¶å…¥ (Daily Revenue)</p><p class="text-3xl font-black text-pure-600 font-mono italic">ğŸ’° <span id="report-income">0</span></p></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç•¶æ—¥ä¾†å®¢ (Guest Count)</p><p class="text-3xl font-black text-slate-600 font-mono italic">ğŸ‘¤ <span id="report-guests">0</span></p></div>
                    </div>
                </div>
                <div class="p-8 border-2 border-pure-50 rounded-[3rem] bg-white/50 shadow-inner">
                    <h5 class="text-lg font-black text-slate-700 mb-6 italic underline decoration-pure-200">ç•¶æœˆä»½æ¯æ—¥æ”¶å…¥è¶¨å‹¢åˆ†æ</h5>
                    <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- 5. çµæŸç‡Ÿæ¥­çµç®— Modal -->
        <div id="modal-closing" class="hidden fixed inset-0 z-[15000] bg-slate-950/80 backdrop-blur-xl flex items-center justify-center p-6">
            <div class="glass-panel max-w-md w-full p-12 rounded-[4rem] text-center shadow-2xl animate-slide-up border-white border-4 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-50 rounded-full opacity-30"></div>
                <div class="text-7xl mb-8">ğŸŒ™</div>
                <h2 class="text-4xl font-black text-slate-800 mb-2 italic tracking-tighter">ç‡Ÿæ¥­çµæŸ</h2>
                <p class="text-slate-400 font-bold mb-10 text-sm tracking-widest uppercase italic" id="closing-day-label">Day 1 ç¶“ç‡Ÿçµç®—å ±å‘Š</p>
                <div class="grid grid-cols-2 gap-4 mb-10">
                    <div class="bg-pure-50 p-6 rounded-3xl shadow-inner border border-pure-100">
                        <span class="text-[9px] font-black text-slate-400 uppercase block mb-1">ä»Šæ—¥ç¸½æ”¶å…¥</span>
                        <span class="text-2xl font-black text-pure-600 font-mono italic">ğŸ’° <span id="closing-income">0</span></span>
                    </div>
                    <div class="bg-pure-50 p-6 rounded-3xl shadow-inner border border-pure-100">
                        <span class="text-[9px] font-black text-slate-400 uppercase block mb-1">æœå‹™è²´è³“æ•¸</span>
                        <span class="text-2xl font-black text-pure-600 font-mono italic">ğŸ‘¤ <span id="closing-guests">0</span></span>
                    </div>
                </div>
                <button onclick="app.timer.startNextDay()" class="w-full py-5 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-xl rounded-2xl shadow-xl hover:scale-105 active:scale-95 transition-all italic tracking-widest uppercase shadow-blue-200">Start Next Day â¯</button>
            </div>
        </div>

        <!-- RPG è«®è©¢ã€è¡ŒéŠ·èˆ‡é™¤æ¯›äº’å‹•è¦–åœ– (ç•¥ä½œç°¡åŒ–ä»¥ç¶­æŒæµæš¢) -->
        <div id="modal-marketing" class="hidden fixed inset-0 z-[11000] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
            <div class="glass-panel max-w-xl w-full p-10 rounded-[4rem] shadow-2xl animate-slide-up border border-pure-100">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-2xl font-black text-slate-800 italic font-mono tracking-tighter">MARKETING</h3>
                    <button onclick="document.getElementById('modal-marketing').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-4" id="marketing-list"></div>
            </div>
        </div>

        <section id="view-dialogue" class="hidden w-full max-w-2xl px-6">
            <div class="glass-panel p-12 rounded-[5rem] text-center relative overflow-hidden shadow-2xl border-white border-4 animate-slide-up">
                <div id="customer-avatar-box" class="mb-10 animate-float flex justify-center items-center h-32"></div>
                <div class="bg-blue-50/50 p-8 rounded-[3rem] border border-pure-100 mb-8 text-left shadow-inner"><h3 class="font-black text-pure-600 text-xl mb-3 italic tracking-widest" id="diag-name">è²´è³“è«®è©¢</h3><p id="diag-text" class="text-slate-700 font-bold leading-relaxed text-2xl italic min-h-[4em]">...</p></div>
                <div id="diag-options" class="flex flex-col gap-4"></div>
            </div>
        </section>

        <section id="view-game" class="hidden w-full max-w-md flex flex-col items-center gap-10">
            <div class="w-full glass-panel p-6 rounded-full flex items-center gap-8 shadow-2xl border-white border-[6px]">
                <div class="flex-1 bg-slate-100 h-6 rounded-full overflow-hidden relative shadow-inner"><div id="prog-bar" class="h-full bg-gradient-to-r from-pure-400 to-cyan-500 w-0 transition-all duration-300"></div></div>
                <span id="prog-text" class="text-sm font-black text-pure-700 font-mono italic">0.0%</span>
            </div>
            <div class="relative rounded-[5.5rem] overflow-hidden shadow-2xl border-[16px] border-white ring-2 ring-blue-50/50"><canvas id="game-canvas" class="bg-pure-50 cursor-none touch-none"></canvas></div>
            <p class="text-pure-500 text-xs font-bold mt-3 animate-pulse italic uppercase tracking-[0.2em] font-mono">Laser Protocol: Active</p>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, OAuthProvider, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- V5.12 æ ¸å¿ƒä¿®æ­£ï¼šç¡¬æ ¸æ³¨å…¥ SDK é…ç½®ï¼Œç§»é™¤ç’°å¢ƒè®Šæ•¸ä¾è³´ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIKSbaZ5R6RTSRcH_-YYfqz_OnQQFr1gc",
            authDomain: "pure-skin-8640d.firebaseapp.com",
            projectId: "pure-skin-8640d",
            storageBucket: "pure-skin-8640d.firebasestorage.app",
            messagingSenderId: "890613609117",
            appId: "1:890613609117:web:ed044e453e6cc789b01a74",
            measurementId: "G-27E3XSTTBH"
        };
        const appId = 'pure-skin-studio-master';
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // --- å¸¸é‡å®šç¾© ---
        const CAREERS = ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«", "é¦–å¸­æŠ€è¡“å®˜", "é†«ç¾é¡§å•", "é›·å°„ç‰©ç†å°ˆå®¶", "çš®è†šè‡¨åºŠé†«ç”Ÿ", "æŠ—è€ç ”ç©¶å“¡", "ç”Ÿç‰©çº–ç¶­å°ˆå®¶", "é†«å­¸ç¾å®¹é™¢é•·", "å©šç¦®é€ å‹å¸«", "æ™‚å°šé›œèªŒé¡§å•", "å¥½èŠå¡¢ç‰¹æ•ˆè­·ç†", "æ˜æ˜Ÿå¾¡ç”¨å¤§å¸«", "äººé«”ç¾å­¸å®¶", "æ²™é¾åº—é•·", "å“ç‰Œç¶“ç†", "é€£é–åº—å‰µå§‹äºº", "ç¾å®¹é›†åœ˜ CEO", "å…¨çƒç¾å­¸æ•™çˆ¶"];
        const TW_NAMES = Array.from({length: 300}, (_, i) => ["é™³", "æ", "ç‹", "å¼µ", "åŠ‰", "é»ƒ", "æ—", "éƒ­", "å¾", "å³"][i % 10] + ["å­è±ª", "é›…é›¯", "ç¾ç²", "æ‰¿ç¿°", "é›¨æŸ”", "æ¬£å„€", "å»ºå®", "å˜‰æ¬£", "å®—ä½‘", "å¿—æ˜", "æ˜¥å¬Œ", "å‡±ç‰¹", "å­è»’", "ä½©çŠ", "å®œåº­"][Math.floor(Math.random()*15)]);
        const MARKETING_METHODS = [ { name: "ç¤¾ç¾¤æ¨æ’­", cost: 300, power: 0.15 }, { name: "å€åŸŸç°¡è¨Š", cost: 200, power: 0.1 }, { name: "ç¶²ç´…é–‹ç®±", cost: 1200, power: 0.4 }, { name: "æ·é‹ç‡ˆç®±", cost: 2000, power: 0.6 }, { name: "é›œèªŒå°ˆè¨ª", cost: 3500, power: 0.8 }, { name: "é›»è¦–å»£å‘Š", cost: 6000, power: 1.2 } ];
        const BODY_PARTS = { face: 'è‡‰éƒ¨ç²¾é›•', underarm: 'è…‹ä¸‹æ·¨ç™½', bikini: 'VIOç§å¯†', limbs: 'å››è‚¢çµ²æ»‘', back: 'èƒŒéƒ¨ç¾å­¸' };
        const FEEDBACKS = Array.from({length: 80}, (_, i) => `å¥½è©•åº¦ #${i+1}ï¼šé€™æ˜¯ç›®å‰è¦‹éæœ€å°ˆæ¥­çš„ç€…ç™½æŠ€è¡“ã€‚`);

        const App = {
            state: {
                user: null, data: { gold: 3000, level: 1, exp: 0, history: [], dailyLog: {}, isNewPlayer: true, appointments: {}, marketingSlots: {}, playerName: "", gameHour: 10, gameMinute: 0, gameDay: 1, marketingStrength: 0 },
                view: 'loading', session: null, isAuthResolved: false, tutorialStep: 0, audio: { el: null, muted: true }
            },

            // --- å ±è¡¨æ•¸æ“šæŸ¥è©¢ ---
            reports: {
                lookup: () => {
                    const date = document.getElementById('report-date-picker').value;
                    const log = App.state.data.dailyLog?.[date] || { income: 0, guests: 0 };
                    document.getElementById('report-income').innerText = log.income.toLocaleString();
                    document.getElementById('report-guests').innerText = log.guests;
                },
                renderMonthlyChart: () => {
                    const ctx = document.getElementById('monthlyChart').getContext('2d');
                    const logs = App.state.data.dailyLog || {};
                    const sortedDates = Object.keys(logs).sort().slice(-15);
                    if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();
                    window.monthlyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sortedDates.map(d => d.slice(5)), datasets: [{ label: 'æ¯æ—¥ç‡Ÿæ”¶', data: sortedDates.map(d => logs[d].income), backgroundColor: '#38bdf8', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
                }
            },

            // --- æ™‚é–“æµè½‰å¼•æ“ ---
            timer: {
                lastTick: performance.now(),
                start: () => requestAnimationFrame(App.timer.loop),
                loop: (now) => {
                    const elapsed = now - App.timer.lastTick;
                    if (elapsed > 1000) { App.timer.lastTick = now; App.timer.tick(); }
                    requestAnimationFrame(App.timer.loop);
                },
                tick: async () => {
                    let d = App.state.data;
                    const isVisible = !document.hidden;
                    const gameSecondsToAdd = isVisible ? 6 : (5 * 60) / 3600;
                    d.gameMinute += gameSecondsToAdd / 60;
                    if (d.gameMinute >= 60) {
                        d.gameMinute = 0; d.gameHour++;
                        if (d.gameHour >= 21) { App.timer.performDailySettlement(); return; }
                    }
                    App.ui.updateClock();
                    App.timer.processMarketing(isVisible);
                    if (App.state.view === 'appointments') App.ui.renderTimetable();
                },
                performDailySettlement: async () => {
                    const day = App.state.data.gameDay;
                    let dailyIncome = 0; let dailyGuests = 0;
                    Object.keys(App.state.data.appointments).forEach(sid => {
                        if (sid.startsWith(`${day}-`)) {
                            const appt = App.state.data.appointments[sid];
                            if (appt.status === 'finished') { dailyIncome += 800; dailyGuests++; }
                        }
                    });
                    const dateStr = new Date().toISOString().split('T')[0]; 
                    App.state.data.dailyLog[dateStr] = { income: dailyIncome, guests: dailyGuests };
                    document.getElementById('closing-day-label').innerText = `Day ${day} ç¶“ç‡Ÿçµç®—å ±å‘Š`;
                    document.getElementById('closing-income').innerText = dailyIncome;
                    document.getElementById('closing-guests').innerText = dailyGuests;
                    document.getElementById('modal-closing').classList.remove('hidden');
                    await App.data.save();
                },
                startNextDay: async () => {
                    App.state.data.gameHour = 10; App.state.data.gameMinute = 0; App.state.data.gameDay++;
                    document.getElementById('modal-closing').classList.add('hidden');
                    await App.data.save(); App.router.go('lobby');
                },
                processMarketing: async (isVisible) => {
                    let d = App.state.data;
                    Object.keys(d.marketingSlots || {}).forEach(async (sid) => {
                        if (Math.random() < (isVisible ? 0.03 : 0.0005)) {
                            if (!d.appointments[sid]) {
                                d.appointments[sid] = { name: TW_NAMES[Math.floor(Math.random()*300)], part: 'face', gender: Math.random() > 0.5 ? 'male' : 'female', status: 'pending' };
                                delete d.marketingSlots[sid];
                                App.ui.notify("å¼•æµæˆåŠŸï¼æ–°è²´è³“å·²é ç´„ã€‚");
                                await App.data.save();
                            }
                        }
                    });
                }
            },

            // --- èªè­‰æ ¸å¿ƒ V5.12 (ä¿®å¾©å°è¦½ä¸å•Ÿå‹•å•é¡Œ) ---
            auth: {
                init: async () => {
                    const watchdog = setTimeout(() => { if (!App.state.isAuthResolved && App.state.view === 'loading') App.router.go('login'); }, 3500);
                    onAuthStateChanged(auth, async (user) => {
                        App.state.isAuthResolved = true; clearTimeout(watchdog);
                        if (user && !user.isAnonymous) {
                            App.state.user = user; await App.data.sync(); 
                            if (!App.state.data.playerName) {
                                App.router.go('naming');
                            } else {
                                // ä¿®å¾©é‡é»ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæ–°ç©å®¶ï¼Œæ˜¯å‰‡å°å‘æ­¡è¿é è§¸ç™¼å°è¦½æŒ‰éˆ•
                                if (App.state.data.isNewPlayer && !localStorage.getItem(`tut_done_${user.uid}`)) {
                                    App.router.go('welcome');
                                } else {
                                    App.router.go('lobby');
                                }
                            }
                            App.timer.start();
                        } else {
                            if(user && user.isAnonymous) await signOut(auth);
                            App.router.go('login');
                        }
                    });
                },
                loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => App.ui.notify("ç™»å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²åŸŸæˆæ¬Šã€‚", true)),
                loginGameCenter: () => {
                    const provider = new OAuthProvider('apple.com');
                    signInWithPopup(auth, provider).catch(e => App.ui.notify("ç’°å¢ƒä¸æ”¯æ´ Game Centerã€‚", true));
                },
                confirmName: () => { 
                    const n = document.getElementById('input-player-name').value.trim(); 
                    if(!n) return App.ui.notify("è«‹è¨­å®šä¸€å€‹åç¨±", true);
                    document.getElementById('modal-name-confirm').classList.remove('hidden'); 
                    document.getElementById('display-confirm-name').innerText = n; 
                },
                submitName: async () => { 
                    const n = document.getElementById('input-player-name').value.trim(); 
                    App.state.data.playerName = n; 
                    App.state.data.isNewPlayer = true; // å‰›å‘½åå®Œå¿…å®šæ˜¯æ–°ç©å®¶
                    document.getElementById('modal-name-confirm').classList.add('hidden'); 
                    await App.data.save(); 
                    App.router.go('welcome'); // å°å‘æ­¡è¿é æº–å‚™å°è¦½
                },
                logout: async () => { localStorage.clear(); await signOut(auth); window.location.reload(); }
            },

            // --- å±€éƒ¨æ°£æ³¡å°è¦½ç³»çµ± ---
            tutorial: {
                steps: [
                    { text: "æ‚¨å¥½ï¼æˆ‘æ˜¯ Elsaã€‚å·¦ä¸‹è§’æ˜¯ç‡Ÿé‹æ™‚ç©ºï¼Œè‹¥è·³é›¢è¦–çª—æ™‚é–“æœƒè‡ªå‹•æ¸›é€Ÿä¿è­·æ•¸æ“šã€‚", target: "game-clock" },
                    { text: "é ç´„æ™‚åˆ»è¡¨ç¾åœ¨æ”¹ç‚ºé€±çŸ©é™£æ¨¡å¼ã€‚ç©ºä½å¯é€²è¡Œè¡ŒéŠ·æŠ•æ”¾ï¼Œå±†æ™‚æœƒé¡¯ç¤ºå¼•æµè„ˆè¡ã€‚", target: "frame-appt" },
                    { text: "å°è¦½çµæŸã€‚è«‹é»æ“Šé ç´„é–‹å§‹æ‚¨çš„ç¾å­¸æ•™çˆ¶è·æ¶¯å§ï¼", target: "frame-chart" }
                ],
                start: () => { 
                    App.router.go('lobby'); 
                    App.state.tutorialStep = 0; 
                    document.getElementById('tutor-anchor').style.display = 'flex'; 
                    App.tutorial.render(); 
                },
                next: async () => { 
                    App.state.tutorialStep++; 
                    if (App.state.tutorialStep < App.tutorial.steps.length) {
                        App.tutorial.render(); 
                    } else { 
                        document.getElementById('tutor-anchor').style.display = 'none'; 
                        App.state.data.isNewPlayer = false; 
                        if (App.state.user) localStorage.setItem(`tut_done_${App.state.user.uid}`, 'true'); 
                        await App.data.save(); 
                        App.ui.notify("å¼•å°å®Œæˆï¼Œç¥æ‚¨ç¶“ç‡Ÿé †åˆ©ï¼");
                    } 
                },
                render: () => {
                    const s = App.tutorial.steps[App.state.tutorialStep]; 
                    document.getElementById('tutor-text').innerText = s.text;
                    const a = document.getElementById('tutor-anchor'); 
                    const t = document.getElementById(s.target);
                    if (t) { 
                        const r = t.getBoundingClientRect(); 
                        a.style.bottom = (window.innerHeight - r.top + 20) + 'px'; 
                        a.style.left = (r.left + r.width/2 - 70) + 'px'; 
                        t.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            },

            data: {
                sync: async () => {
                    if (!App.state.user) return;
                    const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile');
                    const snap = await getDoc(userRef);
                    if (snap.exists()) App.state.data = { ...App.state.data, ...snap.data() };
                    else await setDoc(userRef, App.state.data);
                    onSnapshot(userRef, (s) => { if(s.exists()) { App.state.data = { ...App.state.data, ...s.data() }; App.ui.updateLobby(); } });
                },
                save: async () => { if (App.state.user) { const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile'); await setDoc(userRef, App.state.data, { merge: true }); } }
            },

            ui: {
                notify: (m, e) => { const el = document.getElementById('toast'); document.getElementById('toast-text').innerText = m; document.getElementById('toast-icon').className = e ? "fa-solid fa-circle-exclamation text-red-500" : "fa-solid fa-circle-check text-green-500"; el.classList.remove('-translate-y-24', 'opacity-0'); setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000); },
                updateClock: () => { const d = App.state.data; const h = Math.floor(d.gameHour); const m = Math.floor(d.gameMinute); document.getElementById('game-clock').innerText = `${h}:${m < 10 ? '0'+m : m} ${h >= 12 ? 'PM' : 'AM'}`; document.getElementById('game-date').innerText = `DAY ${d.gameDay}`; },
                updateLobby: () => {
                    document.getElementById('lobby-gold').innerText = App.state.data.gold.toLocaleString();
                    document.getElementById('lobby-level').innerText = App.state.data.level;
                    document.getElementById('user-display-name').innerText = App.state.data.playerName || "èªè­‰æ•™çˆ¶";
                    document.getElementById('user-title').innerText = CAREERS[Math.min(Math.floor(App.state.data.level / 2), 19)];
                    if (window.revenueChartInstance) App.ui.renderChart();
                },
                renderChart: () => {
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    const history = App.state.data.history.length > 0 ? App.state.data.history : [{a: 0, d:'Syncing'}];
                    if (window.revenueChartInstance) window.revenueChartInstance.destroy();
                    window.revenueChartInstance = new Chart(ctx, { type: 'line', data: { labels: history.map(h => h.d), datasets: [{ data: history.map(h => h.a), borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.05)', borderWidth: 5, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
                },
                renderTimetable: () => {
                    const container = document.getElementById('calendar-container'); if (!container) return;
                    const hours = [10, 12, 14, 16, 18, 20]; const curDay = App.state.data.gameDay;
                    let html = `<table class="calendar-table"><thead><tr><th class="w-16">æ™‚æ®µ</th>`;
                    for(let i=0; i<7; i++) html += `<th>D+${i}<br>${curDay+i}æ—¥</th>`;
                    html += `</tr></thead><tbody>`;
                    hours.forEach(h => {
                        html += `<tr><td class="text-center font-mono font-black text-slate-400 text-[9px]">${h}:00</td>`;
                        for(let i=0; i<7; i++) {
                            const sid = `${curDay+i}-${h}`; const appt = App.state.data.appointments[sid];
                            const isMarketing = App.state.data.marketingSlots?.[sid];
                            const isPast = (curDay+i < curDay) || (curDay+i === curDay && h < App.state.data.gameHour);
                            if (appt) {
                                const isFin = appt.status === 'finished'; const color = appt.gender === 'male' ? 'occupied-male' : 'occupied-female';
                                const overdue = isPast && !isFin ? 'overdue' : ''; const icon = appt.gender === 'male' ? '<i class="fa-solid fa-mars"></i>' : '<i class="fa-solid fa-venus"></i>';
                                html += `<td class="calendar-cell ${color} ${overdue}" onclick="window.apptAction('${sid}')"><div class="flex flex-col items-center justify-center h-full text-[9px] font-black"><span class="truncate w-full text-center px-1">${icon} ${appt.name}</span><span class="text-[7px] opacity-70 italic font-mono uppercase">${isFin ? 'Done' : (overdue ? 'Lost' : 'Appt')}</span></div></td>`;
                            } else if (isMarketing) {
                                html += `<td class="calendar-cell marketing-active" onclick="App.ui.notify('å»£å‘Šå¼•æµä¸­ï¼Œè«‹ç•™æ„é ç´„å®¢ã€‚')"><div class="marketing-pulse-wrapper"><div class="radar-circle animate-marketing-radar"></div><div class="radar-circle animate-marketing-radar" style="animation-delay: 0.5s"></div><i class="fa-solid fa-tower-broadcast text-pure-500 text-xs relative z-10"></i></div></td>`;
                            } else { 
                                html += `<td class="calendar-cell empty flex items-center justify-center" onclick="window.openMarketing('${sid}')"><span class="text-[8px] text-slate-300 font-black hover:text-pure-500 transition-colors"><i class="fa-solid fa-bullhorn opacity-30"></i></span></td>`; 
                            }
                        }
                        html += `</tr>`;
                    });
                    html += `</tbody></table>`; container.innerHTML = html;
                }
            },

            audio: {
                toggle: () => {
                    if(!App.state.audio.el) { App.state.audio.el = new Audio("https://assets.mixkit.co/music/preview/kit-serene-view-443.mp3"); App.state.audio.el.loop = true; }
                    if(App.state.audio.muted) { App.state.audio.el.play().then(() => { App.state.audio.muted = false; document.getElementById('lobby-music-icon').className = "fa-solid fa-volume-high text-pure-500"; document.getElementById('lobby-music-text').innerText="ON"; }).catch(()=>null); }
                    else { App.state.audio.el.pause(); App.state.audio.muted = true; document.getElementById('lobby-music-icon').className = "fa-solid fa-volume-xmark"; document.getElementById('lobby-music-text').innerText="OFF"; }
                }
            },

            router: {
                go: (viewId) => {
                    document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                    App.state.view = viewId;
                    if (viewId === 'appointments') App.ui.renderTimetable();
                    if (viewId === 'lobby') App.ui.updateLobby();
                    if (viewId === 'reports') { App.reports.renderMonthlyChart(); document.getElementById('report-date-picker').valueAsDate = new Date(); App.reports.lookup(); }
                    if (viewId === 'game') window.initCanvas();
                }
            }
        };

        window.app = { tutorial: App.tutorial, auth: App.auth, router: App.router, audio: App.audio, reports: App.reports, timer: { startNextDay: App.timer.startNextDay } };

        window.apptAction = (sid) => {
            const appt = App.state.data.appointments[sid];
            const [day, hour] = sid.split('-').map(Number);
            const isPast = (day < App.state.data.gameDay) || (day === App.state.data.gameDay && hour < App.state.data.gameHour);
            App.state.session = { ...appt, sid };
            if (isPast && appt.status !== 'finished') window.rescheduleDialogue(sid);
            else { App.router.go('dialogue'); window.renderDialogue(); }
        };

        window.openMarketing = (sid) => {
            App.state.targetSlot = sid;
            const modal = document.getElementById('modal-marketing');
            document.getElementById('marketing-list').innerHTML = MARKETING_METHODS.map((m, i) => `
                <button onclick="window.doMarketing(${i})" class="p-4 bg-white border-2 border-pure-100 rounded-2xl text-left hover:border-pure-500 transition-all shadow-sm group">
                    <div class="font-black text-slate-700 text-sm group-hover:text-pure-600">${m.name}</div>
                    <div class="text-pure-500 font-bold text-xs mt-1">ğŸ’° ${m.cost}</div>
                </button>
            `).join('');
            modal.classList.remove('hidden');
        };

        window.doMarketing = async (idx) => {
            const m = MARKETING_METHODS[idx];
            const sid = App.state.targetSlot;
            if (App.state.data.gold < m.cost) return App.ui.notify("è³‡ç”¢ä¸è¶³", true);
            App.state.data.gold -= m.cost;
            if (!App.state.data.marketingSlots) App.state.data.marketingSlots = {};
            App.state.data.marketingSlots[sid] = true;
            document.getElementById('modal-marketing').classList.add('hidden');
            await App.data.save(); App.ui.notify("è¡ŒéŠ·æŠ•æ”¾æˆåŠŸã€‚æœªä¾†æ•¸æ—¥å°‡å‡ºç¾é ç´„ã€‚");
        };

        window.renderDialogue = () => {
            const box = document.getElementById('customer-avatar-box');
            const appt = App.state.session;
            const color = appt.gender === 'male' ? '#bae6fd' : '#fecdd3';
            box.innerHTML = `<div class="css-avatar" style="width:120px;height:120px;border-radius:50%;border:4px solid ${color};position:relative;background:white;overflow:hidden;">
                <div style="position:absolute; top:20%; left:25%; width:50%; height:50%; background:#ffe4e6; border-radius:50%; z-index:10;"></div>
                <div style="position:absolute; bottom:0; left:15%; width:70%; height:45%; background:${color}; border-radius:45% 45% 0 0; z-index:5;"></div>
            </div>`;
            document.getElementById('diag-name').innerText = appt.name;
            if (appt.status === 'pending') {
                document.getElementById('diag-text').innerText = `ä½ å¥½ï¼Œæˆ‘æ˜¯é ç´„çš„è²´è³“ã€‚é ç´„éƒ¨ä½æ˜¯ã€${BODY_PARTS[appt.part] || 'å…¨èº«'}ã€ï¼Œè«‹å•æ‚¨èƒ½æ¥å—é ç´„å—ï¼Ÿ`;
                document.getElementById('diag-options').innerHTML = `<div class="flex gap-4 w-full"><button onclick="window.confirmAppt(true)" class="flex-1 p-5 bg-green-500 text-white rounded-3xl font-black shadow-lg">æ¥å—é ç´„</button><button onclick="window.confirmAppt(false)" class="flex-1 p-5 bg-slate-100 text-slate-400 rounded-3xl font-black">å©‰æ‹’</button></div>`;
            } else if (appt.status === 'accepted') {
                document.getElementById('diag-text').innerText = "æˆ‘å·²ç¶“æº–å‚™å¥½é€²è¡Œç™‚ç¨‹äº†ï¼Œéº»ç…©æ•™çˆ¶å•Ÿå‹•é›·å°„ã€‚";
                document.getElementById('diag-options').innerHTML = `<button onclick="app.router.go('game')" class="w-full p-6 bg-pure-600 text-white rounded-3xl font-black italic shadow-xl tracking-widest">å•Ÿå‹•å°ˆæ¥­é›·å°„å„€ â¯</button>`;
            } else if (appt.status === 'finished') {
                document.getElementById('diag-text').innerText = `é¡§å®¢è©•åƒ¹ï¼š${appt.feedback || 'å°ˆæ¥­ä¸”çµ²æ»‘ã€‚'}`;
                document.getElementById('diag-options').innerHTML = `<button onclick="app.router.go('appointments')" class="w-full p-6 bg-slate-100 text-slate-400 rounded-3xl font-black">æœå‹™å·²çµæ¡ˆ</button>`;
            }
        };

        window.confirmAppt = async (isAccept) => {
            const sid = App.state.session.sid;
            if (isAccept) App.state.data.appointments[sid].status = 'accepted';
            else { delete App.state.data.appointments[sid]; App.state.data.gold -= 200; App.ui.notify("æ‹’çµ•é ç´„é€ æˆæå¤± -200", true); }
            await App.data.save(); App.router.go('appointments');
        };

        window.rescheduleDialogue = (sid) => {
            const appt = App.state.data.appointments[sid];
            App.router.go('dialogue');
            document.getElementById('customer-avatar-box').innerHTML = `<div class="css-avatar" style="width:100px;height:100px;border-radius:50%;background:#e2e8f0;"></div>`;
            document.getElementById('diag-name').innerText = appt.name;
            document.getElementById('diag-text').innerText = "ä¸å¥½æ„æ€ï¼Œæ‚¨é€¾æ™‚æœªé–‹å±•ç™‚ç¨‹ã€‚æ˜¯å¦èƒ½å¹«æˆ‘é‡æ–°æ’ç¨‹åˆ°ä¹‹å¾Œçš„ç©ºä½ï¼Ÿ";
            document.getElementById('diag-options').innerHTML = `<button onclick="window.processReschedule('${sid}')" class="w-full p-5 bg-pure-600 text-white rounded-3xl font-black shadow-xl">é€²è¡Œæ’ç¨‹å”å•† â¯</button>`;
        };

        window.processReschedule = async (oldSid) => {
            const appt = App.state.data.appointments[oldSid];
            const hours = [10, 12, 14, 16, 18, 20]; const curDay = App.state.data.gameDay;
            let found = false;
            for(let i=0; i<7; i++) {
                for(let h of hours) {
                    const tsid = `${curDay+i}-${h}`;
                    const isFut = (curDay+i > curDay) || (curDay+i === curDay && h > App.state.data.gameHour);
                    if (isFut && !App.state.data.appointments[tsid]) {
                        App.state.data.appointments[tsid] = { ...appt, status: 'accepted' };
                        delete App.state.data.appointments[oldSid]; found = true; break;
                    }
                }
                if (found) break;
            }
            if (!found) return App.ui.notify("æœªä¾†ä¸€é€±å·²æ»¿ï¼Œå”å•†å¤±æ•—ã€‚", true);
            await App.data.save(); App.router.go('appointments'); App.ui.notify("è²´è³“é‡æ–°æ’ç¨‹æˆåŠŸã€‚");
        };

        let canvas, ctx;
        window.initCanvas = () => {
            canvas = document.getElementById('game-canvas'); ctx = canvas.getContext('2d');
            const container = canvas.parentElement; canvas.width = container.clientWidth; canvas.height = 450;
            const total = canvas.width * canvas.height; const laser = document.getElementById('laser-cursor');
            ctx.fillStyle = App.state.session.gender === 'male' ? '#f4d1c1' : '#fff0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = '#4a3528'; ctx.lineWidth = 1;
            for (let i = 0; i < 3000; i++) { const x = Math.random() * canvas.width; const y = Math.random() * canvas.height; ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + (Math.random()-0.5)*4, y + 8); ctx.stroke(); }
            let isD = false; canvas.onmousedown = () => isD = true; window.onmouseup = () => isD = false;
            window.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect(); const cx = e.clientX; const cy = e.clientY;
                laser.style.left = cx + 'px'; laser.style.top = cy + 'px'; laser.style.display = 'block';
                if (isD) {
                    ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(cx - rect.left, cy - rect.top, 30, 0, Math.PI*2); ctx.fill();
                    const data = ctx.getImageData(0,0, canvas.width, canvas.height).data;
                    let em = 0; for(let i=3; i<data.length; i+=4) if(data[i]===0) em++;
                    const prog = (em/total); document.getElementById('prog-bar').style.width = `${prog*100}%`; document.getElementById('prog-text').innerText = `${(prog*100).toFixed(1)}%`;
                    if (prog > 0.985) window.finishAesthetic();
                }
            };
        };

        window.finishAesthetic = async () => {
            const reward = 800; App.state.data.gold += reward; App.state.data.level++;
            App.state.data.history.push({ d: App.state.data.gameDay+"æ—¥"+App.state.data.gameHour+"æ™‚", a: reward });
            const sid = App.state.session.sid; App.state.data.appointments[sid].status = 'finished';
            App.state.data.appointments[sid].feedback = FEEDBACKS[Math.floor(Math.random()*80)];
            await App.data.save(); document.getElementById('reward-val').innerText = reward; document.getElementById('modal-result').classList.remove('hidden'); document.getElementById('laser-cursor').style.display = 'none';
        };

        App.auth.init();
    </script>
</body>
</html>
