<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç€…ç™½ä¹‹å¢ƒ Pure Skin V5.16 - è¡Œå‹•ç¾å­¸æ——è‰¦ç‰ˆ</title>
    <!-- å¼•å…¥å¤–éƒ¨è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pure: {
                            50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8',
                            500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        }
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'marketing-radar': 'marketingRadar 2s infinite cubic-bezier(0, 0, 0.2, 1)',
                        'breath-border': 'breathBorder 1.5s ease-in-out infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        breathBorder: {
                            '0%, 100%': { borderColor: 'rgba(14, 165, 233, 0.2)', transform: 'scale(1)', boxShadow: '0 0 0px rgba(14, 165, 233, 0)' },
                            '50%': { borderColor: 'rgba(14, 165, 233, 0.8)', transform: 'scale(1.02)', boxShadow: '0 0 15px rgba(14, 165, 233, 0.4)' }
                        },
                        marketingRadar: { '0%': { transform: 'scale(1)', opacity: '0.8' }, '100%': { transform: 'scale(2.5)', opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* æ‰‹æ©Ÿé©é…èˆ‡æ¥µè‡´ç¾åŒ–æ¨£å¼ */
        * { -webkit-tap-highlight-color: transparent; outline: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #bae6fd; border-radius: 10px; }

        body { overscroll-behavior: none; -webkit-user-select: none; user-select: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(31, 38, 135, 0.08);
        }
        
        .chart-container { position: relative; width: 100%; height: 200px; margin: 0 auto; }

        /* NPC Elsa è¦–è¦ºé‡ç¹ª */
        .elsa-container { position: relative; width: 140px; height: 300px; transform: scale(0.85); margin-bottom: -40px; }
        .elsa-hair {
            position: absolute; top: 5px; left: 15px; width: 110px; height: 130px;
            background: linear-gradient(135deg, #eecda3 0%, #c19b6e 100%);
            border-radius: 55px 55px 25px 25px; z-index: 1;
        }
        .elsa-head {
            position: absolute; top: 15px; left: 30px; width: 80px; height: 95px;
            background: #ffe4e6; border-radius: 40px 40px 45px 45px; z-index: 10;
        }
        .elsa-glasses {
            position: absolute; top: 40px; left: 0px; width: 80px; height: 30px; z-index: 15;
            display: flex; gap: 3px; justify-content: center;
        }
        .glass-frame { width: 32px; height: 32px; border: 2px solid #1e293b; border-radius: 50%; background: rgba(255,255,255,0.1); }
        .elsa-eye-dot { position: absolute; top: 52px; width: 8px; height: 8px; background: #0f172a; border-radius: 50%; z-index: 16; }
        .elsa-labcoat {
            position: absolute; top: 105px; left: 15px; width: 110px; height: 180px;
            background: #ffffff; border-radius: 15px; z-index: 5; border: 1px solid #e2e8f0;
        }
        .elsa-stethoscope {
            position: absolute; top: 110px; left: 25px; width: 90px; height: 70px;
            border: 3px solid #3b82f6; border-top: none; border-radius: 0 0 45px 45px; z-index: 12;
        }

        /* é ç´„æ™‚åˆ»è¡¨ï¼šæ‰‹æ©Ÿå–®é æ©«æ»‘ä½ˆå±€ */
        .calendar-wrapper { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
        .calendar-table { min-width: 580px; border-collapse: separate; border-spacing: 4px; table-layout: fixed; }
        .calendar-table th { padding: 8px 4px; background: #f8fafc; border-radius: 10px; font-size: 0.55rem; font-weight: 900; color: #64748b; text-align: center; text-transform: uppercase; }
        .calendar-cell { 
            height: 48px; background: rgba(241, 245, 249, 0.6); border-radius: 12px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: 2px solid transparent; position: relative;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .calendar-cell.occupied-male { background: #eff6ff; border-color: #3b82f6; }
        .calendar-cell.occupied-female { background: #fff1f2; border-color: #f43f5e; }
        .calendar-cell.empty { border: 1.5px dashed #e2e8f0; }
        .calendar-cell.marketing-active { background: #f0f9ff; border: 2px solid #0ea5e9; }
        .calendar-cell.overdue { background: #fee2e2; border-color: #ef4444; opacity: 0.9; }

        .pending-breath { animation: breathBorder 2s ease-in-out infinite; z-index: 5; }

        .tutor-bubble { position: absolute; z-index: 10000; transition: all 0.5s; display: none; pointer-events: none; }
        .bubble-content { background: white; border: 3px solid #bae6fd; border-radius: 2.5rem; padding: 1.5rem; width: 270px; pointer-events: auto; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .bubble-content::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-left: 3px solid #bae6fd; border-bottom: 3px solid #bae6fd; transform: rotate(-45deg); bottom: -14px; left: 50%; margin-left: -12px; }

        #laser-cursor { 
            position: fixed; width: 64px; height: 64px; border: 4px solid #cbd5e1; border-radius: 50%; 
            transform: translate(-50%, -50%); pointer-events: none; z-index: 9999; display: none; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); transition: border-color 0.3s, box-shadow 0.3s;
        }
        #laser-cursor.active-power { 
            border-color: #0ea5e9; box-shadow: 0 0 40px rgba(14, 165, 233, 0.7); background: rgba(14, 165, 233, 0.1);
        }

        .power-switch { width: 72px; height: 38px; background: #cbd5e1; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .power-switch.on { background: #0ea5e9; }
        .power-switch .knob { width: 30px; height: 30px; background: white; border-radius: 50%; position: absolute; top: 4px; left: 4px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .power-switch.on .knob { transform: translateX(34px); }

        .css-avatar { position: relative; width: 110px; height: 110px; border-radius: 50%; background: white; overflow: hidden; border: 4px solid #e0f2fe; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="bg-pure-50 text-slate-700 min-h-screen font-sans selection:bg-pure-200 overflow-x-hidden">

    <div id="laser-cursor"></div>

    <!-- å°å¸« Elsa æ•™å­¸çµ„ä»¶ -->
    <div id="tutor-anchor" class="fixed z-[10000] bottom-10 right-10 flex flex-col items-center gap-2 transition-all duration-500" style="display: none;">
        <div class="elsa-container animate-float">
            <div class="elsa-hair"></div>
            <div class="elsa-head">
                <div class="elsa-glasses"><div class="glass-frame"></div><div class="glass-frame"></div></div>
                <div class="elsa-eye-dot" style="left:16px;"></div><div class="elsa-eye-dot" style="right:16px;"></div>
                <div class="elsa-mouth"></div>
            </div>
            <div class="elsa-labcoat"></div>
            <div class="elsa-stethoscope"></div>
        </div>
        <div class="bubble-content shadow-2xl glass-panel p-6 rounded-[3rem] border-pure-200">
            <p id="tutor-text" class="text-slate-700 font-black leading-relaxed text-sm"></p>
            <button onclick="app.tutorial.next()" class="mt-4 w-full py-4 bg-pure-600 text-white rounded-[2rem] text-sm font-black shadow-lg active:scale-95 transition-transform">äº†è§£ï¼ä¸‹ä¸€æ­¥ â¯</button>
        </div>
    </div>

    <!-- å…¨åŸŸé€šçŸ¥ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[20000] transition-all duration-500 transform -translate-y-24 opacity-0 flex items-center gap-3 px-8 py-4 rounded-[2.5rem] shadow-2xl bg-white/95 backdrop-blur-md border border-pure-100">
        <i id="toast-icon" class="fa-solid fa-circle-check text-green-500"></i>
        <span id="toast-text" class="font-black text-slate-700 text-sm">ç³»çµ±å·²å°±ç·’</span>
    </div>

    <!-- æ‰‹æ©Ÿæ‡¸æµ®æ™‚é˜åˆ— -->
    <div id="fixed-clock" class="fixed bottom-6 left-6 z-[150] glass-panel px-5 py-3 rounded-[2rem] flex items-center gap-5 shadow-2xl border-pure-100 animate-fade-in pointer-events-none">
        <div class="flex flex-col items-start leading-none">
            <span id="game-date" class="font-black text-slate-400 text-[10px] uppercase tracking-tighter mb-1">ç¬¬ 1 å¤©ç‡Ÿé‹</span>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-clock text-pure-500 text-xs"></i>
                <span id="game-clock" class="font-black text-slate-800 text-xl font-mono italic">10:00 AM</span>
            </div>
        </div>
    </div>

    <main id="app-root" class="w-full min-h-screen flex flex-col items-center relative overflow-hidden px-4 py-8">
        
        <!-- èƒŒæ™¯é£¾å“ -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div class="absolute top-[-5%] left-[-10%] w-[100vw] h-[100vw] bg-pure-200/25 rounded-full filter blur-[140px] animate-pulse-slow"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[90vw] h-[90vw] bg-pink-100/25 rounded-full filter blur-[140px] animate-pulse-slow"></div>
        </div>

        <!-- 0. è¼‰å…¥è¦–åœ– -->
        <section id="view-loading" class="flex flex-col items-center justify-center gap-8 text-center h-screen transition-all duration-500">
            <div class="relative">
                <div class="w-28 h-28 border-4 border-pure-100 border-t-pure-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">ğŸ§Š</div>
            </div>
            <div>
                <h1 class="text-5xl font-black tracking-tighter text-slate-800 mb-3 italic">ç€…ç™½ä¹‹å¢ƒ</h1>
                <p id="loading-status" class="text-sm font-bold text-pure-500 tracking-[0.6em] animate-pulse uppercase">ç™»å…¥ä¸­...</p>
            </div>
        </section>

        <!-- 1. èªè­‰ä¸­å¿ƒ -->
        <section id="view-login" class="hidden w-full max-w-md my-auto animate-float">
            <div class="glass-panel p-10 rounded-[4rem] text-center shadow-2xl border-white border-4">
                <div class="w-24 h-24 bg-white rounded-[2.5rem] mx-auto flex items-center justify-center mb-8 text-5xl text-pure-600 shadow-inner border border-pure-50">ğŸ§Š</div>
                <h2 class="text-4xl font-black mb-2 text-slate-800 tracking-tight italic">ç¾å­¸æ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-400 text-xs font-bold tracking-[0.2em] uppercase mb-12">Pure Aesthetics Portal</p>
                <div class="space-y-5">
                    <button onclick="app.auth.loginGoogle()" class="w-full py-6 bg-white border border-slate-100 rounded-[2.5rem] flex items-center justify-center gap-4 shadow-sm hover:bg-pure-50 transition-all font-black text-slate-600 text-lg">
                        <i class="fa-brands fa-google text-2xl text-pure-600"></i> Google å¿«é€Ÿèªè­‰
                    </button>
                    <button onclick="app.auth.loginGameCenter()" class="w-full py-6 bg-slate-900 text-white rounded-[2.5rem] flex items-center justify-center gap-4 shadow-xl active:scale-95 transition-transform font-black text-lg">
                        <i class="fa-brands fa-apple text-3xl"></i> Game Center ç™»å…¥
                    </button>
                </div>
                <p class="mt-14 text-xs text-slate-400 font-bold tracking-widest italic animate-pulse">è«‹ç™»å…¥ä¸¦é–‹å§‹éŠæˆ²</p>
            </div>
        </section>

        <!-- 1.2 å‘½åè¦–åœ– -->
        <section id="view-naming" class="hidden w-full max-w-md my-auto px-4">
            <div class="glass-panel p-12 rounded-[4.5rem] text-center shadow-2xl animate-slide-up border-white border-2">
                <h2 class="text-3xl font-black text-slate-800 mb-10 italic tracking-tighter">è¨­å®šå°ˆå®¶åç¨±</h2>
                <input id="input-player-name" type="text" maxlength="8" class="w-full p-6 rounded-[2.5rem] bg-pure-50 border-4 border-pure-100 focus:border-pure-400 outline-none text-center font-black text-3xl mb-12 shadow-inner">
                <button onclick="app.auth.confirmName()" class="w-full py-7 bg-pure-600 text-white font-black rounded-[3rem] shadow-xl hover:scale-105 active:scale-95 transition-all text-2xl italic uppercase tracking-tighter">é–‹å•Ÿå°ˆæ¥­è·æ¶¯ â¯</button>
            </div>
        </section>

        <!-- 1.5 æ­¡è¿èˆ‡å°è¦½å•Ÿå‹• -->
        <section id="view-welcome" class="hidden w-full max-w-2xl my-auto text-center px-6">
            <div class="glass-panel p-12 rounded-[5rem] shadow-2xl border-white border-4 animate-fade-in relative overflow-hidden">
                <div class="absolute -top-10 -left-10 w-40 h-40 bg-pure-50 rounded-full opacity-40"></div>
                <div class="text-9xl mb-12 drop-shadow-2xl">ğŸ§Š</div>
                <h2 class="text-5xl font-black text-slate-800 mb-8 italic tracking-tighter text-center">æ­¡è¿é–‹å•Ÿæ•™çˆ¶ä¹‹è·¯</h2>
                <p class="text-slate-500 font-bold leading-relaxed text-xl mb-14 italic text-center px-4">
                    æ‚¨çš„å°ˆæ¥­æ’ç¨‹èˆ‡æ™ºæ…§æ™‚åˆ»è¡¨å·²åŒæ­¥ã€‚<br>æº–å‚™å¥½æ¥å— Elsa å°å¸«çš„å¼•å°äº†å—ï¼Ÿ
                </p>
                <button onclick="app.tutorial.start()" class="px-16 py-8 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-2xl rounded-[3.5rem] shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase tracking-widest mx-auto block">
                    é–‹å§‹å¼•å°æ•™å­¸ â¯
                </button>
            </div>
        </section>

        <!-- 2. å¤§å»³ (DASHBOARD) -->
        <section id="view-lobby" class="hidden w-full max-w-6xl flex flex-col gap-6 w-full">
            <header id="frame-profile" class="glass-panel p-6 rounded-[3.5rem] flex flex-col gap-6 shadow-2xl border-blue-50">
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 bg-gradient-to-tr from-pure-500 to-cyan-400 rounded-3xl flex items-center justify-center text-white shadow-xl text-3xl"><i class="fa-solid fa-gem"></i></div>
                    <div class="flex-1">
                        <h3 class="text-3xl font-black text-slate-800 italic" id="user-display-name">é¡§å•</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="bg-pure-500 text-white text-[8px] px-3 py-1 rounded-full font-black uppercase tracking-widest">å¤§å¸«ç´š Master</span>
                            <p class="text-[10px] font-black text-pure-500 uppercase tracking-widest" id="user-title">-</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 items-center pt-6 border-t border-slate-100">
                    <div class="flex-1 bg-pure-50/50 p-4 rounded-3xl text-center">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-1 tracking-widest">è³‡ç”¢</p>
                        <p class="text-3xl font-black text-slate-800 font-mono italic">ğŸ’° <span id="lobby-gold">0</span></p>
                    </div>
                    <div class="flex-1 bg-pure-50/50 p-4 rounded-3xl text-center">
                        <p class="text-[9px] text-slate-400 font-black uppercase mb-1 tracking-widest">ç¶“ç‡Ÿç­‰ç´š</p>
                        <p class="text-3xl font-black text-pure-600 font-mono italic" id="lobby-level">1</p>
                    </div>
                </div>
            </header>

            <div id="frame-chart" class="glass-panel p-8 rounded-[4rem] flex flex-col gap-6 shadow-inner border border-pure-50">
                <div class="flex justify-between items-center px-2">
                    <h4 class="text-xl font-black text-slate-800 tracking-tighter italic font-mono"><i class="fa-solid fa-chart-line mr-3 text-pure-500"></i>ç¶“ç‡Ÿè¶¨å‹¢åˆ†æ</h4>
                    <button onclick="app.router.go('reports')" class="px-5 py-2 bg-pure-100 text-pure-600 rounded-full font-black text-[10px] hover:bg-pure-200 transition-all uppercase tracking-widest font-mono">è²¡å‹™å ±è¡¨</button>
                </div>
                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
            </div>

            <button id="frame-appt" onclick="app.router.go('appointments')" class="group relative bg-gradient-to-br from-pure-600 to-blue-800 text-white p-10 rounded-[4.5rem] shadow-2xl active:scale-95 transition-all text-left overflow-hidden h-44">
                <div class="absolute right-[-10px] bottom-[-20px] text-[11rem] text-white opacity-10"><i class="fa-solid fa-calendar-check"></i></div>
                <h2 class="text-4xl font-black italic mb-2 tracking-tighter uppercase text-center">é ç´„æ™‚åˆ»è¡¨</h2>
                <p class="text-sm font-medium opacity-85 leading-relaxed italic pr-12 text-center">ä¸€é€±è·¨æ—¥æ’ç¨‹çŸ©é™£èˆ‡å¼•æµæŠ•æ”¾é–‹ç™¼ã€‚</p>
            </button>

            <div id="frame-settings" class="glass-panel p-6 rounded-[3rem] flex flex-col gap-5 shadow-sm border border-pure-50 mt-4">
                <button onclick="app.audio.toggle()" class="flex items-center justify-between w-full p-5 rounded-[2rem] bg-pure-50 hover:bg-pure-100 transition-colors">
                    <span class="font-black text-slate-600 italic text-sm px-2"><i class="fa-solid fa-music mr-4 text-pure-500"></i>éŸ³æ¨‚æ°›åœæ„Ÿ</span>
                    <span id="lobby-music-text" class="text-[10px] font-black text-pure-400 font-mono bg-white px-4 py-1.5 rounded-full shadow-sm">OFF</span>
                </button>
                <button onclick="app.auth.logout()" class="flex items-center justify-center gap-3 text-slate-400 font-bold hover:text-red-500 transition-colors py-2 text-xs">
                    <i class="fa-solid fa-power-off"></i> å®‰å…¨ç™»å‡ºç³»çµ± EXIT
                </button>
            </div>
        </section>

        <!-- 3. é ç´„æ™‚åˆ»è¡¨ (è¡Œå‹•å„ªåŒ–é€±è¦–åœ–) -->
        <section id="view-appointments" class="hidden w-full max-w-6xl flex flex-col h-[82vh] animate-slide-up">
            <div class="glass-panel p-8 rounded-t-[4.5rem] flex justify-between items-center z-10 border-b-0 shadow-none">
                <div><h2 class="text-3xl font-black text-slate-800 italic tracking-tighter font-mono uppercase">é ç´„æ™‚åˆ»è¡¨</h2><p class="text-[10px] text-pure-400 font-bold mt-1 uppercase italic tracking-widest font-mono">Weekly Schedule Matrix</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-[1.5rem] bg-pure-50 flex items-center justify-center text-pure-600 hover:bg-pure-100 shadow-inner active:scale-90 transition-all"><i class="fa-solid fa-home text-xl"></i></button>
            </div>
            <div class="glass-panel p-4 rounded-b-[4.5rem] flex-1 shadow-2xl border-t-0 bg-white/95">
                <div class="calendar-wrapper custom-scrollbar h-full">
                    <div id="calendar-container"></div>
                </div>
            </div>
        </section>

        <!-- 4. ç¶“ç‡Ÿå ±è¡¨ä¸­å¿ƒ -->
        <section id="view-reports" class="hidden w-full max-w-5xl flex flex-col h-[82vh] animate-slide-up">
            <div class="glass-panel p-8 rounded-t-[4.5rem] flex justify-between items-center border-b-0">
                <div><h2 class="text-3xl font-black text-slate-800 italic tracking-tighter">ç¾å­¸è²¡å ±åˆ†æ</h2><p class="text-[10px] text-pure-400 font-bold mt-1 uppercase italic font-mono">Business Intelligence</p></div>
                <button onclick="app.router.go('lobby')" class="w-14 h-14 rounded-[1.5rem] bg-pure-50 flex items-center justify-center shadow-inner hover:bg-pure-100 transition-all active:scale-90"><i class="fa-solid fa-arrow-left text-pure-600 text-xl"></i></button>
            </div>
            <div class="glass-panel p-8 rounded-b-[4.5rem] flex-1 overflow-y-auto space-y-8 shadow-2xl custom-scrollbar">
                <div class="flex flex-col gap-8 p-8 bg-pure-50/80 rounded-[3rem] border border-pure-100 shadow-inner">
                    <div class="flex flex-col text-center"><span class="text-[10px] font-black text-slate-400 uppercase mb-3 italic tracking-[0.2em]">æŸ¥è©¢æ—¥æœŸæ™‚æ®µ</span><input type="date" id="report-date-picker" onchange="app.reports.lookup()" class="bg-white border-2 border-pure-100 p-4 rounded-[1.5rem] font-black outline-none focus:border-pure-400 text-center shadow-sm text-sm"></div>
                    <div class="grid grid-cols-2 gap-6 text-center">
                        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">ç•¶æ—¥ç¸½æ”¶å…¥</p><p class="text-3xl font-black text-pure-600 font-mono italic">ğŸ’° <span id="report-income">0</span></p></div>
                        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">æœå‹™è²´è³“æ•¸</p><p class="text-3xl font-black text-slate-600 font-mono italic">ğŸ‘¤ <span id="report-guests">0</span></p></div>
                    </div>
                </div>
                <div class="p-8 border-2 border-pure-50 rounded-[4rem] bg-white/50 shadow-inner text-center">
                    <h5 class="text-lg font-black text-slate-700 mb-8 italic underline decoration-pure-200 text-center">æœˆåº¦ç¶“ç‡Ÿæ•¸æ“šè¶¨å‹¢</h5>
                    <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- 5. äº’å‹•æ“ä½œç•«é¢ -->
        <section id="view-game" class="hidden w-full max-w-4xl flex-col items-center gap-10 my-auto">
            <div class="w-full max-w-md glass-panel p-8 rounded-[3.5rem] flex items-center justify-between shadow-2xl border-white border-4">
                <div class="flex items-center gap-6">
                    <div id="laser-power-switch" onclick="window.toggleLaser()" class="power-switch">
                        <div class="knob"></div>
                    </div>
                    <div class="leading-none">
                        <p class="font-black text-slate-800 text-lg italic uppercase tracking-widest">é›·å°„é›»æº</p>
                        <p id="power-status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">å¾…æ©Ÿæ¨¡å¼ STANDBY</p>
                    </div>
                </div>
                <div class="text-right leading-none">
                    <span id="prog-text" class="text-3xl font-black text-pure-600 font-mono italic">0.0%</span>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">æ·¨ç™½é€²åº¦</p>
                </div>
            </div>

            <div class="relative rounded-[5.5rem] overflow-hidden shadow-2xl border-[16px] border-white ring-4 ring-blue-50/50">
                <canvas id="game-canvas" class="bg-pure-50"></canvas>
            </div>

            <div class="w-full max-w-md flex flex-col gap-6">
                <div class="w-full h-4 bg-slate-100 rounded-full overflow-hidden shadow-inner border-2 border-white">
                    <div id="prog-bar" class="h-full bg-gradient-to-r from-pure-400 to-cyan-500 w-0 transition-all duration-300"></div>
                </div>
                <button onclick="window.requestManualFinish()" class="w-full py-8 bg-gradient-to-br from-pure-600 to-blue-800 text-white font-black text-2xl rounded-[3rem] shadow-2xl active:scale-95 transition-all italic uppercase tracking-widest">
                    å®Œæˆç™‚ç¨‹çµç®— FINISH â¯
                </button>
            </div>
        </section>

        <!-- çµç®—è©•åƒ¹å½ˆçª— -->
        <div id="modal-result" class="hidden fixed inset-0 z-[200] items-center justify-center bg-blue-900/80 backdrop-blur-3xl px-6 animate-slide-in">
            <div class="glass-panel p-16 rounded-[6rem] text-center max-md w-full border-white border-[10px] shadow-2xl relative overflow-hidden">
                <div id="result-rank-icon" class="text-9xl mb-10 drop-shadow-2xl text-center">ğŸ§Š</div>
                <h2 class="text-5xl font-black text-slate-800 mb-4 tracking-tighter italic text-center" id="result-rank-title">æ¥µè‡´ç€…ç™½ï¼</h2>
                <div id="result-stars" class="flex justify-center gap-2 mb-10 text-yellow-400 text-3xl"></div>
                <p id="result-feedback-text" class="text-slate-500 font-bold mb-14 leading-relaxed text-xl italic px-6 text-center"></p>
                
                <div class="bg-blue-50 p-8 rounded-[4rem] border border-blue-100 flex justify-between items-center mb-14 shadow-inner">
                    <span class="font-black text-slate-500 uppercase tracking-widest text-sm italic">çµç®—çé‡‘ Reward</span>
                    <span class="font-black text-blue-600 text-5xl tracking-tighter font-mono">ğŸ’° <span id="reward-val">0</span></span>
                </div>
                <button onclick="window.location.reload()" class="w-full py-8 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-2xl rounded-[3.5rem] shadow-2xl active:scale-95 transition-transform uppercase tracking-widest italic">æ¥ä¸‹ä¸€ä½è²´è³“ â¯</button>
            </div>
        </div>

        <!-- çµæŸç‡Ÿæ¥­çµç®— Modal -->
        <div id="modal-closing" class="hidden fixed inset-0 z-[15000] bg-slate-950/80 backdrop-blur-xl flex items-center justify-center p-6 text-center">
            <div class="glass-panel max-w-md w-full p-12 rounded-[4rem] shadow-2xl border-white border-4 animate-slide-up">
                <div class="text-7xl mb-8 text-center">ğŸŒ™</div>
                <h2 class="text-4xl font-black text-slate-800 mb-2 italic tracking-tighter text-center">ç‡Ÿæ¥­çµæŸ</h2>
                <p class="text-slate-400 font-bold mb-10 text-sm tracking-widest uppercase italic text-center" id="closing-day-label">Day 1 ç¶“ç‡Ÿçµç®—</p>
                <div class="grid grid-cols-2 gap-4 mb-10">
                    <div class="bg-pure-50 p-6 rounded-3xl shadow-inner border border-pure-100">
                        <span class="text-[9px] font-black text-slate-400 uppercase block mb-1">ä»Šæ—¥ç¸½æ”¶å…¥</span>
                        <span class="text-2xl font-black text-pure-600 font-mono italic">ğŸ’° <span id="closing-income">0</span></span>
                    </div>
                    <div class="bg-pure-50 p-6 rounded-3xl shadow-inner border border-pure-100">
                        <span class="text-[9px] font-black text-slate-400 uppercase block mb-1">æœå‹™è²´è³“æ•¸</span>
                        <span class="text-2xl font-black text-pure-600 font-mono italic">ğŸ‘¤ <span id="closing-guests">0</span></span>
                    </div>
                </div>
                <button onclick="app.timer.startNextDay()" class="w-full py-5 bg-gradient-to-r from-pure-600 to-blue-700 text-white font-black text-xl rounded-2xl shadow-xl active:scale-95 transition-all uppercase italic">é–‹å§‹æ¬¡æ—¥ç¶“ç‡Ÿ START â¯</button>
            </div>
        </div>

        <!-- è¡ŒéŠ·æŠ•æ”¾ Modal -->
        <div id="modal-marketing" class="hidden fixed inset-0 z-[11000] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
            <div class="glass-panel max-w-xl w-full p-10 rounded-[4rem] shadow-2xl animate-slide-up">
                <div class="flex justify-between items-center mb-8 uppercase font-black text-slate-800 italic text-center">
                    <h3 class="text-center w-full">å¸‚å ´é–‹ç™¼æŠ•æ”¾</h3>
                    <button onclick="document.getElementById('modal-marketing').classList.add('hidden')" class="text-slate-400 p-2"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-4" id="marketing-list"></div>
            </div>
        </div>

    </main>

    <!-- Firebase SDK æ ¡æº–å°å…¥ (ä¿®æ­£ GoogleAuthProvider éŒ¯èª¤) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, OAuthProvider, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // V5.16 é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCIKSbaZ5R6RTSRcH_-YYfqz_OnQQFr1gc", authDomain: "pure-skin-8640d.firebaseapp.com",
            projectId: "pure-skin-8640d", storageBucket: "pure-skin-8640d.firebasestorage.app",
            messagingSenderId: "890613609117", appId: "1:890613609117:web:ed044e453e6cc789b01a74", measurementId: "G-27E3XSTTBH"
        };
        const appId = 'pure-skin-studio-master';
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // æ ¸å¿ƒæ•¸æ“šæ± 
        const CAREERS = ["ç€…ç™½å¯¦ç¿’ç”Ÿ", "åˆç´šæŠ€å¸«", "è³‡æ·±é™¤æ¯›å¸«", "é¦–å¸­æŠ€è¡“å®˜", "é†«ç¾é¡§å•", "é›·å°„ç‰©ç†å°ˆå®¶", "çš®è†šè‡¨åºŠé†«ç”Ÿ", "æŠ—è€ç ”ç©¶å“¡", "ç”Ÿç‰©çº–ç¶­å°ˆå®¶", "é†«å­¸ç¾å®¹é™¢é•·", "å©šç¦®é€ å‹å¸«", "æ™‚å°šé›œèªŒé¡§å•", "å¥½èŠå¡¢ç‰¹æ•ˆè­·ç†", "æ˜æ˜Ÿå¾¡ç”¨å¤§å¸«", "äººé«”ç¾å­¸å®¶", "æ²™é¾åº—é•·", "å“ç‰Œç¶“ç†", "é€£é–åº—å‰µå§‹äºº", "ç¾å®¹é›†åœ˜ CEO", "å…¨çƒç¾å­¸æ•™çˆ¶"];
        const TW_NAMES = Array.from({length: 300}, (_, i) => ["é™³", "æ", "ç‹", "å¼µ", "åŠ‰", "é»ƒ", "æ—", "å³"][i % 8] + ["ç¾ç²", "å­è±ª", "é›…é›¯", "æ‰¿ç¿°", "é›¨æŸ”", "ä¿Šå»·", "è©©å©·", "å¨å»‰"][Math.floor(Math.random()*8)]);
        const MARKETING_METHODS = [ { name: "ç¤¾ç¾¤æ¨æ’­", cost: 300, power: 0.15 }, { name: "å€åŸŸç°¡è¨Š", cost: 200, power: 0.1 }, { name: "ç¶²ç´…é–‹ç®±", cost: 1200, power: 0.4 }, { name: "æ·é‹ç‡ˆç®±", cost: 2000, power: 0.6 }, { name: "é›œèªŒå°ˆè¨ª", cost: 3500, power: 0.8 }, { name: "é›»è¦–å»£å‘Š", cost: 6000, power: 1.2 } ];
        const BODY_PARTS = { face: 'è‡‰éƒ¨ç²¾é›•', underarm: 'è…‹ä¸‹æ·¨ç™½', bikini: 'VIOç§å¯†', limbs: 'å››è‚¢çµ²æ»‘', back: 'èƒŒéƒ¨ç¾å­¸' };
        const FEEDBACKS = Array.from({length: 80}, (_, i) => `å°ˆæ¥­è©•åˆ† #${i+1}ï¼šé€™æ˜¯ç›®å‰è¦‹éæœ€å°ˆæ¥­çš„ç€…ç™½æŠ€è¡“ï¼Œè‚Œè†šå®Œå…¨é›¶ç‘•ç–µï¼`);

        const bgm = new Audio("https://assets.mixkit.co/music/preview/mixkit-serene-view-443.mp3");
        bgm.loop = true; bgm.volume = 0.3;

        const App = {
            state: {
                user: null, data: { gold: 3000, level: 1, exp: 0, history: [], dailyLog: {}, isNewPlayer: true, appointments: {}, marketingSlots: {}, playerName: "", gameHour: 10, gameMinute: 0, gameDay: 1 },
                view: 'loading', session: null, isAuthResolved: false, tutorialStep: 0, audio: { el: bgm, muted: true },
                isLaserOn: false, startTime: 0, currentCompletion: 0
            },

            audio: {
                toggle: function() {
                    const audio = App.state.audio;
                    if (audio.muted) {
                        audio.el.play().catch(() => App.ui.notify("è«‹é»æ“Šè¢å¹•å–šé†’éŸ³è¨Šç³»çµ±", true));
                        audio.muted = false; document.getElementById('lobby-music-text').innerText="é–‹å•Ÿ ON";
                    } else {
                        audio.el.pause();
                        audio.muted = true; document.getElementById('lobby-music-text').innerText="é—œé–‰ OFF";
                    }
                }
            },

            reports: {
                lookup: () => {
                    const date = document.getElementById('report-date-picker').value;
                    const log = App.state.data.dailyLog?.[date] || { income: 0, guests: 0 };
                    document.getElementById('report-income').innerText = log.income.toLocaleString();
                    document.getElementById('report-guests').innerText = log.guests;
                },
                renderMonthlyChart: () => {
                    const ctx = document.getElementById('monthlyChart').getContext('2d');
                    const logs = App.state.data.dailyLog || {};
                    const sortedDates = Object.keys(logs).sort().slice(-15);
                    if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();
                    window.monthlyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sortedDates.map(d => d.slice(5)), datasets: [{ label: 'æ¯æ—¥ç‡Ÿæ”¶', data: sortedDates.map(d => logs[d].income), backgroundColor: '#38bdf8', borderRadius: 10 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
                }
            },

            timer: {
                lastTick: performance.now(),
                start: () => requestAnimationFrame(App.timer.loop),
                loop: (now) => {
                    const elapsed = now - App.timer.lastTick;
                    if (elapsed > 1000) { App.timer.lastTick = now; App.timer.tick(); }
                    requestAnimationFrame(App.timer.loop);
                },
                tick: async () => {
                    let d = App.state.data;
                    const isVisible = !document.hidden;
                    // V5.16 æ™‚ç©ºæµé€Ÿï¼šé–‹å•Ÿ 1:5, èƒŒæ™¯ 720:1
                    const gameSecondsToAdd = isVisible ? 5 : (5 * 60) / 3600;
                    d.gameMinute += gameSecondsToAdd / 60;
                    if (d.gameMinute >= 60) {
                        d.gameMinute = 0; d.gameHour++;
                        if (d.gameHour >= 21) { App.timer.performDailySettlement(); return; }
                    }
                    App.ui.updateClock();
                    App.timer.processMarketing(isVisible);
                    if (App.state.view === 'appointments') App.ui.renderTimetable();
                },
                performDailySettlement: async () => {
                    const day = App.state.data.gameDay;
                    let dailyIncome = 0; let dailyGuests = 0;
                    Object.keys(App.state.data.appointments).forEach(sid => {
                        if (sid.startsWith(`${day}-`)) {
                            const appt = App.state.data.appointments[sid];
                            if (appt.status === 'finished') { dailyIncome += (appt.actualReward || 800); dailyGuests++; }
                        }
                    });
                    const dateStr = new Date().toISOString().split('T')[0]; 
                    App.state.data.dailyLog[dateStr] = { income: dailyIncome, guests: dailyGuests };
                    document.getElementById('closing-day-label').innerText = `ç¬¬ ${day} å¤© ç¶“ç‡Ÿçµç®—å ±å‘Š`;
                    document.getElementById('closing-income').innerText = dailyIncome.toLocaleString();
                    document.getElementById('closing-guests').innerText = dailyGuests;
                    document.getElementById('modal-closing').classList.remove('hidden');
                    await App.data.save();
                },
                startNextDay: async () => {
                    App.state.data.gameHour = 10; App.state.data.gameMinute = 0; App.state.data.gameDay++;
                    document.getElementById('modal-closing').classList.add('hidden');
                    await App.data.save(); App.router.go('lobby');
                },
                processMarketing: async (isVisible) => {
                    let d = App.state.data;
                    Object.keys(d.marketingSlots || {}).forEach(async (sid) => {
                        if (Math.random() < (isVisible ? 0.03 : 0.0005)) {
                            if (!d.appointments[sid]) {
                                d.appointments[sid] = { name: TW_NAMES[Math.floor(Math.random()*300)], part: 'face', gender: Math.random() > 0.5 ? 'male' : 'female', status: 'pending' };
                                delete d.marketingSlots[sid]; App.ui.notify("å¼•æµæˆåŠŸï¼æœ‰æ–°è²´è³“é ç´„æ™‚æ®µã€‚"); await App.data.save();
                            }
                        }
                    });
                }
            },

            auth: {
                init: async () => {
                    const watchdog = setTimeout(() => { if (!App.state.isAuthResolved && App.state.view === 'loading') App.router.go('login'); }, 4000);
                    onAuthStateChanged(auth, async (user) => {
                        App.state.isAuthResolved = true; clearTimeout(watchdog);
                        if (user && !user.isAnonymous) {
                            App.state.user = user; await App.data.sync(); 
                            if (!App.state.data.playerName) App.router.go('naming');
                            else if (App.state.data.isNewPlayer && !localStorage.getItem(`tut_done_${user.uid}`)) App.router.go('welcome');
                            else App.router.go('lobby');
                            App.timer.start();
                        } else {
                            if(user && user.isAnonymous) await signOut(auth);
                            App.router.go('login');
                        }
                    });
                },
                loginGoogle: () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => App.ui.notify("èªè­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²åŸŸæˆæ¬Šã€‚", true)),
                loginGameCenter: () => App.ui.notify("æ­¤ç’°å¢ƒä¸æ”¯æ´ Game Centerã€‚", true),
                confirmName: () => { 
                    const n = document.getElementById('input-player-name').value.trim(); 
                    if(!n) return App.ui.notify("è«‹è¨­å®šå°ˆå®¶åç¨±", true);
                    document.getElementById('modal-name-confirm').classList.remove('hidden'); 
                    document.getElementById('display-confirm-name').innerText = n; 
                },
                submitName: async () => { 
                    const n = document.getElementById('input-player-name').value.trim(); 
                    App.state.data.playerName = n; App.state.data.isNewPlayer = true;
                    document.getElementById('modal-name-confirm').classList.add('hidden'); 
                    await App.data.save(); App.router.go('welcome'); 
                },
                logout: async () => { localStorage.clear(); await signOut(auth); window.location.reload(); }
            },

            tutorial: {
                steps: [
                    { text: "æ‚¨å¥½ï¼Œç¾å­¸æ•™çˆ¶ï¼æˆ‘æ˜¯ Elsaã€‚å·¦ä¸‹è§’é¢æ¿è¨˜éŒ„ç‡Ÿé‹æ™‚ç©ºï¼Œè‹¥è·³é›¢è¦–çª—æ™‚é–“æœƒè‡ªå‹•æ¸›é€Ÿä¿è­·æ•¸æ“šã€‚", target: "fixed-clock" },
                    { text: "é ç´„è¡¨å·²å„ªåŒ–ç‚ºå–®é çŸ©é™£ï¼Œå·¦å³æ»‘å‹•å¯ç®¡ç†æœªä¾† 7 å¤©æ’ç¨‹ã€‚å‘¼å¸æ¡†ç·šæ¨™ç¤ºè‘—å¾…ç¢ºèªçš„é ç´„ã€‚", target: "frame-appt" },
                    { text: "ç•¶é ç´„æ™‚é–“æ¥è¿‘ç›®å‰çš„éŠæˆ²æ™‚é–“ï¼Œæ ¼ä½æœƒæ¼¸æ¼¸è®Šç´…æé†’æ‚¨å„˜é€Ÿè™•ç†ï¼é–‹å§‹ç¶“ç‡Ÿå§ã€‚", target: "frame-chart" }
                ],
                start: () => { App.router.go('lobby'); App.state.tutorialStep = 0; document.getElementById('tutor-anchor').style.display = 'flex'; App.tutorial.render(); },
                next: async () => { App.state.tutorialStep++; if (App.state.tutorialStep < App.tutorial.steps.length) App.tutorial.render(); else { document.getElementById('tutor-anchor').style.display = 'none'; App.state.data.isNewPlayer = false; if (App.state.user) localStorage.setItem(`tut_done_${App.state.user.uid}`, 'true'); await App.data.save(); App.ui.notify("ç¥æ‚¨ç¶“ç‡Ÿé †åˆ©ï¼"); } },
                render: () => {
                    const s = App.tutorial.steps[App.state.tutorialStep]; document.getElementById('tutor-text').innerText = s.text;
                    const a = document.getElementById('tutor-anchor'); const t = document.getElementById(s.target);
                    if (t) { const r = t.getBoundingClientRect(); a.style.bottom = (window.innerHeight - r.top + 10) + 'px'; a.style.left = (r.left + r.width/2 - 135) + 'px'; t.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                }
            },

            data: {
                sync: async () => {
                    if (!App.state.user) return;
                    const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile');
                    const snap = await getDoc(userRef);
                    if (snap.exists()) App.state.data = { ...App.state.data, ...snap.data() };
                    else { App.state.data.gold = 3000; App.state.data.level = 1; await setDoc(userRef, App.state.data); }
                    onSnapshot(userRef, (s) => { if(s.exists()) { App.state.data = { ...App.state.data, ...s.data() }; App.ui.updateLobby(); } });
                },
                save: async () => { if (App.state.user) { const userRef = doc(db, 'artifacts', appId, 'users', App.state.user.uid, 'saveData', 'profile'); await setDoc(userRef, App.state.data, { merge: true }); } }
            },

            ui: {
                notify: (m, e) => { const el = document.getElementById('toast'); document.getElementById('toast-text').innerText = m; document.getElementById('toast-icon').className = e ? "fa-solid fa-circle-exclamation text-red-500" : "fa-solid fa-circle-check text-green-500"; el.classList.remove('-translate-y-24', 'opacity-0'); setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000); },
                updateClock: () => { const d = App.state.data; const h = Math.floor(d.gameHour); const m = Math.floor(d.gameMinute); document.getElementById('game-clock').innerText = `${h}:${m < 10 ? '0'+m : m} ${h >= 12 ? 'PM' : 'AM'}`; document.getElementById('game-date').innerText = `ç¬¬ ${d.gameDay} å¤©ç‡Ÿé‹`; },
                updateLobby: () => {
                    document.getElementById('lobby-gold').innerText = App.state.data.gold.toLocaleString();
                    document.getElementById('lobby-level').innerText = App.state.data.level;
                    document.getElementById('user-display-name').innerText = App.state.data.playerName || "æ•™çˆ¶å°ˆå®¶";
                    document.getElementById('user-title').innerText = CAREERS[Math.min(Math.floor(App.state.data.level / 2), 19)];
                    if (window.revenueChartInstance) App.ui.renderChart();
                },
                renderChart: () => {
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    const history = App.state.data.history.length > 0 ? App.state.data.history : [{a: 0, d:'Syncing'}];
                    if (window.revenueChartInstance) window.revenueChartInstance.destroy();
                    window.revenueChartInstance = new Chart(ctx, { type: 'line', data: { labels: history.map(h => h.d), datasets: [{ data: history.map(h => h.a), borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.05)', borderWidth: 5, tension: 0.4, fill: true, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
                },
                renderTimetable: () => {
                    const container = document.getElementById('calendar-container'); if (!container) return;
                    const hours = [10, 12, 14, 16, 18, 20]; const curDay = App.state.data.gameDay;
                    const totalGameTime = App.state.data.gameHour + (App.state.data.gameMinute / 60);
                    
                    let html = `<table class="calendar-table"><thead><tr><th class="w-16">æ™‚æ®µ</th>`;
                    for(let i=0; i<7; i++) html += `<th>${curDay+i}æ—¥</th>`;
                    html += `</tr></thead><tbody>`;
                    hours.forEach(h => {
                        html += `<tr><td class="text-center font-mono font-black text-slate-400 text-[10px]">${h}:00</td>`;
                        for(let i=0; i<7; i++) {
                            const sid = `${curDay+i}-${h}`; const appt = App.state.data.appointments[sid];
                            const isMarketing = App.state.data.marketingSlots?.[sid];
                            const isPast = (curDay+i < curDay) || (curDay+i === curDay && h < App.state.data.gameHour);
                            const isToday = (curDay+i === curDay);
                            
                            let cellStyle = "";
                            let breathClass = "";
                            
                            if (appt) {
                                const isFin = appt.status === 'finished';
                                const colorClass = appt.gender === 'male' ? 'occupied-male' : 'occupied-female';
                                const overdue = isPast && !isFin ? 'overdue' : '';
                                
                                // V5.16 æ¼¸æ¼¸è®Šç´…é‚è¼¯
                                if (isToday && !isFin && !overdue) {
                                    const diff = h - totalGameTime;
                                    if (diff > 0 && diff <= 1) {
                                        const intensity = (1 - diff).toFixed(2);
                                        cellStyle = `background-color: rgba(239, 68, 68, ${intensity}); border-color: rgba(239, 68, 68, ${0.4 + intensity*0.6}); color: ${intensity > 0.6 ? 'white' : 'inherit'}`;
                                    }
                                }
                                
                                // å‘¼å¸æ¡†ç·šæ¨™ç¤ºå°šæœªæ¥å—çš„é ç´„
                                if (appt.status === 'pending') breathClass = "pending-breath";
                                
                                const icon = appt.gender === 'male' ? '<i class="fa-solid fa-mars"></i>' : '<i class="fa-solid fa-venus"></i>';
                                html += `<td class="calendar-cell ${colorClass} ${overdue} ${breathClass}" style="${cellStyle}" onclick="window.apptAction('${sid}')"><div class="flex flex-col items-center justify-center h-full text-[9px] font-black"><span class="truncate w-full text-center px-0.5">${icon} ${appt.name}</span><span class="text-[7px] opacity-70 italic uppercase">${isFin ? 'å®Œæˆ' : (overdue ? 'é€¾æ™‚' : 'é ç´„')}</span></div></td>`;
                            } else if (isMarketing) {
                                html += `<td class="calendar-cell marketing-active"><div class="marketing-pulse-wrapper"><div class="radar-circle animate-marketing-radar"></div><i class="fa-solid fa-tower-broadcast text-pure-500 text-xs relative z-10"></i></div></td>`;
                            } else { 
                                html += `<td class="calendar-cell empty flex items-center justify-center" onclick="window.openMarketing('${sid}')"><span class="text-[11px] text-slate-300 font-black hover:text-pure-500"><i class="fa-solid fa-plus opacity-30"></i></span></td>`; 
                            }
                        }
                        html += `</tr>`;
                    });
                    html += `</tbody></table>`; container.innerHTML = html;
                }
            },

            router: {
                go: (viewId) => {
                    document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${viewId}`).classList.remove('hidden');
                    App.state.view = viewId;
                    if (viewId === 'appointments') App.ui.renderTimetable();
                    if (viewId === 'lobby') App.ui.updateLobby();
                    if (viewId === 'reports') { App.reports.renderMonthlyChart(); document.getElementById('report-date-picker').valueAsDate = new Date(); App.reports.lookup(); }
                    if (viewId === 'game') window.initCanvas();
                    document.getElementById('fixed-clock').style.display = (viewId === 'game' || viewId === 'welcome' || viewId === 'naming' || viewId === 'dialogue') ? 'none' : 'flex';
                }
            }
        };

        window.app = App;

        // --- å…¨åŸŸäº’å‹• ---
        window.toggleLaser = () => {
            App.state.isLaserOn = !App.state.isLaserOn;
            const sw = document.getElementById('laser-power-switch'); const cur = document.getElementById('laser-cursor'); const st = document.getElementById('power-status-text');
            if (App.state.isLaserOn) { sw.classList.add('on'); cur.classList.add('active-power'); st.innerText = "ç³»çµ±å·²å•Ÿå‹• ACTIVE"; st.className = "text-[8px] font-black text-pure-500 uppercase tracking-widest animate-pulse"; } 
            else { sw.classList.remove('on'); cur.classList.remove('active-power'); st.innerText = "å¾…æ©Ÿæ¨¡å¼ STANDBY"; st.className = "text-[8px] font-bold text-slate-400 uppercase tracking-widest"; }
        };

        window.apptAction = (sid) => {
            const appt = App.state.data.appointments[sid];
            const [day, hour] = sid.split('-').map(Number);
            const isPast = (day < App.state.data.gameDay) || (day === App.state.data.gameDay && hour < App.state.data.gameHour);
            App.state.session = { ...appt, sid };
            if (isPast && appt.status !== 'finished') window.rescheduleDialogue(sid);
            else { App.router.go('dialogue'); window.renderDialogue(); }
        };

        window.openMarketing = (sid) => {
            App.state.targetSlot = sid;
            const modal = document.getElementById('modal-marketing');
            document.getElementById('marketing-list').innerHTML = MARKETING_METHODS.map((m, i) => `
                <button onclick="window.doMarketing(${i})" class="p-6 bg-white border-2 border-pure-100 rounded-[2rem] text-left shadow-sm active:scale-95 transition-all">
                    <div class="font-black text-slate-700 text-sm italic">${m.name}</div>
                    <div class="text-pure-500 font-bold text-xs mt-2 italic font-mono">ğŸ’° ${m.cost}</div>
                </button>
            `).join('');
            document.getElementById('modal-marketing').classList.remove('hidden');
        };

        window.doMarketing = async (idx) => {
            const m = MARKETING_METHODS[idx]; const sid = App.state.targetSlot;
            if (App.state.data.gold < m.cost) return App.ui.notify("è³‡ç”¢ä¸è¶³å•Ÿå‹•æ­¤æ–¹æ¡ˆ", true);
            App.state.data.gold -= m.cost;
            if (!App.state.data.marketingSlots) App.state.data.marketingSlots = {};
            App.state.data.marketingSlots[sid] = true;
            document.getElementById('modal-marketing').classList.add('hidden');
            await App.data.save(); App.ui.notify(`æŠ•æ”¾æˆåŠŸï¼å»£å‘Šè„ˆè¡å·²å•Ÿå‹•ã€‚`); App.ui.renderTimetable();
        };

        window.renderDialogue = () => {
            const box = document.getElementById('customer-avatar-box');
            const appt = App.state.session;
            const color = appt.gender === 'male' ? '#bae6fd' : '#fecdd3';
            box.innerHTML = `<div class="css-avatar" style="border-color:${color}"><div style="position:absolute; top:20%; left:25%; width:50%; height:50%; background:#ffe4e6; border-radius:50%; z-index:10;"></div><div style="position:absolute; bottom:0; left:15%; width:70%; height:45%; background:${color}; border-radius:45% 45% 0 0; z-index:5;"></div></div>`;
            document.getElementById('diag-name').innerText = appt.name;
            if (appt.status === 'pending') {
                document.getElementById('diag-text').innerText = `æ‚¨å¥½ï¼Œæˆ‘æ˜¯é ç´„çš„è²´è³“ã€‚é ç´„éƒ¨ä½æ˜¯ã€${BODY_PARTS[appt.part] || 'å…¨èº«'}ã€ï¼Œè«‹å•æ‚¨èƒ½æ¥å—é ç´„å—ï¼Ÿ`;
                document.getElementById('diag-options').innerHTML = `<div class="flex gap-4 w-full"><button onclick="window.confirmAppt(true)" class="flex-1 py-5 bg-green-500 text-white rounded-[2rem] font-black shadow-lg active:scale-95 transition-all">æ¥å—é ç´„</button><button onclick="window.confirmAppt(false)" class="flex-1 py-5 bg-slate-100 text-slate-400 rounded-[2rem] font-black active:scale-95 transition-all">å©‰æ‹’</button></div>`;
            } else if (appt.status === 'accepted') {
                document.getElementById('diag-text').innerText = "æˆ‘å·²ç¶“æº–å‚™å¥½é€²è¡Œç™‚ç¨‹äº†ï¼Œéº»ç…©æ•™çˆ¶å•Ÿå‹•ç²¾å¯†é›·å°„ã€‚";
                document.getElementById('diag-options').innerHTML = `<button onclick="app.router.go('game')" class="w-full py-6 bg-pure-600 text-white rounded-[2.5rem] font-black italic shadow-xl tracking-widest uppercase active:scale-95 transition-all">å•Ÿå‹•å°ˆæ¥­é›·å°„å„€ â¯</button>`;
            } else if (appt.status === 'finished') {
                document.getElementById('diag-text').innerText = `é¡§å®¢è©•åƒ¹ï¼š${appt.feedback || 'å°ˆæ¥­ä¸”çµ²æ»‘ã€‚'}`;
                document.getElementById('diag-options').innerHTML = `<button onclick="app.router.go('appointments')" class="w-full py-6 bg-slate-100 text-slate-400 rounded-[2.5rem] font-black">æœå‹™å·²çµæ¡ˆ</button>`;
            }
        };

        window.confirmAppt = async (isAccept) => {
            const sid = App.state.session.sid;
            if (isAccept) App.state.data.appointments[sid].status = 'accepted';
            else { delete App.state.data.appointments[sid]; App.state.data.gold -= 200; App.ui.notify("å©‰æ‹’å°è‡´åè²æå¤± -200", true); }
            await App.data.save(); App.router.go('appointments');
        };

        window.rescheduleDialogue = (sid) => {
            App.router.go('dialogue');
            document.getElementById('customer-avatar-box').innerHTML = `<div class="css-avatar"><div style="position:absolute; top:20%; left:25%; width:50%; height:50%; background:#ffe4e6; border-radius:50%;"></div></div>`;
            document.getElementById('diag-name').innerText = "é€¾æ™‚è²´è³“";
            document.getElementById('diag-text').innerText = "å› ç‚ºæ‚¨é€¾æ™‚æœªé–‹å±•ç™‚ç¨‹ã€‚Elsa å°å¸«å»ºè­°æˆ‘å€‘å°‡æ‚¨çš„é ç´„å¾€å¾ŒæŒªç§»ã€‚";
            document.getElementById('diag-options').innerHTML = `<button onclick="window.processReschedule('${sid}')" class="w-full p-6 bg-pure-600 text-white rounded-[2.5rem] font-black shadow-xl active:scale-95 transition-all uppercase tracking-widest">é€²è¡Œæ’ç¨‹å”å•† â¯</button>`;
        };

        window.processReschedule = async (oldSid) => {
            const appt = App.state.data.appointments[oldSid];
            const hours = [10, 12, 14, 16, 18, 20]; const curDay = App.state.data.gameDay;
            let found = false;
            for(let i=0; i<7; i++) {
                for(let h of hours) {
                    const tsid = `${curDay+i}-${h}`;
                    const isFut = (curDay+i > curDay) || (curDay+i === curDay && h > App.state.data.gameHour);
                    if (isFut && !App.state.data.appointments[tsid]) { App.state.data.appointments[tsid] = { ...appt, status: 'accepted' }; delete App.state.data.appointments[oldSid]; found = true; break; }
                }
                if (found) break;
            }
            if (!found) return App.ui.notify("æœªä¾†ä¸€é€±å·²æ»¿", true);
            await App.data.save(); App.router.go('appointments'); App.ui.notify("é‡æ–°æ’ç¨‹å®Œæˆã€‚");
        };

        let canvas, ctx;
        window.initCanvas = () => {
            canvas = document.getElementById('game-canvas'); ctx = canvas.getContext('2d');
            const container = canvas.parentElement; canvas.width = container.clientWidth; canvas.height = 360;
            const total = canvas.width * canvas.height; const laser = document.getElementById('laser-cursor');
            App.state.isLaserOn = false; App.state.startTime = Date.now(); App.state.currentCompletion = 0;
            document.getElementById('laser-power-switch').classList.remove('on'); laser.classList.remove('active-power');
            document.getElementById('prog-bar').style.width = '0%'; document.getElementById('prog-text').innerText = '0.0%';
            ctx.fillStyle = App.state.session.gender === 'male' ? '#f4d1c1' : '#fff0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.strokeStyle = '#4a3528'; ctx.lineWidth = 1;
            for (let i = 0; i < 2400; i++) { const x = Math.random() * canvas.width; const y = Math.random() * canvas.height; ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + (Math.random()-0.5)*4, y + 8); ctx.stroke(); }
            let isD = false;
            const handleStart = (e) => { isD = true; handleMove(e); };
            const handleEnd = () => isD = false;
            const handleMove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const cx = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
                const cy = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
                laser.style.left = cx + 'px'; laser.style.top = cy + 'px'; laser.style.display = 'block';
                if (isD && App.state.isLaserOn) {
                    ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(cx - rect.left, cy - rect.top, 28, 0, Math.PI*2); ctx.fill();
                    window.triggerLaserFX(cx, cy);
                    const data = ctx.getImageData(0,0, canvas.width, canvas.height).data;
                    let em = 0; for(let i=3; i<data.length; i+=4) if(data[i]===0) em++;
                    const prog = (em/total); App.state.currentCompletion = prog * 100;
                    document.getElementById('prog-bar').style.width = `${prog*100}%`; document.getElementById('prog-text').innerText = `${(prog*100).toFixed(1)}%`;
                }
            };
            canvas.onmousedown = handleStart; canvas.ontouchstart = (e) => { e.preventDefault(); handleStart(e); };
            window.onmouseup = handleEnd; window.ontouchend = handleEnd;
            window.onmousemove = handleMove; window.ontouchmove = (e) => { e.preventDefault(); handleMove(e); };
        };

        window.triggerLaserFX = (x, y) => {
            for(let i=0; i<4; i++) {
                const el = document.createElement('div'); const size = Math.random() * 5 + 3;
                el.style.cssText = `position:fixed; left:${x}px; top:${y}px; width:${size}px; height:${size}px; background:#fff; border-radius:50%; pointer-events:none; z-index:9998; box-shadow: 0 0 10px #0ea5e9;`;
                document.body.appendChild(el);
                el.animate([{ opacity: 1, transform: 'translate(0, 0) scale(1)' }, { opacity: 0, transform: `translate(${(Math.random()-0.5)*70}px, ${(Math.random()-0.5)*70}px) scale(0)` }], { duration: 600, easing: 'ease-out' }).onfinish = () => el.remove();
            }
        };

        window.requestManualFinish = () => {
            const timeElapsed = (Date.now() - App.state.startTime) / 1000; const completion = App.state.currentCompletion;
            let rank = "S", stars = 5, rewardMult = 1.0, feedback = "å®Œç¾çš„ç€…ç™½æŠ€è¡“ï¼ç°¡ç›´å°±æ˜¯è—è¡“ã€‚";
            if (completion < 60 || timeElapsed < 10) { rank = "C"; stars = 1; rewardMult = 0.1; feedback = completion < 60 ? "é€™é™¤æ¯›ä¹Ÿå¤ªè‰ç‡äº†å§ï¼Ÿæˆ‘é‚„æœ‰ä¸€åŠæ²’ä¹¾æ·¨ï¼" : "æ“ä½œå¤ªå¿«äº†ï¼Œæˆ‘æ‡·ç–‘é€™æ ¹æœ¬æ²’æ•ˆæœ..."; } 
            else if (completion < 85) { rank = "B"; stars = 3; rewardMult = 0.7; feedback = "é‚„å¯ä»¥ï¼Œä½†æœ‰äº›å°ç´°ç¯€æ²’æ³¨æ„åˆ°ã€‚"; } 
            else if (completion < 95) { rank = "A"; stars = 4; rewardMult = 0.9; feedback = "éå¸¸å°ˆæ¥­çš„æœå‹™ï¼Œæ„Ÿè¦ºè‚Œè†šæ¸…çˆ½å¤šäº†ã€‚"; }
            window.finalizeAesthetic(rank, stars, rewardMult, feedback);
        };

        window.finalizeAesthetic = async (rank, stars, rewardMult, feedback) => {
            const actualReward = Math.floor(800 * rewardMult); App.state.data.gold += actualReward; if (rank !== "C") App.state.data.level++;
            App.state.data.history.push({ d: App.state.data.gameDay+"æ—¥"+App.state.data.gameHour+"æ™‚", a: actualReward });
            const sid = App.state.session.sid; App.state.data.appointments[sid].status = 'finished'; App.state.data.appointments[sid].feedback = feedback; App.state.data.appointments[sid].actualReward = actualReward;
            await App.data.save();
            document.getElementById('reward-val').innerText = actualReward.toLocaleString();
            document.getElementById('result-rank-title').innerText = rank === "C" ? "è©•åƒ¹ä½è¿·" : "ç™‚ç¨‹åœ“æ»¿ï¼";
            document.getElementById('result-stars').innerHTML = "â˜…".repeat(stars) + "â˜†".repeat(5-stars);
            document.getElementById('result-feedback-text').innerText = feedback;
            document.getElementById('modal-result').classList.add('flex'); document.getElementById('modal-result').classList.remove('hidden');
            document.getElementById('laser-cursor').style.display = 'none';
        };

        App.auth.init();
    </script>
</body>
</html>
